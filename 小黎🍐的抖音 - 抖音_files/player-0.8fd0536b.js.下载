/*! For license information please see player-0.8fd0536b.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).xss={})}(this,function(e){"use strict";var t=function(){return(t=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function i(e,t,i){if(i||2==arguments.length)for(var r,n=0,a=t.length;n<a;n++)!r&&n in t||(r||(r=Array.prototype.slice.call(t,0,n)),r[n]=t[n]);return e.concat(r||Array.prototype.slice.call(t))}var r=/[^a-zA-Z0-9\\_:.-]/gim,n=/</g,a=/>/g,o=/&#([a-zA-Z0-9]*);?/gim,s=/&quot;/g,l=/&colon;?/gim,u=/&newline;?/gim,d=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a):/gi,c=/u\s*r\s*l\s*\(.*/gi,f=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,h=/"/g,p=function(e){return e.replace(n,"&lt;").replace(a,"&gt;")},g={indexOf:function(e,t){var i,r;for(i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return -1},forEach:function(e,t,i){var r,n;for(r=0,n=e.length;r<n;r++)t.call(i,e[r],r,e)},some:function(e,t,i){var r,n;for(r=0,n=e.length;r<n;r++)if(t.call(i,e[r],r,e))return!0;return!1},trim:function(e){return e.replace(/(^\s*)|(\s*$)/g,"")},includes:function(e,t){if("string"==typeof e)return -1!==e.indexOf(t);for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1},spaceIndex:function(e){var t=/\s|\n|\t/.exec(e);return t?t.index:-1},uniq:function(e){for(var t={},i=[],r=0;r<e.length;r++)t[e[r]]||(i.push(e[r]),t[e[r]]=!0);return i},from:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t},keys:function(e){var t=[];for(var i in e)t.push(i);return t}};function v(e){return null==e}function m(e){var t;return'"'===(t=e)[0]&&'"'===t[t.length-1]||"'"===t[0]&&"'"===t[t.length-1]?e.substr(1,e.length-2):e}function _(e){var t,i,r,n,a,o,s,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u="",d=0;for(e=function(e){e=e.replace(/rn/g,"n");for(var t="",i=0;i<e.length;i++){var r=e.charCodeAt(i);r<128?t+=String.fromCharCode(r):r>127&&r<2048?t+=String.fromCharCode(r>>6|192)+String.fromCharCode(63&r|128):t+=String.fromCharCode(r>>12|224)+String.fromCharCode(r>>6&63|128)+String.fromCharCode(63&r|128)}return t}(e);d<e.length;)n=(t=e.charCodeAt(d++))>>2,a=(3&t)<<4|(i=e.charCodeAt(d++))>>4,o=(15&i)<<2|(r=e.charCodeAt(d++))>>6,s=63&r,isNaN(i)?o=s=64:isNaN(r)&&(s=64),u=u+l.charAt(n)+l.charAt(a)+l.charAt(o)+l.charAt(s);return u}function y(e){var t,i,r,n,a,o,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l="",u=0;for(e=e.replace(/[^A-Za-z0-9+/=]/g,"");u<e.length;)t=s.indexOf(e.charAt(u++))<<2|(n=s.indexOf(e.charAt(u++)))>>4,i=(15&n)<<4|(a=s.indexOf(e.charAt(u++)))>>2,r=(3&a)<<6|(o=s.indexOf(e.charAt(u++))),l+=String.fromCharCode(t),64!==a&&(l+=String.fromCharCode(i)),64!==o&&(l+=String.fromCharCode(r));return function(e){for(var t="",i=0,r=0,n=0,a=0;i<e.length;)(r=e.charCodeAt(i))<128?(t+=String.fromCharCode(r),i++):r>191&&r<224?(t+=String.fromCharCode((31&r)<<6|63&(a=e.charCodeAt(i+1))),i+=2):(a=e.charCodeAt(i+1),t+=String.fromCharCode((15&r)<<12|(63&a)<<6|63&(n=e.charCodeAt(i+2))),i+=3);return t}(l)}function T(e,t,i){var r="",n=0,a=!1,o=!1,s=0,l=e.length,u="",d="";e:for(s=0;s<l;s++){var c=e.charAt(s);if(!1===a){if("<"===c){a=s;continue}}else if(!1===o){if("<"===c){r+=i(e.slice(n,s)),a=s,n=s;continue}if(">"===c||s===l-1){r+=i(e.slice(n,a)),u=function(e){var t,i=g.spaceIndex(e);return t=-1===i?e.slice(1,-1):e.slice(1,i+1),"/"===(t=g.trim(t).toLowerCase()).slice(0,1)&&(t=t.slice(1)),"/"===t.slice(-1)&&(t=t.slice(0,-1)),t}(d=e.slice(a,s+1)),r+=t(a,r.length,u,d,"</"===d.slice(0,2)),n=s+1,a=!1;continue}if('"'===c||"'"===c)for(var f=1,h=e.charAt(s-f);""===h.trim()||"="===h;){if("="===h){o=c;continue e}h=e.charAt(s-++f)}}else if(c===o){o=!1;continue}}return n<l&&(r+=i(e.substr(n))),r}function S(e,t){var i=0,n=0,a=[],o=!1,s=e.length;function l(e,i){if(!((e=(e=g.trim(e)).replace(r,"").toLowerCase()).length<1)){var n=t(e,i||"");n&&a.push(n)}}for(var u=0;u<s;u++){var d=e.charAt(u),c=void 0;if(!1!==o||"="!==d){if(!1===o||u!==n){if(/\s|\n|\t/.test(d)){if(e=e.replace(/\s|\n|\t/g," "),!1===o){if(-1===(c=function(e,t){for(;t<e.length;t++){var i=e[t];if(" "!==i)return"="===i?t:-1}return -1}(e,u))){l(g.trim(e.slice(i,u))),o=!1,i=u+1;continue}u=c-1;continue}if(-1===(c=function(e,t){for(;t>0;t--){var i=e[t];if(" "!==i)return"="===i?t:-1}return -1}(e,u-1))){l(o,m(g.trim(e.slice(i,u)))),o=!1,i=u+1;continue}}}else{if(-1===(c=e.indexOf(d,u+1)))break;l(o,g.trim(e.slice(n+1,c))),o=!1,i=(u=c)+1}}else o=e.slice(i,u),i=u+1,n='"'===e.charAt(i)||"'"===e.charAt(i)?i:function(e,t){for(;t<e.length;t++){var i=e[t];if(" "!==i)return"'"===i||'"'===i?t:-1}return -1}(e,u+1)}return i<e.length&&(!1===o?l(e.slice(i)):l(o,m(g.trim(e.slice(i))))),g.trim(a.join(" "))}function k(e,t,i){if(i=function(e){return e=function(e){for(var t="",i=0,r=e.length;i<r;i++)t+=32>e.charCodeAt(i)?" ":e.charAt(i);return g.trim(t)}(e=(e=(e=e.replace(s,'"')).replace(o,function(e,t){return"x"===t[0]||"X"===t[0]?String.fromCharCode(parseInt(t.substr(1),16)):String.fromCharCode(parseInt(t,10))})).replace(l,":").replace(u," "))}(i),"href"===t||"src"===t){if("#"===(i=g.trim(i)))return"#";if("http://"!==i.substr(0,7)&&"https://"!==i.substr(0,8)&&"mailto:"!==i.substr(0,7)&&"tel:"!==i.substr(0,4)&&"data:image/"!==i.substr(0,11)&&"ftp://"!==i.substr(0,6)&&"./"!==i.substr(0,2)&&"../"!==i.substr(0,3)&&"#"!==i[0]&&"/"!==i[0])return""}else if("background"===t){if(d.lastIndex=0,d.test(i))return""}else if("style"===t&&(f.lastIndex=0,f.test(i)||(c.lastIndex=0,c.test(i)&&(d.lastIndex=0,d.test(i)))))return"";return i=function(e){return e=p(e=e.replace(h,"&quot;"))}(i)}var E=function(e){return"string"==typeof e?e.replace(/'/g,'"').replace('=""',"").replace(/\s+/g,"").toLowerCase():""},b=function(){function e(e){var t=function(e){var t={};for(var i in e)t[i]=e[i];return t}(e||{});t.stripIgnoreTag&&(t.onIgnoreTag,t.onIgnoreTag=function(){return""}),t.whiteList={},t.onTag=function(){},t.onTagAttr=function(){},t.onIgnoreTag=function(){},t.onIgnoreTagAttr=function(){},t.safeAttrValue=k,t.escapeHtml=p,this.options=Object.assign(t,e)}return e.prototype.process=function(e){if(!(e=(e=e||"").toString()))return"";var t,i,r,n,a,o,s=this.options,l=s.whiteList,u=s.onTag,d=s.onIgnoreTag,c=s.onTagAttr,f=s.onIgnoreTagAttr,h=s.safeAttrValue,p=s.escapeHtml;s.stripBlankChar&&(e=(t=(t=e.split("")).filter(function(e){var t=e.charCodeAt(0);return!(127===t||t<=31&&10!==t&&13!==t)})).join("")),s.allowCommentTag||(e=function(e){for(var t="",i=0;i<e.length;){var r=e.indexOf("\x3c!--",i);if(-1===r){t+=e.slice(i);break}t+=e.slice(i,r);var n=e.indexOf("--\x3e",r);if(-1===n)break;i=n+3}return t}(e));var v=!1;s.stripIgnoreTagBody&&(i=s.stripIgnoreTagBody,"function"!=typeof(r=d)&&(r=function(){}),n=!Array.isArray(i),a=[],o=!1,d=(v={onIgnoreTag:function(e,t,s){var l;if(l=e,n||-1!==g.indexOf(i,l)){if(s.isClosing){var u="[/removed]",d=s.position+u.length;return a.push([!1!==o?o:s.position,d]),o=!1,u}return o||(o=s.position),"[removed]"}return r(e,t,s)},remove:function(e){var t="",i=0;return g.forEach(a,function(r){t+=e.slice(i,r[0]),i=r[1]}),t+=e.slice(i)}}).onIgnoreTag);var m=T(e,function(e,t,i,r,n){var a={sourcePosition:e,position:t,isClosing:n,isWhite:Object.prototype.hasOwnProperty.call(l,i)},o=u(i,r,a);if(null!=o)return o;if(a.isWhite){if(a.isClosing)return"</".concat(i,">");var s=function(e){var t=g.spaceIndex(e);if(-1===t)return{html:"",closing:"/"===e[e.length-2]};var i="/"===(e=g.trim(e.slice(t+1,-1)))[e.length-1];return i&&(e=g.trim(e.slice(0,-1))),{html:e,closing:i}}(r),v=l[i],m=S(s.html,function(e,t){var r=-1!==g.indexOf(v,e),n=c(i,e,t,r);return null==n?r?(t=h(i,e,t,null))?"".concat(e,'="').concat(t,'"'):e:null==(n=f(i,e,t,r))?void 0:n:n});return r="<".concat(i),m&&(r+=" ".concat(m)),s.closing&&(r+=" /"),r+=">"}return null==(o=d(i,r,a))?p(r):o},p);return v&&(m=v.remove(m)),m},e}(),L=Function("\nvar _checkXSS = function (it) {\n  return it && it.Math == Math && it;\n};\nreturn _checkXSS(typeof globalThis === 'object' && globalThis) ||\n_checkXSS(typeof window === 'object' && window) ||\n_checkXSS(typeof self === 'object' && self) ||\n_checkXSS(typeof global === 'object' && global) ||\nFunction('return this')();\n")(),R=new(function(){function e(){var e=this;this.batchData=[],this.uniqKeys=new Set,this.timeout=2e3,this.lock=!1,this.getSlardarBid=function(){var t,i,r="douyin_web";if(!g.includes(r,"bid"))return r;if(e.config&&e.config.bid)return e.config.bid;if(L&&L._xssBid)return L._xssBid;if(L&&L.slardar&&"function"==typeof L.slardar.config){var n=(L.slardar.config()||{}).bid;if(n)return n}if(L&&L.Slardar&&"function"==typeof L.Slardar.config){var a=(L.Slardar.config()||{}).bid;if(a)return a}return(null===(i=null===(t=null==L?void 0:L.Slardar)||void 0===t?void 0:t._baseParams)||void 0===i?void 0:i.bid)||"argus"},this.getConfigRegion=function(){var t;return g.includes("cn","region")?e.config&&e.config.region?e.config.region:((null===(t=null==L?void 0:L.gfdatav1)||void 0===t?void 0:t.region)||"cn").toLowerCase():"cn"},this.gerReportUrl=function(){var t={cn:y("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boe:y("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),ttp:y("aHR0cHM6Ly9tb24udXMudGlrdG9rdi5jb20vbW9uaXRvcl9icm93c2VyL2NvbGxlY3QvYmF0Y2gvc2VjdXJpdHkvP2JpZD0="),va:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),maliva:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),sg:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boei18n:y("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9")}[e.getConfigRegion()];if(t)return t+e.getSlardarBid()}}return e.prototype.setConfig=function(e){this.config=e},e.prototype.upload=function(){var e=this,t=this.gerReportUrl();!this.lock&&t&&0!==this.batchData.length&&(this.lock=!0,setTimeout(function(){var i=e.batchData.slice(0,100);e.batchData=e.batchData.slice(100),L.fetch(t,{method:"post",body:JSON.stringify(i),headers:{"Content-Type":"application/json"}}).catch(function(e){}),e.lock=!1,e.upload()},this.timeout))},e.prototype.generateKey=function(e){return e.collectKey?[e.collectMode,e.collectKey].join("___"):""},e.prototype.push=function(e){this.batchData.push(e),this.upload()},e.prototype.report=function(e){var t=this.generateKey(e);if(L.fetch&&e.collectKey){var i="object"==typeof window?window.location.href:"SSR";e.documentUrl=i;var r={age:Math.floor(Date.now()),type:"xss",url:i,body:e,"user-agent":""};"enforce"===e.disposition&&"SSR"!==i||(r.url=t),"SSR"===i&&(r.url="SSR___".concat(r.url),r.body.ssr=!0),this.push(r)}},e}()),D=function(e){for(var t=0,i=function(i){Array.isArray(e[i])?0===e[i].length?delete e[i]:(e[i]=g.from(g.uniq(e[i])),t+=e[i].length):0===g.keys(e[i]).length?delete e[i]:g.keys(e[i]).forEach(function(r){e[i][r]=g.from(g.uniq(e[i][r])),t+=e[i][r].length})},r=0,n=g.keys(e);r<n.length;r++)i(n[r]);return{count:t,ret:e}};function C(e,t){return R.setConfig(t),new b(t).process(e)}function O(e){var t,i=(t=/\s|\n|\t/.exec(e))?t.index:-1;if(-1===i)return{html:"",closing:"/"===e[e.length-2]};var r="/"===(e=e.slice(i+1,-1).trim())[e.length-1];return r&&(e=e.slice(0,-1).trim()),{html:e,closing:r}}var x=function(e){return -1===(e=(e=(e=(e=e.replace(/&colon;/gi,":")).replace(/&tab;/gi,"")).replace(/&newline;/gi,"")).replace(/(\t|\n|\r)/g,"")).indexOf("&#")?e.trim().toLowerCase():e.trim().replace(/&#(?:(x)([0-9a-f]+)|([0-9]+));?/gi,function(e,t,i,r){return String.fromCharCode(t?parseInt(i,16):parseInt(r))}).replace(/(\t|\n|\r)/g,"").toLowerCase()};function P(e,t){if(void 0===e&&(e=""),"string"!=typeof e)return!0;if(e=x(e),g.includes(e,"base64")&&!function(e){if(""===e||""===e.trim())return!0;try{return!g.includes(e,"data:text/html;base64")}catch(e){return!0}}(e))return t&&t("data:text/html;base64"),!1;var i=["expression(","behavior:","view-source:"];if(g.some(i,function(t){return -1!==e.indexOf(t)}))return g.forEach(i,function(i){-1!==e.indexOf(i)&&t&&t(i)}),!1;var r=["data:application","data:javascript","data:text/html","data:texthtml"];if(g.some(r,function(t){return -1!==e.indexOf(t)}))return g.forEach(r,function(i){-1!==e.indexOf(i)&&t&&t(i)}),!1;if(e.indexOf("javascript:")>0)return t&&t("javascript:"),!1;if(/^javascript:/i.test(e)){var n=e.slice(11).replace(/\s/g,"").trim();return!!g.some(["void","void(0)","void0","false","undefined",";"],function(e){return e===n})||(t&&t("javascript:"),!1)}return!0}var I=function(e,t){var i,r,n="<%= isSaveValidUrl =>";if("string"!=typeof e||(r=Number("<%= urlLimit =>"),void 0!==i&&(r=i),"NaN"!==e.toString()&&-1!==r&&e.length>=r)||P(e,t))return e;try{if(!0===(n=JSON.parse(n))||"true"===n){var a=new URL(e);return a.origin+a.pathname}}catch(e){}return"#"};function w(e,t,r){if(void 0===e&&(e=""),void 0===t&&(t=[]),"string"!=typeof e)return!0;if(!P(e=x(e)))return!1;var n,a={url:(n=e.match(/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/)||[])[0],scheme:n[1],slash:n[2],host:n[3],port:n[4],path:n[5],query:n[6],hash:n[7]},o=a.scheme,s=a.host;return r?!!r(e):!(!o||!s)&&(!g.includes(["http","https","file"],o)||("object"==typeof window&&window&&(t=i(i([],t,!0),[location.host],!1)),g.some(t,function(e){return!!(e instanceof RegExp&&e.test(s))||e===s})))}var A={a:["target","title","spellcheck","rel"],canvas:[],abbr:["title"],address:[],area:["shape","coords","alt"],article:[],aside:[],audio:["autoplay","controls","loop","preload"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:["dir"],dl:[],dt:[],em:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["alt","title","width","height","decoding"],ins:["datetime"],li:[],mark:[],nav:[],ol:["start"],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],sup:[],delete:[],form:[],strong:[],mask:["maskunits","x","y","width","height","fill"],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],wbr:[],video:["autoplay","controls","loop","preload","height","width"],svg:["viewBox","version","xmlns","fill","width","height","stroke","stroke-width","style"],path:["d","fill","opacity","stroke","p-id","fill-rule","clip-rule","stroke-width","stroke-linecap","stroke-linejoin","fill-opacity","mask"],rect:["x","y","width","height","fill","stroke","rx"],g:[]},B={collect:null,initCollect:function(){this.collect={whiteList:{},filterProtocol:[]}},removeCollect:function(){var e=D(this.collect),t=e.count,i=e.ret;return this.collect=null,{collectKey:0===t?null:JSON.stringify(i),collectMode:"white"}},onIgnoreTagAttr:function(e,t,r){return e&&g.indexOf(["href","src"],t)>-1?B.domainWhiteList&&Array.isArray(B.domainWhiteList)&&B.domainWhiteList.length>0&&!w(r,i([],B.domainWhiteList,!0))?"":"".concat(t,'="').concat(I(r,function(e){var t;null===(t=B.collect)||void 0===t||t.filterProtocol.push(e)}),'"'):e&&(g.indexOf(["style","class","id"],t)>-1||t.indexOf("data-")>-1)?"".concat(t,'="').concat(r,'"'):(B.collect.whiteList[e]=B.collect.whiteList[e]||[],void B.collect.whiteList[e].push(t))},onIgnoreTag:function(e,t){if("style"===e)return t;T(t,function(e,t,i,r){S(O(r).html.replace("/",""),function(e){B.collect.whiteList[i]=B.collect.whiteList[i]||[],B.collect.whiteList[i].push(e)})},p)},whiteList:A,mergeWhiteList:function(e){for(var t,i={},r=0,n=g.keys(A);r<n.length;r++)i[t=n[r]]=g.from(A[t]);for(var a=0,o=g.keys(e);a<o.length;a++)i[t=o[a]]=t in A?A[t].concat(e[t]):g.from(e[t]);return i},setWhiteList:function(e){for(var t=0,i=g.keys(e);t<i.length;t++){var r=i[t];this.whiteList[r]=r in A?A[r].concat(e[r]):g.from(e[r])}}};try{var M={},N="merge";g.includes(N,"override")&&(B.whiteList=M.whiteList),g.includes(N,"merge")&&B.setWhiteList(M.whiteList)}catch(e){}var U=function(e,t){for(var i={},r=0,n=g.keys(e);r<n.length;r++){var a=n[r];Array.isArray(e[a])?i[a]=g.from(e[a]):i[a]=U({},e[a])}for(var o=0,s=g.keys(t);o<s.length;o++)(a=s[o])in e?Array.isArray(e[a])?i[a]=e[a].concat(t[a]):i[a]=U(e[a],t[a]):Array.isArray(t[a])?i[a]=g.from(t[a]):i[a]=U({},t[a]);return i},H={blackList:{a:["folder"],meta:["content"],iframe:["srcdoc"],input:["pattern"],vmlframe:["xmlns"]},blackTags:["script","xml","embed","isindex","object","base","set","handler","animate","payload","import"],blackAttrs:["charset","ns","namespace","formaction","xlink:href","xmlns:xlink","handler","repeat","repeat-start","repeat-end"],blackAttrRegExps:[/^on/],filterList:{param:["value"],video:["poster"],form:["action"]},filterAttrs:["href","src","background","style","dynsrc","lowsrc","content"]};try{var F={};F.blackAttrRegExps&&(F.blackAttrRegExps=F.blackAttrRegExps.map(function(e){return new RegExp(e.toString().slice(1,e.toString().length-1))}));var G="merge";g.includes(G,"override")&&(H=F),g.includes(G,"merge")&&(H=U(H,F))}catch(e){}var V={mode:"black",whiteList:{},blackConfig:H,collect:null,initCollect:function(){V.collect={blackList:{},blackTags:[],blackAttrs:[],blackAttrRegExps:[],filterAttrs:[],filterList:{},filterProtocol:[]}},removeCollect:function(){var e=D(V.collect),t=e.count,i=e.ret;return V.collect=null,{collectKey:0===t?null:JSON.stringify(i),collectMode:"black"}},onIgnoreTag:function(e,t){var i;if(!g.includes(H.blackTags,e))return T(t,function(e,t,i,r,n){if(-1!==i.indexOf("/"))return p(r);if(n)return"</".concat(i,">");var a=O(r),o=S(a.html,function(e,t){var r,n=0;if(H.blackList[i]&&g.includes(H.blackList[i],e)&&(V.collect.blackList[i]=V.collect.blackList[i]||[],V.collect.blackList[i].push(e),n++),H.blackAttrRegExps.length&&H.blackAttrRegExps.some(function(t){return t.test(e)})&&g.forEach(H.blackAttrRegExps,function(t){t.test(e)&&(V.collect.blackAttrRegExps.push("".concat(t.toString(),"->").concat(e)),n++)}),H.blackAttrs.length&&g.includes(H.blackAttrs,e)&&(H.blackAttrs.push(e),n++),!n){if(H.filterList&&H.filterList[i]&&g.includes(H.filterList[i],e)){var a=I(t,function(e){var t;null===(t=V.collect)||void 0===t||t.filterProtocol.push(e)});return a!==t&&(V.collect.filterList[i]=V.collect.filterList[i]||[],V.collect.filterList[i].push(e)),t?"".concat(e,"='").concat(a,"'"):e}return H.filterAttrs&&g.includes(H.filterAttrs,e)?((a=I(t,function(e){var t;null===(t=V.collect)||void 0===t||t.filterProtocol.push(e)}))!==t&&(null===(r=V.collect)||void 0===r||r.filterAttrs.push(e)),t?"".concat(e,"='").concat(a,"'"):e):t?"".concat(e,"='").concat(t,"'"):e}});return r="<".concat(i),o&&(r+=" ".concat(o)),a.closing&&(r+=" /"),r+=">"},p);null===(i=V.collect)||void 0===i||i.blackTags.push(e)}},j=function(e){var t=e.reportOnly,i=void 0===t||t,r=e.block;return i&&"all"===i?"report":("string"==typeof i&&("true"===i&&(i=!0),"false"===i&&(i=!1)),r?"enforce":i?"report":"enforce")},Z=function(e){return function(i,r,n){if(!i||"string"!=typeof i)return i;var a=r;e===C&&(a=B).initCollect();var o=e(i,a);if(E(o)===E(i))return i;if(!n)return o;var s=n.logType,l=j(n),u=a.removeCollect();return R.report(t(t({type:s,disposition:l},u),{sourceText:_(i),filterText:_(o)})),"enforce"===l?o:i}},q=Z(function(e,t){return void 0===t&&(t={}),t&&t.whiteList||(t.whiteList={a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}),new b(t).process(e)}),K=Z(C),Y=function(e,t,i){var r=[],n=I(e,function(e){r.push(e)});if(n===e)return e;r=g.from(g.uniq(r));var a=t||i||{};if(!a)return n;var o=a.logType,s=j(i);return R.report({type:o,disposition:s,collectKey:r.join("___"),collectData:JSON.stringify(r),collectMode:"black",sourceText:_(e),filterText:_(n)}),"enforce"===s?n:e},W=L._xssProject||{},z=L.xssNamespace||{},J="3.0.26",X={FilterXSS:b,version:J,webpackPluginVersion:"<%= webpackPluginVersion =>",reportOnly:"<%= reportOnly =>",filterXSS:q,_filterXSS:K,filterUrl:Y,Config:B,BlackConfig:V,project:W,setProjectName:function(e){W[e]=this,L._xssProjectName=e}};z.douyin_web=X,L.xssNamespace=z,L.Math&&!L.Math.xssNamespace&&(L.Math.xssNamespace=z),W[J]=X,L.globalThis=L,L.getFilterXss=function(){return void 0!==this._xssProjectName?this._xssProject[this._xssProjectName]:X},L.xss=X,L.isSafeUrl=w,L.isSafeDomain=w,L.isSafeProtocol=P,L._xssProject=W,L._xssProjectName&&(W[L._xssProjectName]=X);var Q=X.setProjectName.bind(X);e.BlackConfig=V,e.Config=B,e.FilterXSS=b,e._filterXSS=K,e.filterUrl=Y,e.filterXSS=q,e.isSafeDomain=w,e.isSafeProtocol=P,e.isSafeUrl=w,e.project=W,e.setProjectName=Q,e.setXssNamespace=function(e){var t=e.appId,i=e.bid,r=e.region;z[t]=X;B.bid=i,B.region=r,B.enabled=!0},e.xssNamespace=z,Object.defineProperty(e,"__esModule",{value:!0})});"use strict";(self.webpackChunkdouyin_web=self.webpackChunkdouyin_web||[]).push([["6284"],{284938:function(e,t,i){i.d(t,{LH:function(){return u},O1:function(){return a},T3:function(){return v},UK:function(){return m},YL:function(){return f},av:function(){return l},bB:function(){return c},bJ:function(){return p},bT:function(){return r},c3:function(){return d},co:function(){return g},fp:function(){return s},iR:function(){return n},kU:function(){return o},qC:function(){return h}});var r={ONE_PLAY:"videoplayer_oneplay",ONE_OPERA:"videoplayer_oneopera",ONE_ERROR:"videoplayer_oneerror",ONE_EVENT:"videoplayer_oneevent",ONE_TEMP:"videoplayer_onetemp"},n={data:1e3,runtime:1002,parse:1004,network:1003,no_error_handler:9997,custom_error:9998,other:9999,notSupport:1005},a={1:-499991,2:-499992,3:-499993,4:-499994,5:-499995},o={STOP:0,PLAYING:1,PAUSE:2,ERROR:3,LOADING:4},s={UNKNOWN:0,PLAYABLE:1,STALLED:2,ERROR:3},l={ERROR:1,NEXT:2,ENDED:3,UNLOAD:4,DESTROY:5,PLAY_CATCH:6,PLAY_ERROR:7},u={RETRY:"error_retry",ONEERROR:"oneerror",ONEEVENT:"oneevent",ONETEMP:"onetemp"},d={NO_CACHE:0,CACHED:1},c=864e5,f=36e5,h=["tag","subtag","device_type"],p=200,g=6e4,v=6e4,m={NO_FULLSCREEN:0,FULLSCREEN:1,CSS:2}},670797:function(e,t,i){i.d(t,{Z:function(){return o}}),i(947478);var r=function(){return function(){try{return"undefined"!=typeof localStorage&&"setItem"in window.localStorage&&!!window.localStorage.setItem}catch(e){return!1}}()&&!function(){var e="_localstorage_support_test";try{return window.localStorage.setItem(e,!0),window.localStorage.removeItem(e),!1}catch(e){return!0}}()}(),n=r?window.localStorage:{},a="__xgplayerlogkey",o={set:function(e){try{var t=this.get();t.push(e),n.setItem(a,JSON.stringify(t))}catch(e){}},get:function(){try{var e=n.getItem(a);return e=e?JSON.parse(e):[]}catch(e){return[]}},remove:function(){try{n.removeItem(a)}catch(e){}},clear:function(){try{n.clear()}catch(e){}}}},932508:function(e,t,i){i.d(t,{Z:function(){return Y}});var r=i("167846");i("514312"),i("561999"),i("831528"),i("477416"),i("11258"),i("121621"),i("614521"),i("904644"),i("379493"),i("969642"),i("585322"),i("766282"),i("410121"),i("724356"),i("947478"),i("864614"),i("632852"),i("130458"),i("227470"),i("238658"),i("347885"),i("616414"),i("210434"),i("612222");var n=i("801379"),a=i("918334"),o=i("868685"),s=i("402482"),l=i("274005"),u=i("336730"),d=i("623176"),c=i("626735"),f=i("374078"),h=i("860513"),p=i("661854"),g=i("101132"),v=i("809345"),m=i("901855"),_=i("304304"),y=i("398762"),T=i("788539"),S=function(){try{return T.j?window.MediaSource:null}catch(e){}}(),k={APPEND:"appendBuffer",REMOVE:"removeBuffer",UPDATE_DURATION:"updateDuration"},E=function(){var e,t,i;function r(e,t){var i=this;(0,v.PA)(this,r),(0,v._x)(this,"media",null),(0,v._x)(this,"mediaSource",null),(0,v._x)(this,"_openPromise",(0,m.Q)()),(0,v._x)(this,"_queue",Object.create(null)),(0,v._x)(this,"_sourceBuffer",Object.create(null)),(0,v._x)(this,"_mseFullFlag",{}),(0,v._x)(this,"_st",0),(0,v._x)(this,"_opst",0),(0,v._x)(this,"_logger",null),(0,v._x)(this,"_config",null),(0,v._x)(this,"_url",null),(0,v._x)(this,"_onSBUpdateEnd",function(e){var t=i._queue[e];if(t){var r=t[0];if((null==r?void 0:r.opName)!==k.UPDATE_DURATION&&t.shift(),r){var n=(0,m.j)()-i._opst;i._logger.debug("UpdateEnd",r.opName,n,r.context),r.promise.resolve({name:r.opName,context:r.context,costtime:n}),i._startQueue(e)}}}),(0,v._x)(this,"_onSBUpdateError",function(e,t){var r=i._queue[e];if(r){var n=r[0];n&&(i._logger.error("UpdateError",e,n.opName,n.context),n.promise.reject(new y.Fc(y.wb.MEDIA,y.wb.SUB_TYPES.MSE_APPEND_BUFFER,t)))}}),this._config=Object.assign(r.getDefaultConfig(),t),e&&this.bindMedia(e),this._logger=new g.Y("MSE"),this._config.openLog&&g.Y.enable()}return(0,v.qH)(r,[{key:"isOpened",get:function(){var e;return(null===(e=this.mediaSource)||void 0===e?void 0:e.readyState)==="open"}},{key:"url",get:function(){return this._url}},{key:"duration",get:function(){var e;return(null===(e=this.mediaSource)||void 0===e?void 0:e.duration)||-1}},{key:"isEnded",get:function(){return!!this.mediaSource&&"ended"===this.mediaSource.readyState}},{key:"isFull",value:function(e){return e?this._mseFullFlag[e]:this._mseFullFlag[r.VIDEO]}},{key:"updateDuration",value:function(e){var t=this,i=this.mediaSource&&this.mediaSource.duration>e;if(this.mediaSource&&this.mediaSource.duration>e){var r=0;if(Object.keys(this._sourceBuffer).forEach(function(e){try{r=Math.max(t.bufferEnd(e)||0,r)}catch(e){}}),e<r)return Promise.resolve()}return this._enqueueBlockingOp(function(){if(t.isEnded){t._logger.debug("[debug mse] setDuration ended");return}t.mediaSource&&(t.mediaSource.duration=e,t._logger.debug("[debug mse] setDuration"))},k.UPDATE_DURATION,{isReduceDuration:i})}},{key:"open",value:function(){var e=this;if(this._openPromise.used&&!this.isOpened&&this.mediaSource){var t=this.mediaSource;t.addEventListener("sourceopen",function i(){var r=(0,m.j)()-e._st;e._logger.debug("MSE OPEN",r),t.removeEventListener("sourceopen",i),e._openPromise.resolve({costtime:r})}),this._openPromise=(0,m.Q)()}return this._openPromise}},{key:"bindMedia",value:(e=(0,v.x)((0,v.l5)().mark(function e(t){var i,r,n=this;return(0,v.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.mediaSource||this.media)){e.next=3;break}return e.next=3,this.unbindMedia();case 3:if(!(!t||!S)){e.next=5;break}throw Error("Param media or MediaSource does not exist");case 5:return this.media=t,i=this.mediaSource=new S,this._st=(0,m.j)(),r=function e(){var r=(0,m.j)()-n._st;n._logger.debug("MSE OPEN"),i.removeEventListener("sourceopen",e),URL.revokeObjectURL(t.src),n._openPromise.resolve({costtime:r})},i.addEventListener("sourceopen",r),this._url=URL.createObjectURL(i),t.src=this._url,e.abrupt("return",this._openPromise);case 13:case"end":return e.stop()}},e,this)})),function(t){return e.apply(this,arguments)})},{key:"unbindMedia",value:(t=(0,v.x)((0,v.l5)().mark(function e(){var t,i,r,n=this;return(0,v.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._openPromise.used&&this._openPromise.resolve(),t=this.mediaSource){if(Object.keys(this._queue).forEach(function(e){var t=n._queue[e];t&&t.forEach(function(e){var t,i;return null===(t=e.promise)||void 0===t?void 0:null===(i=t.resolve)||void 0===i?void 0:i.call(t)})}),i=!!this.media&&this.media.readyState>=1,r="open"===t.readyState,i&&r)try{t.endOfStream()}catch(e){}Object.keys(this._sourceBuffer).forEach(function(e){try{t.removeSourceBuffer(n._sourceBuffer[e])}catch(e){}})}if(this.media){this.media.removeAttribute("src");try{this.media.load()}catch(e){}this.media=null}this.mediaSource=null,this._openPromise=(0,m.Q)(),this._queue=Object.create(null),this._sourceBuffer=Object.create(null);case 8:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"createSource",value:function(e,t){var i;if(!this._sourceBuffer[e]&&this.mediaSource){try{i=this._sourceBuffer[e]=this.mediaSource.addSourceBuffer(t)}catch(e){throw new y.Fc(y.wb.MEDIA,y.wb.SUB_TYPES.MSE_ADD_SB,e)}i.mimeType=t,i.addEventListener("updateend",this._onSBUpdateEnd.bind(this,e)),i.addEventListener("error",this._onSBUpdateError.bind(this,e))}}},{key:"changeType",value:function(e,t){var i=this,r=this._sourceBuffer[e];return this.mediaSource&&r&&r.mimeType!==t?"function"!=typeof r.changeType?Promise.reject():this._enqueueOp(e,function(){r.changeType(t),r.mimeType=t,i._onSBUpdateEnd(e)},"changeType",{mimeType:t}):Promise.resolve()}},{key:"createOrChangeSource",value:function(e,t){return this.createSource(e,t),this.changeType(e,t)}},{key:"append",value:function(e,t,i){var r=this;return t&&t.byteLength&&this._sourceBuffer[e]?this._enqueueOp(e,function(){var n;r.mediaSource&&!r.media.error&&(r._logger.debug("MSE APPEND START",i),r._opst=(0,m.j)(),null===(n=r._sourceBuffer[e])||void 0===n||n.appendBuffer(t))},k.APPEND,i):Promise.resolve()}},{key:"remove",value:function(e,t,i,r){var n=this,a=!1;return this._mseFullFlag[e]&&(a=!0),this._enqueueOp(e,function(){if(n.mediaSource&&!n.media.error){var a=n._sourceBuffer[e];if(t>=i||!a){n._onSBUpdateEnd(e);return}n._opst=(0,m.j)(),n._logger.debug("MSE REMOVE START",e,t,i,r),a.remove(t,i)}},k.REMOVE,r,a)}},{key:"clearBuffer",value:function(e,t){var i,r=this;return Object.keys(this._sourceBuffer).forEach(function(n){i=r.remove(n,e,t)}),i||Promise.resolve()}},{key:"clearAllBuffer",value:function(){var e,t=this;return Object.keys(this._sourceBuffer).forEach(function(i){var r=t._sourceBuffer[i];e=t.remove(i,0,_.l.end(_.l.get(r)))}),e}},{key:"clearOpQueues",value:function(e,t){this._logger.debug("MSE clearOpQueue START");var i,r=this._queue[e];if(t&&r){this._queue[e]=[];return}if(r&&r[e]&&!(r.length<5)){var n=[];r.forEach(function(e){e.context&&e.context.isinit&&n.push(e)}),this._queue[e]=r.slice(0,2),n.length>0&&(i=this._queue[e]).push.apply(i,n)}}},{key:"endOfStream",value:function(e){var t=this;return this.mediaSource&&"open"===this.mediaSource.readyState?this._enqueueBlockingOp(function(){var i=t.mediaSource;i&&"open"===i.readyState&&(t._logger.debug("MSE endOfStream START"),e?i.endOfStream(e):i.endOfStream())},"endOfStream"):Promise.resolve()}},{key:"setLiveSeekableRange",value:function(e,t){var i=this.mediaSource;!(e<0)&&!(t<e)&&null!=i&&i.setLiveSeekableRange&&"open"===i.readyState&&i.setLiveSeekableRange(e,t)}},{key:"getSourceBuffer",value:function(e){return this._sourceBuffer[e]}},{key:"buffered",value:function(e){return _.l.get(this._sourceBuffer[e])}},{key:"bufferStart",value:function(e){return _.l.start(this.buffered(e))}},{key:"bufferEnd",value:function(e){return _.l.end(this.buffered(e))}},{key:"_enqueueOp",value:function(e,t,i,r,n){var a=this;if(!this.mediaSource)return Promise.resolve();var o=this._queue[e]=this._queue[e]||[],s={exec:t,promise:(0,m.Q)(),opName:i,context:r};return n?(o.splice(0,0,s),this._mseFullFlag[e]=!1,this._startQueue(e)):o.push(s),this.isOpened||this.isEnded?1===o.length&&this._startQueue(e):this._openPromise.then(function(){1===o.length&&a._startQueue(e)}),s.promise}},{key:"_enqueueBlockingOp",value:(i=(0,v.x)((0,v.l5)().mark(function e(t,i,r){var n,a,o=this;return(0,v.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.mediaSource){e.next=2;break}return e.abrupt("return",Promise.resolve());case 2:if((n=Object.keys(this._sourceBuffer)).length){e.next=5;break}return e.abrupt("return",t());case 5:return a=[],n.forEach(function(e){var t=o._queue[e],n=(0,m.Q)();a.push(n),t.push({exec:function(){n.resolve()},promise:n,opName:i,context:r}),1===t.length&&o._startQueue(e)}),e.abrupt("return",Promise.all(a).then(function(){try{return t()}finally{n.forEach(function(e){var t=o._queue[e],i=o._sourceBuffer[e];null==t||t.shift(),(!i||!i.updating)&&o._startQueue(e)})}}));case 8:case"end":return e.stop()}},e,this)})),function(e,t,r){return i.apply(this,arguments)})},{key:"_startQueue",value:function(e){var t=this._queue[e];if(t){var i=t[0];if(i&&!this._mseFullFlag[e])try{i.exec()}catch(r){r&&r.message&&r.message.indexOf("SourceBuffer is full")>=0?(this._mseFullFlag[e]=!0,this._logger.error("[MSE error],  context,",i.context," ,name,",i.opName,",err,SourceBuffer is full"),i.promise.reject(new y.Fc(y.wb.MEDIA,y.wb.SUB_TYPES.MSE_FULL,r))):(this._logger.error(r),i.promise.reject(new y.Fc(y.wb.MEDIA,y.wb.SUB_TYPES.MSE_OTHER,r)),t.shift(),this._startQueue(e))}}}},{key:"setTimeoffset",value:function(e,t,i){var r=this;return this._enqueueOp(e,function(){t<0&&(t+=.001),r._sourceBuffer[e].timestampOffset=t,r._onSBUpdateEnd(e)},"setTimeoffset",i)}},{key:"abort",value:function(e,t){var i=this;return this.isOpened?this._enqueueOp(e,function(){var t;null===(t=i._sourceBuffer[e])||void 0===t||t.abort(),i._onSBUpdateEnd(e)},"abort",t):Promise.resolve()}}],[{key:"getDefaultConfig",value:function(){return{openLog:!1}}},{key:"isSupported",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:'video/mp4; codecs="avc1.42E01E,mp4a.40.2"';if(!S)return!1;try{return S.isTypeSupported(e)}catch(t){return this._logger.error(e,t),!1}}}]),r}();(0,v._x)(E,"VIDEO","video"),(0,v._x)(E,"AUDIO","audio");var b=i("410550"),L=i("246189"),R=i("906399"),D=i("677043"),C=i("264543"),O=i("24166"),x=i("228908"),P=i("169198"),I=i("935672"),w=i("480514"),A=i("930770"),B=i("244694"),M=i("328943"),N=i("383414"),U="DESTROYED",H="xglog_cache",F="degrade",G={UPDATE_URL:"UPDATE_URL"},V=null,j=null,Z=null,q=null,K=0,Y=function(e){var t,i,u,v,m,y,T,S;function k(e){var t,i,o,s;return(0,r.PA)(this,k),i=(0,r.$w)(this,k,[e]),(0,r._x)(i,"_onChangeConfig",function(e){if(e){var t=e.nextBufferLength===i.config.minBufferLength;if(i.setConfig(e),e.nextBufferLength&&!t)try{i._onTimeUpdate()}catch(e){}}}),(0,r._x)(i,"fpsStuckHandle",function(e){var t=i.player,r=i.mse;if(!i.fpsStuckTime&&(i.fpsStuckTime=e.currentTime,i.log(g._.LOG,"fpsStuckHandle, currentTime,",e.currentTime)),r&&i.fpsStuckTime>0){var n=t.bufferedPoint;r.clearOpQueues(E.VIDEO),i.log(g._.LOG,"fpsStuckHandle, remove: ".concat(n.start,"-").concat(n.end,","),"stuckTime: ".concat(i.fpsStuckTime)),r.remove(E.VIDEO,n.start,n.end).then(function(){t.currentTime=i.fpsStuckTime,i.fpsStuckTime=null})}}),(0,r._x)(i,"_replayHook",function(e){}),(0,r._x)(i,"_retryHook",function(){var e=i.player,t=i.playerConfig,r=e.paused;i.softDecode?e.vtype=a.l0.MP4_MSE_SOFT:e.vtype=a.l0.MP4_MSE,i._defInited=!1,i._MSEError=!1,e.video.removeEventListener("loadedmetadata",i.__onmetadataHandle);var n=e.currentTime||0;return i.log(g._.LOG,"retryHook ",t.vid,i.codecType,n),i.__onmetadataHandle=function(){n&&(e.currentTime=n,i.log(g._.LOG,"retryHook update currentTime",t.vid,i.codecType,n)),r?e.pause():e.play(),e.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},e.video.addEventListener("loadedmetadata",i.__onmetadataHandle),i.destroyMSE(),i._reset(),i.states=[],i.playerStartInit(t.url),!1}),(0,r._x)(i,"_playHook",function(e){i._usePaused=!1,i._cancelLoading=!1,i.log(g._.LOG,"playHook"),i._startProgress()}),(0,r._x)(i,"_pauseHook",function(e){var t;i._usePaused=!0;for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];i.log(g._.LOG,"pauseHook",n[0],null===(t=i.player)||void 0===t?void 0:t.currentTime),0>n.indexOf(null===R.Im||void 0===R.Im?void 0:R.Im.BUFFER_CONTROLS)&&(clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=null,i.log(g._.LOG,"pause hook clear buffer_control state")),i._loadStuckCheck()}),(0,r._x)(i,"abrSwitchURL",(o=(0,r.x)((0,r.l5)().mark(function e(t){var n,a,o,s;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=i.playerConfig.definition.list,a=0,o=0;case 4:if(!(o<n.length)){e.next=11;break}if(t.definition!==n[o].definition){e.next=8;break}return a=o,e.abrupt("break",11);case 8:o++,e.next=4;break;case 11:s=i.player.curDefinition,i.changeDefinition(n[a],s,!0);case 13:case"end":return e.stop()}},e)})),function(e){return o.apply(this,arguments)})),(0,r._x)(i,"timerHandle",function(){i._requestTimer&&i._onTimeUpdate()}),(0,r._x)(i,"changeDefineCanPlay",function(e,t,r,n){var a,o=i.player,s=i._changeDefState?i._changeDefState.currentTime:e;if(i.needStarLoadFirstSegment=!0,o.changeDefinitionSeekState=1,i.log(g._.LOG,"changeDefineCanPlay seek changeBitrate point ".concat(s,", pause: ").concat(null===(a=i._changeDefState)||void 0===a?void 0:a.paused)),o.ended){o.currentTime=0;return}o.currentTime=s,i._changeDefState&&i._changeDefState.paused?o.pause():o.play(),i._changeDefState=null,o.emit(d.AFTER_DEFINITION_CHANGE,{from:r,to:n})}),(0,r._x)(i,"changeDefinition",function(e,t,a){var o,s=i.player,l=i.playerConfig,u=i.mp4,f=i.config;if(!t&&(t=s.curDefinition),i._MSEError=!1,i._isReceiveEndedEvent=!1,i.useVideoLoad){"__auto__"===e.url&&(e.url=s.config.definition.list[0].url),Z.call(i.player,e,t);return}var h=s.definitionList.filter(function(t){return t.definition===e.definition});if(h.length>0&&(e=h[0]),i._handlerUrl(e.url),e._mainURL=f._mainURL,e._backupURL=f._backupURL,i._switchBitRateWay&&!a){i.oldChangeDefinition(e,t);return}var p="自动"===e.definition||"auto"===e.definition;if(a)i.log(g._.LOG,"[switchBitrate:ABR], ready to switch bitRate, ",e.bitrate,e.definition);else{var v=!1;if(p)i._abrService&&i._abrService.enable(),v=!0;else{i._abrService&&i._abrService.disable();var m,_,y=null===(_=l.definition)||void 0===_?void 0:_.list;if(y&&(!e.bitrate||!e.uri||!e.size||!e.duration)){for(var T=0;T<y.length;T++)if(e.definition===y[T].definition){e.bitrate=y[T].bitrate,e.uri=y[T].uri||t.uri,e.size=y[T].size||w.Z.getFileSize(e.bitrate,l.duration),e.duration=y[T].duration||i.playerConfig.duration;break}}}null===(m=i.adaptRange)||void 0===m||m.updateBitrate(e.bitrate),s.oldBit=e.bitrate,s.emit(d.DEFINITION_CHANGE,{from:t,to:e}),setTimeout(function(){i._abrService&&i._abrService.updateAutoDefiDesc(s.curDefinition.definition,!p)}),v&&(e=s.curDefinition),i.log(g._.LOG,"[switchBitrate:CBS],switch bitRate, ",e.bitrate,e.definition,s.currentTime)}if(s.curDefinition=e,i.mp4.clearPCDNNodeList(),i.checkPCDN(),!!u){["keyValue","kid","secretKey","drm","getLicenseUrl","drmKeyToken","sessionId"].forEach(function(t){f[t]=e[t]});var S=i.config,k=S.kid,b=S.drmKeyToken,L=S.secretKey,R=S.keyValue,D=S.drm,O=null;if(k||b||L||R||D)i._secretkey?i._secretkey.updateConfig(i.config):(i._secretkey=new n.XGSecretKey(i.config),i._secretkey.on(n.EVENT_EME.ERROR,i._errorHandler)),O=i._secretkey.getLicenseSecret();else{var x=Promise.withResolvers(),P=x.promise,I=x.resolve;O=P,I()}O.then((o=(0,r.x)((0,r.l5)().mark(function n(a){var o,d,c,h,p,v,m,_,y,T,S,k,b,L;return(0,r.l5)().wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(null!=a&&a.secretKey&&(f.keyValue||(f.secretKey=a.secretKey),f.decryptKey=a.decryptKey),l.url=e.url,d=0,c=!1,h=s.getBufferedRange(),i._abrService&&i._abrService.isCurrentInAbr()?(p=Math.max(h[1],s.currentTime),d=i.getCurGopEndTime(p)):(d=i.getCurGopEndTime(),c=!0),!(d>=u.timeRange[u.timeRange.length-1].startTime)){r.next=9;break}return i.log(g._.LOG,"switch bitrate last segment, so return"),r.abrupt("return");case 9:if(v=null===(o=i._abrService)||void 0===o?void 0:o.isCurrentInAbr(),null==u||u.updateChangeBitRateTime(d),m=u.getFragmentIdx(d),!(h[1]<d)){r.next=16;break}u.fillGopData&&u.fillGopData(s.currentTime),r.next=20;break;case 16:return i.canDownload=!1,r.next=19,u.cancelLoading();case 19:u.metaLoading=!1;case 20:(_=i.getAdaptTimeRangeIdx(m))<0&&(_=i._curLoadSegmentIdx),i.log(g._.LOG,"switchBitrate point: ".concat(_),"currentTime: ".concat(s.currentTime,", timeStart: ").concat(d,", \n          buffer: ").concat(h[0]," - ").concat(h[1])),c&&s.emit("definitionSwitchTime",u.adaptTimeRange[_].startTime+1),i._definitionChangePointInfo={changeStartTime:d,changeInfo:{from:t,to:e}},i._removeBuffEndTime=d,(y=s.getBufferedRange(s.buffered))[1]>0&&y[1]>d&&(!i._abrService||!v)&&(i.removeBuffer(E.VIDEO,d,y[1]),i.log(g._.LOG,"switchBitrate: ready to remove buffer, ".concat(d," - ").concat(y[1]))),(T=u.getFragmentIdx(s.currentTime))>0&&(S=s.buffered.start(0),k=u.timeRange[T].startTime-1,i.removeBuffer(E.VIDEO,S,k,function(){i.log(g._.LOG,"switchBitrate: remove old bitrate buffer end",JSON.stringify(s.getBufferedRange(s.buffered)))}),i.log(g._.LOG,"switchBitrate: ready to remove pre buffer, ".concat(S," - ").concat(k))),b=u.getAdaptIdxBySrcIdx(T)+1,i.log(g._.LOG,"switchBitrate: resetFragmentLoadState, ".concat(b,",        changeBitRateIdx: ").concat(_)),u.resetFragmentLoadState(b),i._curLoadSegmentIdx=b,i.mp4.readyToChangeBitrate(e),i._setCurrentDefinition(e.bitrate),i._emitDefinitionChangeDetailEvent(d),i.canDownload=!0,i._onTimeUpdate(),L={width:e.width||e.vwidth,height:e.height||e.vheight},s.emit("RESOLUTION_UPDATE",L);case 41:case"end":return r.stop()}},n)})),function(e){return o.apply(this,arguments)})).catch(function(t){i.log(g._.ERROR,"switchBitrate: GET_LICENSE_ERROR, ".concat(null==t?void 0:t.message));var r=new c.ZP(i.player,{errorType:C.iR.DRM,errorCode:C.O1.drm,errorMessage:(null==t?void 0:t.message)||"GET_LICENSE_ERROR",vid:l.vid});t.errorType="GET_LICENSE_ERROR",i.emit("GET_LICENSE_ERROR",r),i.changeState("LICENSE_ERROR",{d:e.definition})})}}),(0,r._x)(i,"_onVideoError",function(e){var t,r,n=i.player;i.changeState("video_error",{code:e.code||(null==n||null===(t=n.video)||void 0===t||null===(t=t.error)||void 0===t?void 0:t.code),message:e.message||(null==n||null===(r=n.video)||void 0===r||null===(r=r.error)||void 0===r?void 0:r.message),videoType:i.useVideoLoad})}),(0,r._x)(i,"removeBuffer",function(e,t,r,n){var a,o=i.getBufferDur();null===(a=i.mse)||void 0===a||a.remove(e,t,r).then(function(){var e=i.player,t=o-i.getBufferDur();if(t>0){i.emit("removeBuffer",{removeDur:t});for(var r=[],a=0;a<e.buffered.length;a++)r.push([e.buffered.start(a),e.buffered.end(a)]);i.log(g._.LOG,"removeDur end,curBuffer:".concat(JSON.stringify(r),", \n        currentTime:").concat(i.player.currentTime))}n&&n()})}),(0,r._x)(i,"_onPlaying",function(){i._waitAdjustTimeCnt>0&&i._waitInBufferTimer&&(i._waitAdjustTimeCnt-=1,i.log(g._.WARN,"[waitInBuffer resume play], waitAdjustTimeCnt,",i._waitAdjustTimeCnt)),clearTimeout(i._waitInBufferTimer),i._waitInBufferTimer=null;var e=i.mp4,t=i.player,r=i.config.resumePlayWaterLevel;if(!e){i.checkResumePlayTimer>0&&(clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=null,t.isBufferControlPaused&&(t.isBufferControlPaused=!1),t.paused&&t.play());return}if(e&&e.meta&&e.meta.duration-t.currentTime<=r)return;if(i.waitLevelStartTime<0&&(i.waitLevelStartTime=t.currentTime),!i.playFlag&&(i.playFlag=!0),void 0!==t.isBufferControlPaused&&!(r<=0)){if(r>0&&t.currentTime-i.waitLevelStartTime>=R.Ef){var n=t.getBufferedRange(t.buffered2);n[1]>0&&n[1]-t.currentTime<r?(!t.paused&&(i.emit(R.of,{type:R.a1.WAITING}),t.pause(null===R.Im||void 0===R.Im?void 0:R.Im.BUFFER_CONTROLS),i.log(g._.LOG,"[!!!!!buffer not rich, pause],currentTime, ",t.currentTime,", bufferEnd,",n[1])),clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=setTimeout(i._onPlaying,r/2*1e3)):t.isBufferControlPaused&&t.paused&&(i.log(g._.LOG,"[!!!!!buffer rich, play],, currentTime, ",t.currentTime,", bufferEnd,",n[1]),clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=null,t.isBufferControlPaused=!1,i.emit(R.of,{type:R.a1.PLAYING}),t.play())}}}),(0,r._x)(i,"_lowDecoder",function(){var e="function"==typeof i.player.video.getStats?i.player.video.getStats():null;i.log(g._.WARN,"H265 lowdecode: ".concat(i.playerConfig.vid," "),e,", h265Degrade, ",i.config.h265Degrade),i.config.h265Degrade&&i._onDegrade()}),(0,r._x)(i,"_onError",function(e){i._onDegrade(e)}),(0,r._x)(i,"_onDegrade",function(e){var t,r,n=i.player,o=i.playerConfig,s=i.config;n.video.removeEventListener("lowdecode",i._onDegrade),n.video.removeEventListener("error",i._onError),null===(t=i.mp4)||void 0===t||t.destroy();var l=n.currentTime;if(i.log(g._.WARN,"[h265 degrade], vid,",o.vid,",currtime,",l),i.emit(F,{errc:null==e?void 0:e.errorCode,err_msg:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),CodecTypes:i.codecType,media_type:o.mediaType}),null!=s&&s.H264Config){var u=s.H264Config;["drm","getLicenseUrl","kid","keyValue","secretKey","isEncrypt","useEME"].forEach(function(e){s[e]=u[e]||null})}var d={mp4encryptplayer:s,mediaType:"video",codecType:a.u7.H264};if((null==o||null===(r=o.H264DefinitionList)||void 0===r?void 0:r.length)>0){var c=i._processArrayUrl(o.H264DefinitionList);o.H264DefinitionList=c,n.config.definition.list=c,n.config.url=c[0].url,n.config.defaultBitrate=o.H264DefinitionList[0].bitrate,n.config.defaultDefinition=o.H264DefinitionList[0].definition,i.isH265DegradeH264=!0,n.playNext(d),i.__onmetadataHandle=function(){n.currentTime=l,i.isH265DegradeH264=!1,i.log(g._.LOG,"H265DegradeH264 update currentTime",l),n.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},n.video.addEventListener("loadedmetadata",i.__onmetadataHandle)}else n.pause(),i._reset(),i.states=[],i.checkReUseMSE(!1),i.log(g._.ERROR,"H265 error,degrade h264 but no h264 url"),i.emit("error",e)}),(0,r._x)(i,"_onMp4MetaReady",function(e,t){if(!t||t.hasDestroyed){i.log(g._.LOG,"Mp4MetaReady but  return, ".concat(!!t,", ").concat(null==t?void 0:t.hasDestroyed));return}var r=i._checkMetaInfo(e);if(r){i._errorHandler(r);return}var n=e.videoCodec,a=e.audioCodec;i._mediaCodec.videoCodec=n,i._mediaCodec.audioCodec=a;try{i._initEME(t,e),i.softDecode?(i.log(g._.LOG,"initH265MseProxy"),i._initH265MseProxy()):i.player.video instanceof HTMLVideoElement&&(i.log(g._.LOG,"initMse"),i._initMse(e)),i._initPromise&&i._initPromise.resolve()}catch(e){i._errorHandler(new c.ZP(i.player,{errorType:C.iR.MEDIA,errorCode:C.O1.eme_hijack,errorMessage:(null==e?void 0:e.message)||"eme or mse catch err",vid:i.playerConfig.vid}));return}if(null!=t&&t.timeRange){var o=[];t.timeRange.every(function(e){return o.push({startTime:e.startTime,endTime:e.endTime}),!0}),i.emit("KEYFRAMETIME",o)}t===i.mp4&&i._loadData()}),(0,r._x)(i,"_onMp4Error",(s=(0,r.x)((0,r.l5)().mark(function e(t){return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i._errorHandler(t);case 1:case"end":return e.stop()}},e)})),function(e){return s.apply(this,arguments)})),(0,r._x)(i,"_onMp4Progress",function(e){i.emit("progress_event",e)}),(0,r._x)(i,"_onMp4DataCallBack",function(){i._isMseInit&&i._onTimeUpdate()}),(0,r._x)(i,"_updateDrmConfig",function(e){var t=i.config;i.mp4.updateSecretKey(t.useEME,t.secretKey,t.decryptKey,t.keyValue),i._secretkey&&e.kid&&i._secretkey.updateKid(e.kid)}),(0,r._x)(i,"_updateMSE",function(e){i.player.video instanceof HTMLVideoElement&&(i.log(g._.LOG,"updateMse",e.videoCodec),i._initMse(e))}),(0,r._x)(i,"_onVideoTimeUpdate",function(){var e,t,r,n=i.mse,a=i.player;i.waitLevelStartTime<0&&(i.waitLevelStartTime=a.currentTime),i.checkReStartTimer(),i._isEnded(),a.isSeeking&&(a.isSeeking=!1),!i.useVideoLoad&&n&&i._removeBuffEndTime>0&&a.currentTime>i._removeBuffEndTime+1&&(i.log(g._.LOG,"remove old bitrate buffer,0 - ".concat(i._removeBuffEndTime)),i.removeBuffer(E.VIDEO,0,i._removeBuffEndTime-1),i._removeBuffEndTime=0),a.currentTime>=(null===(e=i._definitionChangePointInfo)||void 0===e?void 0:e.changeStartTime)&&(i.needStarLoadFirstSegment=!0,(0,A.u8)()&&(i.log(g._.LOG,"definitionChangePointInfo update \n        changeDefinitionSeekState = 2 \n        ".concat(a.currentTime)),a.changeDefinitionSeekState=2)),i._definitionChangePointInfo&&a.currentTime>i._definitionChangePointInfo.changeStartTime&&(a.emit(d.AFTER_DEFINITION_CHANGE,i._definitionChangePointInfo.changeInfo),i.log(g._.LOG,d.AFTER_DEFINITION_CHANGE,", currentTime,",a.currentTime,",from ",null===(t=i._definitionChangePointInfo)||void 0===t||null===(t=t.changeInfo)||void 0===t||null===(t=t.from)||void 0===t?void 0:t.definition," to ",null===(r=i._definitionChangePointInfo)||void 0===r||null===(r=r.changeInfo)||void 0===r||null===(r=r.to)||void 0===r?void 0:r.definition),i._definitionChangePointInfo=null),!i.useVideoLoad&&null===i._requestTimer&&(i._offineLine||i._cancelLoading||i._startProgress()),i._lastBufferPoint=a.bufferedPoint}),(0,r._x)(i,"_onBufferedReset",function(){i.mp4&&i.mp4.videoTrak&&i.mp4.resetFragmentLoadState(0)}),(0,r._x)(i,"_onOnlineHandler",function(){i._offineLine=!1;var e=i.playerConfig,t=i.player,r=t.currentTime,n=t.paused;i.log(g._.LOG,"online useVideoLoad:",i.useVideoLoad,i._hasStartProgressBack),i.useVideoLoad?(i.__onmetadataHandle=function(){r&&(t.currentTime=r),i.log(g._.LOG,"onOnlineHandler update currentTime",e.vid,i.codecType,i._currentTime),n?t.pause():t.play(),t.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},t.video.addEventListener("loadedmetadata",i.__onmetadataHandle),i._setPlayerSrc(e.url)):(i._hasStartProgressBack&&i._startProgress(),i._hasStartProgressBack=!1)}),(0,r._x)(i,"_onOfflineHandler",function(){i._offineLine=!0,i.log(g._.LOG,"offline, ",i._hasStartProgress),i._hasStartProgress&&(i._stopProgress(),i._hasStartProgressBack=!0)}),(0,r._x)(i,"_loadDataSuccess",function(e){if(!i.isDestroy&&(!!i.mse||!!i.mseProxy)){try{e.initSeg&&(i._appendInitSeg(e.initSeg),(!e.buffer||e.buffer.byteLength<1)&&i._onTimeUpdate());var t=e.buffer,r=e.state,n=e.context,a=e.videoTrack,o=e.audioTrack;if(i.debugInfo.loadIndx=n?n.fragIndex:-1,i.mse&&r&&(!t||(null==t?void 0:t.byteLength)<=0)&&null!==(d=i.mp4)&&void 0!==d&&d.checkIsLoadEnd(null===(f=n.range)||void 0===f?void 0:f[1])){var s=i.player.buffered;i._loadedEnd=!0;var l=0;s&&(null==s?void 0:s.length)>0&&(l=s.end(s.length-1)),i._isEnded(),i.log(g._.LOG,"loaded ended !!!==>>>","range: ".concat(JSON.stringify(n.range)),"fragIndex: ".concat(n.fragIndex),"bufferEndTime: ".concat(l),"meta_duration: ".concat(i.mp4.meta.duration))}if(t&&i.mse){if(t&&(null==t?void 0:t.byteLength)>0){i._appendBuffer(E.VIDEO,t,n,r);var u=i.getDataBitRate(n.fragIndex);i.player.emit("addVideoBufferEnd",{start:Math.floor(n.startPts),end:n.endPts,bandwidth:u.bitrate})}}else if(i.mseProxy&&(a&&a.samples.length>0||o&&o.samples.length>0)){if(a.editListApplied){var d,f,h,p=a.editList,v=a.samples,m=0;(null==p||null===(h=p.entries)||void 0===h?void 0:h.length)>0&&(m=p.entries[0].media_time),v.forEach(function(e){e.dts+=m,e.pts+=m,e.originDts+=m,e.originPts+=m}),a.baseMediaDecodeTime+=m}i.log(g._.LOG,"[xgvideo] append","index: ".concat(n.fragIndex),"range: ".concat(JSON.stringify(e.context.range)),"timeRange: ".concat(n.timeRange)),i.mseProxy.appendBuffer(a,o)}}catch(e){i.changeState("APPEND_DATA_ERROR",{errMsg:null==e?void 0:e.message});var _=new c.ZP(i.player,{errorType:C.iR.MEDIA,errorCode:C.O1.mseAppend,vid:i.playerConfig.vid,errorMessage:e.message,mediaError:{code:C.O1.mseAppend,message:e.message}});i._errorHandler(_)}null!=e&&e.state&&i._onTimeUpdate()}}),(0,r._x)(i,"_onResumePlaying",function(){i._resumePlay=!0}),(0,r._x)(i,"_seekOnce",function(e){var t=i.player;if(!!t)t.currentTime=e+.1*Math.pow(2,i._currentSeekTimes||0),i._currentSeekTimes++,i.log(g._.LOG,"当前第".concat(i._currentSeekTimes,"次Seek，currentTime=").concat(null==t?void 0:t.currentTime))}),(0,r._x)(i,"_onWaiting",function(){i.checkReStartTimer(),i._isEnded();var e,t=JSON.stringify(i.getAllBufferRange());i.changeState("waiting",{curtime:i.player.currentTime,buffer:t});var r=i.player,n=i.config,a=i.playerConfig,o=i.mp4;clearTimeout(i._waitInBufferTimer),i._waitInBufferTimer=null;var s=r.currentTime;i.log(g._.LOG,",[onWaiting],curTime, ",s,",buffer,",t,",dur,",null==o||null===(e=o.meta)||void 0===e?void 0:e.duration);var l=r.bufferedPoint;l.end>0&&(l.end-s>=2||i._loadedEnd)?i._waitAdjustTimeCnt<n.waitJampBufferMaxCnt?i._waitInBufferTimer=setTimeout(function(){i._waitAdjustTimeCnt++,i.changeState("waitInBuffer_seek",{waitAdjustTimeCnt:i._waitAdjustTimeCnt,curTime:s}),r.currentTime=r.currentTime+.5},n.waitingInBufferTimeOut):i._errorHandler(new c.ZP(i.player,{errorType:C.iR.RUNTIME,errorCode:C.O1.waitTimeout,errorMessage:"onWaitTimeout_in_buffer",vid:a.vid})):i._loadStuckCheck()}),(0,r._x)(i,"_onEnded",function(){i.log(g._.LOG,"[player.onEnded], stopProgress"),i._stopProgress()}),(0,r._x)(i,"_errorHandler",function(e){i._setPlayerError(e);var t=i.player,n=i.playerConfig,o=i.preLoadData;if(!!t&&!i.useVideoLoad){if(e.errorCode===C.O1["403"]&&i._emitExpireEvent(e)&&i.config.urlExpireDisableErrorEvent){i.log(g._.LOG,"_errorHandler urlExpireDisableErrorEvent",i.config.urlExpireDisableErrorEvent,",errorCode,",e.errorCode),i._stopProgress(),i.emit(H);return}if("object"!==(0,r.Ac)(e)){var s={};s.err=e,e=s}!e.ext&&(e.ext={});var l=t.paused;if(e.ext.vid=n.vid,e.ext.preloadHit=i.hitpreload?1:0,e.ext.preloadCached=o?o.duration:0,e.ext.timerStep=Math.max.apply(Math,(0,r.u)(i.timerStepList)),e.ext.codectype=i.codecType,e.message&&(e.errorMessage=e.message),e=new c.ZP(t,e),i.log(g._.ERROR,"_errorHandle","preState is ".concat(l),null===(u=e)||void 0===u?void 0:u.errorCode,e.errorMessage),e.url||(e.url=t.src),i.player.emit("playCatch",i.player.vtype,e),e.errd&&"object"===(0,r.Ac)(e.errd)&&i.mp4&&(e.errd.url=i.mp4.url,e.url=i.mp4.url),i.emit("DATA_REPORT",e),i.mp4&&i.mp4.cancelLoading(),i._abrService&&i._abrService.disable(),i.canDownload=!1,i.checkIsDegraded(e))i.player.vtype=a.l0.MP4_2,i._initPromise&&i.removeAndRejectInitPromise(e),i._startDegradedPlayback(e,l);else{i.log(g._.ERROR,"final error !!!!, ",n.vid,null===(d=e)||void 0===d?void 0:d.errorCode,null===(f=e)||void 0===f?void 0:f.errorMessage),i.player.pause(),i._reset(),i.states=[];var u,d,f,h,p,v=t.currentTime;i.destroyMSE(),t.currentTime=v,i.emit("error",e),i._setStartTimelines(a.l1.PLAY_ERROR,{message:null===(h=e)||void 0===h?void 0:h.message,httpCode:null===(p=e)||void 0===p?void 0:p.errorCode})}i.emit(H)}}),(0,r._x)(i,"_onSourceError",function(e){if(!i._hasFirstFramed){if(!(null!==(t=e.message)&&void 0!==t&&t.includes("PCDN"))){var t,r,n,o,s="".concat(i.player.vtype,"-host:").concat(null==e?void 0:e.host,"-").concat(null==e?void 0:e.errorCode,"-").concat(null!==(r=null==e||null===(n=e.mediaError)||void 0===n?void 0:n.message)&&void 0!==r?r:null==e?void 0:e.message);i._setStartTimelines(a.l1.HTTP_ERROR,{message:s,httpCode:null==e?void 0:e.errorCode}),null===(o=i._startTimelines)||void 0===o||null===(o=o.httpError)||void 0===o||o.push({message:s,httpCode:null==e?void 0:e.errorCode})}}}),(0,r._x)(i,"_onSeeking",(0,r.x)((0,r.l5)().mark(function e(){var t,n,a,o,s,l,u,d,c,f,h,p,v,m,_,y;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i._isReceiveEndedEvent=!1,!i.useVideoLoad){e.next=3;break}return e.abrupt("return");case 3:if(a=(n=i).player,o=n.mp4,s=n.mse,l=n.config,3!==a.changeDefinitionSeekState){e.next=8;break}return a.changeDefinitionSeekState=void 0,i.log(g._.LOG,"[seeking] changeDefinitionSeekState clear"),e.abrupt("return");case 8:if(u=a.currentTime,d=a.bufferedPoint,i.waitLevelStartTime=u,i.changeState("seeking",{curTime:u,buffered:d,lastBuffered:i._lastBufferPoint}),i.log(g._.LOG,"[seeking], curTime: ".concat(u,", duration: ").concat(null==o||null===(t=o.meta)||void 0===t?void 0:t.duration),"buffer: ".concat(JSON.stringify(i.getAllBufferRange()))),!(!o||!o.meta)){e.next=15;break}return e.abrupt("return");case 15:if(i._startProgress(),o.bufferUsedPos=0,o.metaLoading=!1,i._loadedEnd=!1,i._definitionChangePointInfo&&(i._definitionChangePointInfo.changeStartTime=u,i.log(g._.LOG,"[seeking update definitionChangePointInfo]",u)),o.changeBitRateTime>0&&(o.updateChangeBitRateTime(u),i.log(g._.LOG,"[seeking update changeBitRateTime]",u)),c=0,!(d.end>0)){e.next=30;break}if(!i.isSeekingInSameBuffer(u,d)){e.next=26;break}return i.log(g._.LOG,"[seeking in buffered], linear buffer,",d.end),e.abrupt("return");case 26:o.seekTime=d.end,i.log(g._.LOG,"[seeking in buffered], but jump to another piece: ".concat(d.start,"-").concat(d.end)),e.next=32;break;case 30:o.seekTime=u,i.log(g._.LOG,"[seeking out buffered], seekTime: ".concat(u));case 32:return f=o.getFragmentIdx(o.seekTime),c=(h=i.getAdaptTimeRangeIdx(f))<0?i._curLoadSegmentIdx:h,o.seekTime===u&&null!=s&&s.isFull()&&(v=(p=i.getAllBufferRange())[p.length-1],i._checkRemovePlayedBuffer([v.start,v.end],u,!0,!0)),i.log(g._.LOG,"[seekTime resetFragmentLoadState], adaptIdx: ".concat(c)),o.resetFragmentLoadState(c),null==s||s.clearOpQueues(E.VIDEO),1===a.changeDefinitionSeekState?null===(m=i.mse)||void 0===m||m.remove(E.VIDEO,0,1/0).then(function(){a.changeDefinitionSeekState=2,i.log(g._.LOG,"[seeking], changeDefinitionSeek remove buffer end, changeDefinitionSeekState = 2")}):l.removeBufferAtSeek&&(_=o.seekTime,y=1/0,i.log(g._.LOG,"[seeking mse remove], ".concat(_,"-").concat(y)),null==s||s.remove(E.VIDEO,_,y)),i.canDownload=!1,e.next=43,o.cancelLoading();case 43:i.canDownload=!0,o.fillFirstSegment=!1,i._curLoadSegmentIdx=c,i._onTimeUpdate(),i._isEnded();case 48:case"end":return e.stop()}},e)}))),i.initLog(null===(t=i.player.playerId)||void 0===t||null===(t=t.toString())||void 0===t?void 0:t.slice(-4)),i.log(g._.LOG,"plugin version: ".concat(N.i),"playerId: ".concat(i.playerId),"vid: ".concat(i.playerConfig.vid)),i._pendingPromises=[],i._allInitPromise=new M.Z,i._isInit=!1,i._isEventInit=!1,i.preloader=null,i._useVideoLoad=!1,i.mse=null,i.mp4=null,i.eme=null,i._isMseInit=!1,i._corePromise=null,i._initPromise=null,i._hasStartProgress=!1,i._hasStartProgressBack=!1,i._curLoadSegmentIdx=0,i._abrService=null,i._checkRemoveBufferLastTime=w.Z.nowTime(),i.playFlag=!1,i.config.resumePlayWaterLevel=Math.min(i.config.minBufferLength,i.config.resumePlayWaterLevel),i.checkResumePlayTimer=null,i._MSEError=!1,i._waitAdjustTimeCnt=0,i._waitInBufferTimer=null,i.isActive=!0,i.debugInfo={},i.states=[],i.removeVideoList=[],i._lastCheckTime=w.Z.nowTime(),i._lastCheckLagTime=w.Z.nowTime(),i._changeDefState=null,i._defInited=!1,i._removeBuffEndTime=0,i._lastTimeupdateTime2=0,i.waitLevelStartTime=-1,i.preLoadData=null,i.forPreloadTimeCache=null,i._usePaused=!1,i.hitpreload=!1,i.isH265DegradeH264=!1,i.loadstartTimer=null,i.loadeddataTimer=null,i.canplayTimer=null,i.adaptRangeRes=[],i._isReceiveEndedEvent=!1,i._checkEndedTimer=null,i._definitionChangePointInfo=null,i._lastTimeupdateTime2=0,i.waitLevelStartTime=-1,i.timerStepList=[],i._isH265SoftDecoder=!1,i._beforeLoadStartCostTime=0,i._requestTimer=null,i.firstFrameCostTime={},i._mediaCodec={videoCodec:"",audioCodec:""},i._setTimelineData(),i._updatePropsByConfig(),i.player._customExpiryCheck=i.config.enableCusExpiryCheck,i}return(0,r.XW)(k,e),(0,r.qH)(k,[{key:"_setTimelineData",value:function(){this._startTimelines={startstage:-1,startmessage:"",httpCode:-1,httpError:[],reqtime:-1,downgradetime:-1,fcost:-1,ffcost:-1,startbufferlength:-1,playerError:"",startdelta:-1,loadstarttime:-1,loadeddatatime:-1,loadstarttype:-1,loadeddatatype:-1,playtime:-1,playerstate:-1},this._hasFirstFramed=!1}},{key:"setConfig",value:function(e){this.config=Object.assign(this.config,e),this._updatePropsByConfig()}},{key:"_updatePropsByConfig",value:function(){this._maxBufferLength=this.config.maxBufferLength,this._minBufferLength=this.config.minBufferLength,this._nextBufferLength=this.config.nextBufferLength,this._switchBitRateWay=this.config.switchBitRateWay,this._tickInSeconds=this.config.tickInSeconds||R._X}},{key:"initLog",value:function(e){var t=this.config.logCacheConfig,i=t.logCacheLevel,r=t.logMaxSize;this.logger=new g.Y(k.pluginName+e,{logCacheLevel:i,logMaxSize:r}),B.i5&&g.Y.enable()}},{key:"playerlogger",value:function(e){e?g.Y.enable():g.Y.disable()}},{key:"_setStartTimelines",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this._hasFirstFramed&&this._startTimelines){this._startTimelines.startstage=e,this._startTimelines.startmessage="".concat(a.sm[e]||"","-").concat((null==t?void 0:t.message)||"");var i=this._startTimelines.httpCode;this._startTimelines.httpCode=-1!==i?i:(null==t?void 0:t.httpCode)||-1,e===a.l1.PLAYER_ERROR&&(this._startTimelines.playerError=(null==t?void 0:t.message)||"")}}},{key:"afterCreate",value:function(){var e=this,t=this.playerConfig,i=this.config,n=this.player;if(i.width=t.width||0,i.height=t.height||0,t.vid=t.vid||i.vid,"object"!==(0,r.Ac)(i.reqParams)&&(i.reqParams={}),!E.isSupported('video/mp4; codecs="avc1.64001E, mp4a.40.5"')){this._setStartTimelines(a.l1.NOT_SUPPORTED);return}void 0===i.supportHevc&&null!==f.Z&&void 0!==f.Z&&f.Z.isHevcSupported&&f.Z.isHevcSupported()&&this.player.video instanceof HTMLVideoElement&&(i.supportHevc=!0),i.supportVvcc=(0,A.E0)(),this.softDecode?n.vtype=a.l0.MP4_MSE_SOFT:n.vtype=a.l0.MP4_MSE,(!(0,A.KI)()||this.softDecode)&&(i.useEME=!1),i.useEME=!1!==i.useEME,this.checkConfig(),i.onlyInit&&(t.autoplay=!1,t.videoInit=!1,this._hasStartProgress=!1,this._hasStartProgressBack=!1),t.useWaterLevel&&(t.userGestureEventMiddleware||(t.userGestureEventMiddleware=I.Ru),t.videoEventMiddleware||n.setEventsMiddleware(I.f4)),this._proxyPlayer(),n.useHooks("replay",this._replayHook),n.useHooks("play",this._playHook),n.useHooks("pause",this._pauseHook),n.useHooks("retry",this._retryHook),this.on("source_error",this._onSourceError),this.on("error",this._onSourceError),n.video.addEventListener(R.fD.BUFFERED_RESET,this._onBufferedReset),this._bindNetworkStateChange(),this.on(d.TIME_UPDATE,this._onVideoTimeUpdate),this.on(d.LOADED_DATA,function(){var t;-1===e._startTimelines.loadeddatatime&&(e._startTimelines.loadeddatatime=w.Z.nowTime(),e._startTimelines.loadeddatatype=n.vtype===a.l0.MP4_MSE?1:2),e.loadedDataEventRev=!0,e.changeState("LOADED_DATA"),e.deleteVideo(),e.mp4&&e.mp4.updateLoadedDataDone(),e._onTimeUpdate(),null!==(t=e.config)&&void 0!==t&&t.enableFPSStuckHandle&&e.on(d.FPS_STUCK,e.fpsStuckHandle)}),this.on(d.LOAD_START,function(){e.changeState("LOAD_START"),e._beforeLoadStartCostTime=new Date().getTime()-e._tm,e.log(g._.LOG,"mp4plugin loadstart",e._beforeLoadStartCostTime),-1===e._startTimelines.loadstarttime&&(e._startTimelines.loadstarttime=w.Z.nowTime(),e._startTimelines.loadstarttype=n.vtype===a.l0.MP4_MSE?1:2),e.codecType===a.u7.H265&&!e.config.supportHevc&&(e._isMseInit=!0,e._onTimeUpdate())}),this.on(d.ENDED,function(){e.log(g._.LOG,"mp4plugin receive player video ended event"),e._onEnded()}),this.on(d.PAUSE,function(){e._usePaused=!0}),this.on(d.PLAY,function(){e._usePaused=!1}),this.on(d.AUTOPLAY_STARTED,function(){e._startTimelines&&(e._startTimelines.playtime=w.Z.nowTime())}),this.on("xglog",function(t){if("firstFrame"===t.eventType){var i=e.preLoadData&&e.preLoadData.definition?e.preLoadData.definition:-1,r=e.player;e._startTimelines.fcost=w.Z.nowTime()-e._startTimelines.reqtime,e._startTimelines.ffcost=t.fvt,e._hasFirstFramed=!0,e.log(g._.DEBUG,"[xgplayer-encrypt-mp4]>>>>firstFrame ".concat(e.playerConfig.vid,", ").concat(t.fvt,", codecType: ").concat(e.codecType),"hitPreload: ".concat(e.hitpreload,", video: ").concat(e._useVideoLoad,", preloadBitrate: ").concat(i),"curDefinition: ".concat(r.curDefinition.definition))}}),n.mp4MseFlag=!0}},{key:"_startBufferCheck",value:function(){var e=this.player;if(!e.video)return;var t=[];if(!!e.video.buffered){for(var i=0,r=e.video.buffered.length;i<r;i++)t.push([e.video.buffered.start(i),e.video.buffered.end(i)]);t.toString()!==this.lastBuffer&&(this.lastBuffer=t.toString(),this._onBufferReachThreshold())}}},{key:"_onBufferReachThreshold",value:function(){var e=this.player,t=this.config;if(e.video){for(var i=e.video.buffered,r=0,n=0,a=0;a<i.length&&(r=i.start(a),n=i.end(a),!(r<=e.video.currentTime)||!(e.video.currentTime<=n));a++);n-e.video.currentTime>=t.bufferThreshold&&!this._hasTriggerBufferThreshold&&(this._hasTriggerBufferThreshold=!0,e.emit("BUFFER_THRESHOLD",n-e.video.currentTime))}}},{key:"_startUrlExpiredCheck",value:function(){var e,t,i,r=this.player;if(null!==(e=this.expiryCheckPlugin)&&void 0!==e&&null!==(e=e.config)&&void 0!==e&&e.useCdnExpiryTime){null===(t=(i=this.expiryCheckPlugin).handleUrlExpiryCheckByCdnPath)||void 0===t||t.call(i);return}var n=r.config;n.definition&&n.definition.list&&n.definition.list.length>0&&(this.urlExpireTimestamp=n.definition.list[0].url_expire||0,this._handleUrlExpire())}},{key:"cancelLoading",value:(t=(0,r.x)((0,r.l5)().mark(function e(){var t,i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.mp4){e.next=2;break}return e.abrupt("return");case 2:return this._cancelLoading=!0,this.log(g._.LOG,"player cancelLoading",this.playerConfig.vid),this._stopProgress(),null===(t=this.preloader)||void 0===t||null===(i=t.cancelLoading)||void 0===i||i.call(t),e.next=8,this.mp4.cancelLoading();case 8:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"checkConfig",value:function(){var e=this.playerConfig,t=this.config,i=e.defaultDefinition,r=e.defaultBitrate;if(!i){var n=this.playerConfig.definition;i=n&&n.defaultDefinition?n.defaultDefinition:t.definition}!r&&t.bitrate&&(r=t.bitrate),e.defaultDefinition=i,e.defaultBitrate=r}},{key:"beforePlayerInit",value:function(){var e=this,t=this.player,i=this;!this._isInit&&(h.ZP.defineGetterOrSetter(t,{__url:{get:function(){return i.mse?i.mse.url:t.config.url},configurable:!0},downloadSpeed:{get:function(){return K/8},configurable:!0},playerVersion:{get:function(){return N.i},configurable:!0},menuCodeType:{get:function(){return i.mp4&&i.mp4.meta?i.mp4.meta.videoCodec:i.codecType===a.u7.H264?"avc":"hevc"},configurable:!0},playerType:{get:function(){return"MP4"},configurable:!0},supportMenus:{get:function(){return{speed:null==t?void 0:t.mp4MseFlag,cdn:null==t?void 0:t.mp4MseFlag,resolution:null==t?void 0:t.mp4MseFlag}},configurable:!0},preloadActive:{get:function(){return e.isActive},set:function(t){e.isActive=t,e.isActive&&e._startProgress()},configurable:!0},performance:{get:function(){var t={};return e.states.forEach(function(e){t[e.state.toLowerCase()]=e.t2}),t},configurable:!0},domain:{get:function(){return i.domain},configurable:!0},loadURL:{get:function(){return i.loadURL},configurable:!0},abrInstance:{get:function(){return i.abrInstance},configurable:!0},pcdnReq:{get:function(){var e=o.e.pcdnReqCnt,t=O.Yx.pcdnDownLoadReqCnt;return{pcdn_tracker_request_cnt:e.pcdn_tracker_request_cnt,pcdn_tracker_failed_cnt:e.pcdn_tracker_failed_cnt,pcdn_download_request_cnt:t.pcdn_download_request_cnt,pcdn_download_failed_cnt:t.pcdn_download_failed_cnt}},configurable:!0},retryInfo:{get:function(){return O.Tw},configurable:!0},softDecoder:{get:function(){return e._isH265SoftDecoder},configurable:!0},logCache:{get:function(){var t,r,n;if(!!i.logger)return i.log(g._.LOG,"timerStepList, ".concat(JSON.stringify(e.timerStepList),",\n            currentTime: ").concat(null===(t=i.player)||void 0===t?void 0:t.currentTime,"\n            buffer, ").concat(JSON.stringify(i.getAllBufferRange()),",\n            state: ").concat(JSON.stringify(i.states),",\n            isActive:").concat(i.isActive,",\n            preRangeType: ").concat(null===(r=i.player)||void 0===r||null===(r=r.preloader)||void 0===r||null===(r=r._config)||void 0===r?void 0:r.loadRangeType,",\n            loadRangeType: ").concat(null===(n=i.config)||void 0===n?void 0:n.loadRangeType,",\n            Mp4EncryptPlayer version, ").concat(N.i)),i.logger.getLogCache()},configurable:!0},pcdnVVStat:{get:function(){var e,t=i.mp4,n=i.pcdn;return t?(0,r.Zj)((0,r.Zj)({},t.pcdnVVStat),{},{trace_id:null===(e=t.pcdnTraceInfo)||void 0===e?void 0:e.trace_id,cancelCnt:(null==t?void 0:t.pSCCancelCnt)||0,is_try_open:n?1:0}):null},configurable:!0},beforeLoadStartCostTime:{get:function(){return e.useVideoLoad?0:e._beforeLoadStartCostTime},configurable:!0},mediaCodec:{get:function(){return e._mediaCodec},configurable:!0},bandwidth:{get:function(){var e,t,n=i.mp4,a=n?n.loadInfo:null;return{vid:null===(e=i.playerConfig)||void 0===e?void 0:e.vid,cdn:{speed:null==a||null===(t=a[O._R.CDN])||void 0===t?void 0:t.loadSpeed,size:a&&a[O._R.CDN]?a[O._R.CDN].loadLen:0},pcdn:(0,r.Zj)({size:a&&a[O._R.PCDN]?a[O._R.PCDN].loadLen:0},null==n?void 0:n.pcdnTraceInfo)}},configurable:!0},ext:{get:function(){var e,t,r,n,a,o,s,l,u=[];if((null===(e=i.player)||void 0===e||null===(e=e.video)||void 0===e||null===(e=e.buffered)||void 0===e?void 0:e.length)>0){for(var d=i.player.video.buffered,c=0,f=(null==d?void 0:d.length)||0;c<f;c++)u.push([d.start(c),d.end(c)])}return{type:"MP4",version:N.i,usevideo:i.useVideoLoad?1:0,curTime:null===(t=i.player)||void 0===t?void 0:t.currentTime,duration:(null===(r=i.mp4)||void 0===r||null===(r=r.meta)||void 0===r?void 0:r.duration)||(null===(n=i.player)||void 0===n?void 0:n.duration),loadIdx:i._curLoadSegmentIdx,curload:null!==(a=i.mp4)&&void 0!==a&&a.adaptTimeRange?i.mp4.adaptTimeRange[i._curLoadSegmentIdx]:{},buffer:u,speed:null===(o=i.debugInfo)||void 0===o?void 0:o.speed,states:null==i?void 0:i.states,loadRangeType:null===(s=i.config)||void 0===s?void 0:s.loadRangeType,preRangeType:null===(l=i.player)||void 0===l||null===(l=l.preloader)||void 0===l||null===(l=l._config)||void 0===l?void 0:l.loadRangeType}},configurable:!0},currentDefinitionFromPlayer:{get:function(){return i.abrInstance&&i.abrInstance.isCurrentInAbr?t._currentDefinitionFromPlayer:t.curDefinition},configurable:!0},currentDefitionFromPlayer:{get:function(){return t.currentDefinitionFromPlayer},configurable:!0},startTimelines:{get:function(){if(e._startTimelines){var i=w.Z.nowTime();e._startTimelines.startuploadtime=i;var r=t.vtype!==a.l0.MP4_MSE?e._startTimelines.downgradetime:e._startTimelines.reqtime;if(e._startTimelines.startdelta=i-r,e._startTimelines.firstframedp=e._hasFirstFramed?1:0,e._startTimelines.playerstate=t.state,!e._hasFirstFramed){var n=t.getBufferedRange();e._startTimelines.startbufferlength=n[1]-n[0],e.emit(H)}}return JSON.parse(JSON.stringify(e._startTimelines))},configurable:!0}}),this._isInit=!0)}},{key:"destroy",value:function(){var e,t,i=this.player;i.preloader&&i.preloader.removePlayingId(i.playerId),i.removeHooks("replay",this._replayHook),i.removeHooks("play",this._playHook),i.removeHooks("pause",this._pauseHook),i.removeHooks("retry",this._retryHook),null===(e=this._requestTimer)||void 0===e||e.destroy(),this._requestTimer=null,this._reset(),this.states=[],this.checkReUseMSE(!1),this._secretkey&&(this._secretkey.off(n.EVENT_EME.ERROR,this._errorHandler),this._secretkey.destroy()),this.player.playNext=V,this.player._startInit=j,this.player.changeDefinition=Z,this.player.switchURL=q,this._unbindNetworkStateChange(),this._unbindEvents(),i.video&&i.video.removeEventListener(R.fD.BUFFERED_RESET,this._onBufferedReset),this._bufferCheckTimer&&clearInterval(this._bufferCheckTimer),this._removeBufferTimer&&(clearTimeout(this._removeBufferTimer),this._removeBufferTimer=null),(null===(t=this.logger)||void 0===t?void 0:t.reset)&&this.logger.reset(),this.__onmetadataHandle&&i.video.removeEventListener("loadedmetadata",this.__onmetadataHandle),this.timerStepList=[]}},{key:"_proxyPlayer",value:function(){var e=this;"function"==typeof this.player.playNext&&(V=this.player.playNext),this.player.playNext=function(){e.playNext.apply(e,arguments)},j=this.player._startInit,q=this.player.switchURL,Z=this.player.changeDefinition,this.player._startInit=this.playerStartInit.bind(this),this.player.switchURL=this.switchURL.bind(this),this.player.changeDefinition=this.changeDefinition.bind(this)}},{key:"getInitBitrate",value:function(){var e=this.player,t=this.playerConfig,i=null,r=e.definitionList;if(r&&r.length>0){var n={},a=e.preloader;if(a){var o=a.getPreloadMetaByVid(t.vid);if(o){var s=a.getDataUniqueKey(o),l=(0,I.Vh)(o,r);l?(l.cacheKey=s,(i=l).type="preload",i.preLoadMeta=o,n={m:1,t:2,ck:s}):n={m:0,t:1,ck:s}}}else n={t:0};if(this.changeState(R.fp.PRELOAD_CHECK,n),i&&t.userSelectDefinition&&t.focusUserDefinition){var u={m:1,ud:t.userSelectDefinition,d:i.definition};t.userSelectDefinition!==i.definition&&(i=null,u.m=1),this.changeState(R.fp.USER_DEFI_CHECK,u)}!i&&this.bitRateAdapter&&(this.bitRateAdapter.speed=O.Yx.speed,(i=this.getDefinitonFromAdapter(r,t.userSelectDefinition))&&(i.type="bitRateAdapter"))}if(!i||!i.url){var d,c=(null===(d=t.definition)||void 0===d?void 0:d.defaultDefinition)||t.defaultDefinition;if("Array"===p.ZP.typeOf(t.url)&&t.url.length>0||"String"===p.ZP.typeOf(t.url)&&t.url){var f=this._getDefinitionItem(c),h=t.defaultBitrate||t.bitrate||(null==f?void 0:f.bitrate);i={url:t.url,definition:(null==f?void 0:f.definition)||c||-1,duration:(null==f?void 0:f.duration)||t.duration||this.config.duration||0,bitrate:h,uri:t.uri||(null==f?void 0:f.uri),file_id:null==f?void 0:f.file_id,size:(null==f?void 0:f.size)||t.size,type:"default"}}else i=r[r.length-1]}return this.playerConfig.url=i.url,i.networkSpeed=O.Yx.speed,e.curDefinition=i,i}},{key:"_setPlayerSrc",value:function(e){var t=this.player;this._removeVideoSource();var i="Array"===p.ZP.typeOf(e);e=i?this._processArrayUrl(e):this._processUrl(e),i?(t.video.removeAttribute("src"),t._detachSourceEvents||e.forEach(function(e){t.video.appendChild(p.ZP.createDom("source","",{src:"".concat(e.src),type:"".concat(e.type||"")}))}),t._attachSourceEvents(t.video,e)):t.video.src=e,t.play(),t.mp4MseFlag=!1,t.emit("playertypechange"),this._startTimelines.downgradetime=w.Z.nowTime()}},{key:"_removeVideoSource",value:function(e){var t=this.player,i=(e=e||t.video).children;if(i.length>0)for(t._detachSourceEvents(e);i.length>0;)e.removeChild(i[0])}},{key:"_getDefinitionItem",value:function(e){var t=this.playerConfig;if(!t.definition||!t.definition.list)return null;for(var i=0;i<t.definition.list.length;i++){var r=t.definition.list[i];if(r.definition===e)return r}return null}},{key:"_initAbrDefinition",value:function(){var e=this.player,t=this.playerConfig;if(t.definition.list.length>0&&(!e.curDefinition&&(e.curDefinition=t.definition.list[0]),!e.curDefinition.vwidth&&Object.assign(e.curDefinition,this._getDefinitionItem(e.curDefinition.definition)),this._abrService.updateAbrCacheData()),this._abrService&&this._abrService.isCurrentAutoDefi){var i=t.definition.list.length;e.curDefinition=t.definition.list[i-1]}for(var r=0;r<t.definition.list.length;r++){var n=t.definition.list[r];e.curDefinition.definition===n.definition?n.selected=!0:n.selected=!1}this.player.emit("resourceReady",t.definition.list);var a=e.curDefinition.bitrate;if(!a)for(var o=0;o<t.definition.list.length;o++){var s=t.definition.list[o];s.definition===e.curDefinition.definition&&(a=s.bitrate)}this._abrService.updateBitrate(a)}},{key:"_initAbrService",value:(i=(0,r.x)((0,r.l5)().mark(function e(){var t,i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.playerConfig,!(!(i=this.config).autoBitrateOpts||!i.autoBitrateOpts.isOpenAutoDefi)){e.next=3;break}return e.abrupt("return");case 3:return this._abrService=new b.Z(this,this.abrSwitchURL),e.next=6,this._abrService.init({video:t.definition.list.concat()});case 6:this._initAbrDefinition();case 7:case"end":return e.stop()}},e,this)})),function(){return i.apply(this,arguments)})},{key:"_initMp4Kernel",value:function(){var e=this,t=this.playerConfig,i=this.config,r=new M.Z;try{var n=this.player.curDefinition;if(this.log(g._.LOG,"[_initMp4Kernel] ".concat(t.vid," curDefinition"),null==n?void 0:n.definition),!this._handlerUrl(t.url))return this.log(g._.LOG,"emptyUrl"),r.reject(Error("emptyUrl")),r;if(i.forceVideoPlay&&(this.codecType===a.u7.H264||i.supportHevc))return this.useVideoLoad=!0,this.log(g._.LOG,"forceVideoPlay"),r.reject(Error("forceVideoPlay")),r;var o=[];this._secretkey&&o.push(this._secretkey.getLicenseSecret()),o.push(this._checkPreloader()),Promise.all(o).then(function(t){if(e.isDestroy){r.reject(Error("destroy"));return}var o=null;if(t&&t.length>0&&(t.length>1&&(!i.keyValue&&t[0].secretKey&&(i.secretKey=t[0].secretKey),i.decryptKey=t[0].decryptKey),o=t[t.length-1].data),!o&&i.needPreloadCheck&&(e.codecType!==a.u7.H265||i.supportHevc))e.useVideoLoad=!0,e.log(g._.LOG,"no_preload"),r.reject(Error("no_preload"));else if(e.vtype&&"MP3"===e.vtype)e.useVideoLoad=!0,e.log(g._.LOG,"vtype_not_MP4"),r.reject(Error("vtype_not_MP4"));else{var s,l=i._mainURL;e._initMp4(l,o,{fileSize:n?n.size:0}),e.updateLoadInfo(null===(s=o)||void 0===s?void 0:s.cacheKey),e.checkPCDN(),e.initAdaptRange(),e._initAbrService()}}).catch(function(i){e.log(g._.ERROR,"getLicense or checkPreloader reject",null==i?void 0:i.message);var a=new c.ZP(e.player,{errorType:C.iR.DRM,errorCode:C.O1.drm,errorMessage:(null==i?void 0:i.message)||"getLicense or checkPreloader reject",vid:t.vid});e.emit("GET_LICENSE_ERROR",a),e.changeState("LICENSE_ERROR",{d:n?n.definition:0}),r.reject(a)})}catch(e){r.reject(e)}return r}},{key:"updateLoadInfo",value:function(e){var t;if(!!e&&!!this.mp4)this.mp4.loadInfo=null===(t=this.preloader)||void 0===t?void 0:t.getLoadInfoAndDelete(e)}},{key:"initAdaptRange",value:function(){var e=this.config,t=this.player,i=this.playerConfig,r=t.curDefinition,n=r.bitrate,a=r.duration;null!=e&&e.adaptRange&&(this.adaptRange=new s.Q(t,n,a||i.duration,e.adaptRange))}},{key:"getPCDNReqId",value:function(){var e=this.player.curDefinition,t=this.playerConfig.vid;return e.uri?e.uri.slice(-20)+e.bitrate:t?t.slice(-20)+e.bitrate:void 0}},{key:"checkPCDN",value:function(){var e,t=this,i=this.config,r=this.player,n=this.mp4,a=r.curDefinition;if(null!==(e=i.pcdnConfig)&&void 0!==e&&e.openPCDN&&a.duration>=i.pcdnConfig.minDuration){i.pcdnConfig.app_id&&(R.tE.app_id=i.pcdnConfig.app_id),i.pcdnConfig.sid&&(R.tE.sid=i.pcdnConfig.sid);var s,l=i._mainURL;if(!a.uri||!a.bitrate||0>=l.indexOf("video/")){this.log(g._.LOG,"uri null or bitrate null or url not contain video cannot use pcdn"),this.pcdn=null;return}!(0,I.Pj)(l)&&(l=document.location.protocol+l);var u={vid:a.uri,sfid:a.file_id,cdn_url:l,file_type:null===(s=this.vtype||"MP4")||void 0===s?void 0:s.toLowerCase(),bitrate:a.bitrate,duration:Math.floor((null==a?void 0:a.duration)||0),size:(null==a?void 0:a.size)||w.Z.getFileSize(a.bitrate,a.duration)};if(this.pcdn)this.pcdn.resetTrackeArgs();else{var d=Object.assign({},{productConfig:R.tE},i.pcdnConfig),c=u.bitrate,f=u.duration;this.pcdn=new o.e(d,r,c,f)}this.pcdn.fetchPCDNNode(null,u,this.getPCDNReqId()).then(function(e){var i,r,a=t.getPCDNReqId();if(null!=e&&e.req_id&&a!==e.req_id){t.log(g._.LOG,",fetchPCDNNode is not match curDefinition reqId",a,", pcdnRet.req_id",e.req_id);return}n&&e&&(t.log(g._.LOG,"".concat(t.playerConfig.vid," get peer end,pcdn node update,"),null==e||null===(i=e.nodes)||void 0===i?void 0:i.length),n.updateNode(null==e?void 0:e.nodes),n.pcdnTraceInfo={uri:e.vid,fid:e.fid,trace_id:null==e?void 0:e.trace_id},n.pcdnVVStat&&(n.pcdnVVStat.try_req_node+=1,n.pcdnVVStat.req_node_succ+=1,n.pcdnVVStat.has_ret_node+=(null==e||null===(r=e.nodes)||void 0===r?void 0:r.length)>0?1:0))}).catch(function(e){(null==n?void 0:n.pcdnVVStat)&&(n.pcdnVVStat.try_req_node+=1),t.checkURLExpired(e,"_fetchPCDNNode")})}else this.pcdn=null}},{key:"initTimer",value:function(){if(!this._requestTimer){var e=this.config.timerInWorker;this._requestTimer=new D.f({frequency:this._tickInSeconds,timerInWorker:e}),this._requestTimer.on(R.sW,this.timerHandle)}}},{key:"playerStartInit",value:(u=(0,r.x)((0,r.l5)().mark(function e(t){var i,o,s,l,u,f,h,v,m,_,y,T,S,k,b,L,D,O,x,P,A,B,M,N,F,G,V,j,Z=this;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log(g._.LOG,"playerStartInit",this.player.hasStart,this.playerId,t),!this.isDestroy){e.next=4;break}return this._setStartTimelines(a.l1.START_INIT_DESTROY),e.abrupt("return");case 4:if(i=this.playerConfig,o=this.player,s=this.config,this.states=[],this._sTime=w.Z.nowTime(),this._lastBufferPoint=void 0,this._usePaused=!1,this.isActive&&(null==o?void 0:o.currentTime)!==0&&(this.log(g._.LOG,"[playerStartInit] reset current  = 0 ,buffer,",JSON.stringify(null==o||null===(l=o.buffered2)||void 0===l?void 0:l.bufferedList)),this.player.currentTime=0),this._isH265SoftDecoder=this.softDecode,s.reUseMSE&&this.mse&&"String"===p.ZP.typeOf(t)&&/^blob/.test(t)&&t!==this.mse.url&&(t=i.url,this.destroyMSE()),(!t||"__auto__"===t||"anytext"===t)&&(u=i.definition)&&u.list&&u.list.length>0&&u.defaultDefinition&&(u.list.map(function(e){e.definition===u.defaultDefinition&&(i.url=e.url,Z.player.curDefinition=e)}),(!i.url||"__auto__"===t||"anytext"===t)&&(t=(f=u.list[0]).url,i.url=f.url,u.defaultDefinition=f.definition,this.player.curDefinition=f)),this.initTimer(),h=o.oldBit,v=this._defInited?null:this.getInitBitrate(),o.oldBit=null==o||null===(V=o.curDefinition)||void 0===V?void 0:V.bitrate,!(!o.changeDefinitionFlag&&h&&h!==(null==o||null===(j=o.curDefinition)||void 0===j?void 0:j.bitrate))){e.next=23;break}if(!this.mp4){e.next=22;break}return this.canDownload=!1,e.next=22,this.mp4.cancelLoading();case 22:if(this.mse){this.once(d.LOAD_START,function(){Z.log(g._.LOG,"playerStartInit changeBtrate changeDefinitionSeekState = 1, currentTime += 0.001"),o.changeDefinitionSeekState=1,Z.player.currentTime+=.001});try{this.mse.clearOpQueues(E.VIDEO),this.mseAbort(),this.mse.remove(E.VIDEO,0,1/0).then(function(){Z.log(g._.LOG,"playerStartInit remove all buffer end")})}catch(e){this.log(g._.LOG,"playerStartInit mse func err, ".concat(null==e?void 0:e.message))}}case 23:if(o.changeDefinitionFlag=void 0,_=(m=this.config).kid,y=m.drmKeyToken,T=m.secretKey,S=m.keyValue,k=m.drm,_||y||T||S||k?this._secretkey?this._secretkey.updateConfig(this.config):(this._secretkey=new n.XGSecretKey(this.config),this._secretkey.on(n.EVENT_EME.ERROR,this._errorHandler)):this._secretkey=null,this._defInited=!0,this.log(g._.LOG,"[playerStartInit] ".concat(i.vid," curDefinition"),v||this.player.curDefinition),L=(b=this.player).preloader,D=b.playerId,L&&L.addPlayingId(i.vid,D),s.needPreloadCheck&&!this.softDecode&&!this._secretkey&&(O=!1,x="",L&&(P=this.player.curDefinition,A=(0,I.F5)(P),B=L.hasItemSameVid(A),x=L.getDataUniqueKey(A),B&&(O=!0)),!O&&(M=L?"no preload data":"no preloader",this.useVideoLoad=!0,this.player.vtype=a.l0.MP4_0,this._setStartTimelines(a.l1.NO_PRELOAD,{message:a.l0.MP4_0}),this.log(g._.LOG,"[playerStartInit] ".concat(i.vid," ").concat(M),!!L),N=new c.ZP(this.player,{errorType:"runtime",errorTypeCode:C.iR.runtime,errorCode:C.O1.other,vid:this.playerConfig.vid,errorMessage:M}),this.changeState(R.fp.PRELOAD_MATCH,{m:0,ck:x}),this.player.emit("playCatch",this.player.vtype,N))),!this.useVideoLoad){e.next=39;break}if(t=this.playerConfig.url,!s.closeDowngrade){e.next=36;break}return this._setStartTimelines(a.l1.CLOSE_DWNGRADE,{message:"isDestroy"}),e.abrupt("return");case 36:return this._playerStartInitCall(t),this._startProgress(),e.abrupt("return");case 39:if(!this.isDestroy){e.next=42;break}return this._setStartTimelines(a.l1.START_INIT_DESTROY,{message:"isDestroy"}),e.abrupt("return");case 42:this.player.mp4MseFlag=!0,this._tm=new Date().getTime(),this._reset(),F=this.playerConfig.vid,this.changeState("PLAYER_START_INIT"),G=this._initMp4Kernel(),this._initPromise=G,this._addPendingPromise(this._initPromise),G.then(function(){if(Z.isDestroy){Z._setStartTimelines(a.l1.START_INIT_DESTROY,{message:"then destroy"});return}Z.mse&&(t=Z.mse.url),Z.changeState("PLAY_INIT_OK"),Z._bindEvents(),Z._startProgress()}).catch(function(e){var i,r,n=!!Z._initPromise&&Z._initPromise.isBreak;if(Z.isDestroy||n||e===U){var o="isDestroy:".concat(Z.isDestroy,",isBreak:").concat(n,",e:").concat(e);Z._setStartTimelines(a.l1.INIT_PROMISE_CATCH,{message:o});return}if(Z.log(g._.LOG,"_initMp4Kernel.catch: ".concat(F," isDestroy:").concat(Z.isDestroy,",\n          errorCode:").concat((null==e?void 0:e.errorCode)||C.O1.other,",errMsg:").concat((null==e?void 0:e.errorMessage)||(null==e?void 0:e.message))),(null==e?void 0:e.errorCode)===C.O1["403"]&&(Z._setStartTimelines(a.l1.HTTP_ERROR,{message:"request 403",httpCode:403}),Z._emitExpireEvent(e)&&s.urlExpireDisableErrorEvent)){Z._initPromise=null,Z.log(g._.LOG,"initMp4Kernel urlExpireDisableErrorEvent",s.urlExpireDisableErrorEvent,",errorCode,",e.errorCode),Z._stopProgress(),Z.emit(H);return}var l=e;!l.errorCode&&((l=new c.ZP(Z.player,{errorType:C.iR.RUNTIME,errorCode:(null==e?void 0:e.errorCode)||C.O1.other,vid:Z.playerConfig.vid,errorMessage:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),mediaError:{code:(null==e?void 0:e.httpCode)||C.O1.other,message:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),errorType:null==e?void 0:e.errorType}})).url=t),Z._setStartTimelines(a.l1.INIT_PROMISE_CATCH,{message:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message)}),Z.changeState("PLAY_INIT_CATCH",{c:l.errorCode,m:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),t:null==e?void 0:e.errorType}),Z.useVideoLoad=!0,Z.player.vtype=a.l0.MP4_1,Z.player.emit("playCatch",Z.player.vtype,l);var u=Z.checkIsDegraded(l);if(Z.log(g._.WARN,"PLAY_INIT_CATCH final error !!!!, ",F,null===(i=l)||void 0===i?void 0:i.errorCode,null===(r=l)||void 0===r?void 0:r.errorMessage,",degrade:",u),Z.emit(H),!u){Z.player.pause(),Z._reset(),Z.states=[],Z.emit("error",l),Z._initPromise=null;return}}).finally(function(){if(!!Z._initPromise){var e,i=Z._initPromise.isBreak;Z._initPromise&&Z._removePendingPromise(Z._initPromise),Z._initPromise=null,Z._usePaused&&(Z.playerConfig.autoplay=!1),Z.softDecode&&"Array"===p.ZP.typeOf(t)&&(t=t[0].src),"String"===p.ZP.typeOf(t)&&!/^blob/.test(t)&&Z.destroyMSE();var r=(null===(e=Z.player)||void 0===e?void 0:e.currentSrc)===t;Z.changeState("PLAY_INIT_FINALLY",{isDestroy:Z.isDestroy,isBreak:i,reUseSrc:r}),Z.isDestroy||i||Z._playerStartInitCall(t),Z.reUseMSEEmitEvents(r),Z._abrService&&Z._abrService.isCurrentInAbr()&&(Z._abrService.enable(),Z._abrService.execute())}});case 51:case"end":return e.stop()}},e,this)})),function(e){return u.apply(this,arguments)})},{key:"_playerStartInitCall",value:function(e){e="Array"===p.ZP.typeOf(e)?this._processArrayUrl(e):this._processUrl(e),j.call(this.player,e),this._startTimelines.downgradetime=w.Z.nowTime()}},{key:"destroyMSE",value:function(){var e=this;if(!!this.mse)try{this.mse.clearOpQueues(E.VIDEO);var t=this.mse.abort();if(!t)return;t.then((0,r.x)((0,r.l5)().mark(function t(){var i,n;return(0,r.l5)().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,null===(i=e.mse)||void 0===i?void 0:i.unbindMedia();case 2:e.mse&&e.log(g._.LOG,"destroyMSE ",null===(n=e.playerConfig)||void 0===n?void 0:n.vid),e.mse=null;case 4:case"end":return t.stop()}},t)}))).catch(function(){})}catch(e){}}},{key:"reUseMSEEmitEvents",value:function(e){var t,i=this;e&&/^blob/.test(null===(t=this.player)||void 0===t?void 0:t.currentSrc)&&(clearTimeout(this.loadstartTimer),clearTimeout(this.loadeddataTimer),clearTimeout(this.canplayTimer),this.loadstartTimer=setTimeout(function(){clearTimeout(i.loadstartTimer),i.loadstartTimer=null,i.emit(d.LOAD_START),i.log(g._.LOG,"reUseMSE add emit loadstart event")},10),this.loadeddataTimer=setTimeout(function(){clearTimeout(i.loadeddataTimer),i.loadeddataTimer=null,i.emit(d.LOADED_DATA),i.log(g._.LOG,"reUseMSE add emit loadeddata event")},50),this.canplayTimer=setTimeout(function(){clearTimeout(i.canplayTimer),i.canplayTimer=null,i.emit(d.CANPLAY),i.log(g._.LOG,"reUseMSE add emit canplay event")},90))}},{key:"playNext",value:function(e){var t=this,i=this.player;this._setTimelineData(),this._defInited=!1,this._hasTriggerBufferThreshold=!1,i.resetState(),i._currentTime=0,i._duration=0,i.isPlaying=!1,this._useVideoLoad=!1,this._MSEError=!1;var r=this.softDecode;i.pause(),this._reset(),this.states=[],e.vtype&&(this.vtype=e.vtype.toUpperCase()),i.setConfig(e),this.checkReUseMSE(this.config.reUseMSE,!0),this.softDecode?i.vtype=a.l0.MP4_MSE_SOFT:i.vtype=a.l0.MP4_MSE,this.codecType=this.playerConfig.codecType?this.playerConfig.codecType.toLowerCase():a.u7.H264,r!==this.softDecode&&this.h265_h264_switch(this.playerConfig.mediaType||"video"),this.checkConfig(),this.log(g._.LOG,"[Index] playNext",e.vtype,e.vid),i.start(),this.config.reUseMSE&&!this.isH265DegradeH264&&(this.__onmetadataHandle=function(){t.log(g._.LOG,"[Index] playNext metadata update currentTime = 0"),0!==i.currentTime&&(i.currentTime=0),i.video.removeEventListener("loadedmetadata",t.__onmetadataHandle),t.__onmetadataHandle=null},i.video.addEventListener("loadedmetadata",this.__onmetadataHandle)),this.emit("playnext")}},{key:"h265_h264_switch",value:function(e){this.log(g._.LOG,"[Index],h265_switch_h264",e);var t=this.player,i=p.ZP.createDom(e,"",this.getVideoConfig(this.playerConfig),"xgplayer-".concat(e,"-img"));this.removeVideoList.push(t.video),i.muted=t.video.muted,i.volume=t.video.volume,t.media?t.media=i:t.video=i,t.attachVideoEvents(t.video)}},{key:"getVideoConfig",value:function(e){var t=Object.assign({},{controls:!1,autoplay:e.autoplay,playsinline:e.playsinline,"x5-playsinline":e.playsinline,"webkit-playsinline":e.playsinline,"x5-video-player-fullscreen":e["x5-video-player-fullscreen"]||e.x5VideoPlayerFullscreen,"x5-video-orientation":e["x5-video-orientation"]||e.x5VideoOrientation,airplay:e.airplay,"webkit-airplay":e.airplay,tabindex:2,mediaType:e.mediaType||"video"},e.videoConfig,e.videoAttributes);return e.loop&&(t.loop="loop"),t}},{key:"next",value:function(e){this.playNext(e)}},{key:"oldChangeDefinition",value:(v=(0,r.x)((0,r.l5)().mark(function e(t,i){var n,a,o,s,l,u,c,f,h,p,v,m,_=this;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.config,a=this.player,o=this.playerConfig,a.changeDefinitionFlag=!0,a.emit(d.DEFINITION_CHANGE,{from:i,to:t}),a.emit(d.WAITING),l=(s=a.definitionList).filter(function(e){return e.definition===t.definition||e.definition===Number(t.definition)}),(u=s.filter(function(e){return e.definition===i.definition||e.definition===Number(i.definition)})).length>0&&(u[0].selected=!1),!(l.length>0)){e.next=13;break}(t=l[0]).selected=!0,e.next=14;break;case 13:return e.abrupt("return");case 14:return a.curDefinition=t,this.log(g._.LOG,"[oldChangeDefinition],currentTime,",a.currentTime,",from,",i,",to,",t),c=a.currentTime,(f=a.paused)&&(this.config.autoplayBack=o.autoplay,o.autoplay=!1),this._changeDefState={currentTime:c,paused:f},n.definition=t.definition,["keyValue","kid","secretKey","drm","getLicenseUrl","drmKeyToken","sessionId"].forEach(function(e){n[e]=t[e]}),e.next=24,null===(p=this.mp4)||void 0===p?void 0:p.cancelLoading();case 24:if(null===(v=this.mse)||void 0===v||v.clearOpQueues(E.VIDEO),h=null===(m=this.mse)||void 0===m?void 0:m.abort(E.VIDEO)){e.next=28;break}return e.abrupt("return");case 28:h.then(function(){o.url=t.url,o.userSelectDefinition=t.definition,o.defaultDefinition=t.definition,a.currentTime=0,a.pause(),_._reset(),_.states=[],_.checkReUseMSE(!1),_._isMseInit=!1,_.eme=null,_._handlerUrl(t.url),_.once(d.CANPLAY_THROUGH,function(){void 0!==_.config.autoplayBack&&_.config.autoplayBack!==o.autoplay&&(o.autoplay=_.config.autoplayBack,_.config.autoplayBack=void 0)}),a.video.removeEventListener("loadedmetadata",_._changeDefineCanPlay),_._changeDefineCanPlay=function(){_.changeDefineCanPlay(c,f,i,t),a.video.removeEventListener("loadedmetadata",_._changeDefineCanPlay)},a.video.addEventListener("loadedmetadata",_._changeDefineCanPlay),a.video.load(),_.playerStartInit(o.url)}).catch(function(){});case 29:case"end":return e.stop()}},e,this)})),function(e,t){return v.apply(this,arguments)})},{key:"_emitDefinitionChangeDetailEvent",value:function(e){var t=this._currDefinition,i=t.bitrate,r=t.definition,n=t.file_id,a=t.width,o=t.vwidth,s=t.height,l=t.vheight;this.player.emit("definitionChangeDetail",{start:e,bitrate:i,definition:r,mediaType:"video",url:this.config._mainURL,fileid:n});this.player.emit("RESOLUTION_UPDATE",{width:a||o,height:s||l})}},{key:"getCurGopEndTime",value:function(e){var t=this.player;if(!t)return 0;var i=this.mp4,r=i.getFragmentIdx(e||t.currentTime);return i.timeRange[r].endTime}},{key:"_setCurrentDefinition",value:function(e){var t=this.player.config;if(t.definition&&t.definition.list){var i=t.definition.list.filter(function(t){return t.bitrate===e});this._currDefinition=i&&i[0]}!this._currDefinition&&(this._currDefinition={})}},{key:"switchURL",value:function(e,t){var i=this;if(t&&"object"===(0,r.Ac)(t)&&t.action===G.UPDATE_URL){this._updateURL({url:null==e?void 0:e.url});return}if(this.useVideoLoad){q.call(this.player,e);return}var n=this.player,a=this.config;n.config.definition.list=[e],n.config.url=e.url,n.config.defaultBitrate=e.bitrate,n.config.defaultDefinition=e.definition;["keyValue","kid","secretKey","drm","getLicenseUrl","drmKeyToken","sessionId"].forEach(function(t){a[t]=e[t]}),this.__onmetadataHandle=function(){n.currentTime=0,n.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},n.video.addEventListener("loadedmetadata",this.__onmetadataHandle),this.playNext(a)}},{key:"_updateURL",value:function(e){var t=this.player,i=this.config,r=(e||{}).url;return!!t&&!!r&&((t.config.url=r,t.curDefinition&&(t.curDefinition.url=r),this._handlerUrl(r),!this.useVideoLoad&&this.mp4)?(this.mp4.updateUrl(i._mainURL,i._backupURL),!0):!!this.useVideoLoad&&(q.call(this.player,r),!0))}},{key:"_handlerUrl",value:function(e){var t,i=this.config,r=this.playerConfig;if(!e)return!1;var n=[];if("String"===p.ZP.typeOf(e))t=e,r.backupURL&&n.push(r.backupURL);else if("Array"===p.ZP.typeOf(e)&&e.length>0&&(t=e[0].src,e.length>1))for(var a=1;a<e.length;a++){var o=this._processUrl(e[a].src);n.push(o)}return(!!t||0!==n.length)&&(i._mainURL=this._processUrl(t),i._backupURL=n,!0)}},{key:"_processUrl",value:function(e){var t=this.config,i=this.playerConfig,n=w.Z.extUrl(e,(0,r.Zj)({__vid:i.vid},t.reqParams));if(i&&"function"==typeof i.preProcessUrl){var a=i.preProcessUrlOptions||{};n=i.preProcessUrl(n,a).url}return n}},{key:"_processArrayUrl",value:function(e){var t=this;return e.map(function(e){return(0,r.Zj)((0,r.Zj)({},e),{},{src:t._processUrl(e.src)})})}},{key:"_bindEvents",value:function(){var e=this;this.log(g._.LOG,"bindEvents,",this._isEventInit);var t=this.config,i=this.player;!this._isEventInit&&(this.on("seeking",this._onSeeking),this.on("waiting",this._onWaiting),this.on("error",this._onVideoError),this.on("playing",this._onPlaying),this.on("detectGap",function(){t.gapDegrade&&t.useEME&&(t.useEME=!1,e._replay())}),this.on(l.J.CHANGE_FLYING_PLUGIN_CONFIG,this._onChangeConfig),i.setEventsMiddleware({error:function(t,r){var n,o,s,l,u,d,c={errorCode:null==t||null===(n=t.error)||void 0===n?void 0:n.code,errorMessage:null==t||null===(o=t.error)||void 0===o?void 0:o.message,videoType:e.useVideoLoad};if(e.changeState("video_error.Middleware",c),e._setPlayerError(c),e.codecType===a.u7.H265&&(null==t||null===(s=t.error)||void 0===s?void 0:s.message.indexOf("video decoder initialization failed"))>=0&&e.emit("DECODER_FAILED",{codecType:e.config.codecType,vid:null===(l=e.playerConfig)||void 0===l?void 0:l.vid,message:null==t||null===(u=t.error)||void 0===u?void 0:u.message}),e.log(g._.ERROR,"error middleware",JSON.stringify(c),", isDegrade,",!e._MSEError&&!e.useVideoLoad,i.currentTime),!e._MSEError&&!e.useVideoLoad){i.vtype=a.l0.MP4_2,e._MSEError=!0,null===(d=e.mp4)||void 0===d||d.cancelLoading(),e._startDegradedPlayback(c,i.paused),e.emit(H);return}e.emit(H),e.useVideoLoad&&r(t.eventName,null==t?void 0:t.error)}})),this._isEventInit=!0}},{key:"getBufferDur",value:function(){if(!(null!==(e=this.player)&&void 0!==e&&e.buffered))return 0;for(var e,t=this.player.buffered,i=0,r=0,n=t.length;r<n;r++)i+=t.end(r)-t.start(r);return i}},{key:"deleteVideo",value:function(){var e;if((null===(e=this.removeVideoList)||void 0===e?void 0:e.length)>0){for(var t=0;t<this.removeVideoList.length;t++){var i=this.removeVideoList[t],r=i.parentNode;r&&r.removeChild(i),this.log(g._.WARN,"[_removeVideoSource]")}this.removeVideoList=[]}}},{key:"_unbindEvents",value:function(){var e;this.log(g._.LOG,"unbindEvents,",this._isEventInit),this.off("seeking",this._onSeeking),this.off("waiting",this._onWaiting),this.off("ended",this._onEnded),this.off("error",this._onError),this.off("playing",this._onPlaying),this.off(l.J.CHANGE_FLYING_PLUGIN_CONFIG,this._onChangeConfig),this._isEventInit=!1,null!==(e=this.config)&&void 0!==e&&e.enableFPSStuckHandle&&this.off(d.FPS_STUCK,this.fpsStuckHandle)}},{key:"changeState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!this._pTime&&(this._pTime=w.Z.nowTime());var i=w.Z.nowTime()-this._pTime,r=w.Z.nowTime()-this._sTime;this.log(g._.LOG,">>>changeState[".concat(e,"]"),i,r,JSON.stringify(t)),this.states.push({state:e,t1:i,t2:r,data:t}),this._pTime=w.Z.nowTime()}},{key:"_initH265MseProxy",value:function(){this.player.video instanceof HTMLVideoElement&&this.h265_h264_switch(this.playerConfig.mediaType);var e=this.player.video;this.softDecode&&e.setPlayMode&&e.setPlayMode("VOD"),this.mseProxy=e,this.softDecode&&(this.player.forceDegradeToVideo=function(){},this.player.video.addEventListener("lowdecode",this._lowDecoder),this.player.video.addEventListener("error",this._onError))}},{key:"notSupportError",value:function(e){return this.log(g._.LOG,e,R.eT),new c.ZP(this.player,{errorType:C.iR.MEDIA,errorCode:C.O1.mse,errorMessage:"".concat(e," ").concat(R.eT),vid:this.playerConfig.vid})}},{key:"removeAndRejectInitPromise",value:function(e){this._initPromise&&(this._removePendingPromise(this._initPromise),this._initPromise.reject(e))}},{key:"_initMp4",value:function(e,t){var i,n,a,o,s,l,u,d,c,f=this,h=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},p=this.config,v=this.player,m=this.playerConfig;this.mp4&&(this.mp4.destroy(),this.mp4=null),this._startTimelines.reqtime=w.Z.nowTime(),this.changeState("MP4_NEW",{});var _=0;null!=p&&null!==(o=p.pcdnConfig)&&void 0!==o&&o.openPCDN&&(_=(null==p||null===(n=p.pcdnConfig)||void 0===n?void 0:n.switchPCDNMaxCnt)||2),null!=p&&null!==(s=p.pcdnConfig)&&void 0!==s&&s.adaptPCDNConfig&&null!=p&&null!==(l=p.pcdnConfig)&&void 0!==l&&null!==(l=l.adaptPCDNConfig)&&void 0!==l&&l.PCDNBufferControl&&(_=0),this._setCurrentDefinition(v.curDefinition.bitrate);var y=x.Z;(null==p?void 0:p.loadRangeType)===R.TJ.SIZE&&(y=P.Z);var T=null===(u=v.curDefinition)||void 0===u||null===(u=u.pktOffsetMap)||void 0===u?void 0:u.find(function(e){return(null==e?void 0:e.time)===((null==p?void 0:p.firstLoadTimePos)||R.he)}),S=p.enableWorker,k=p.useUrlRange,E=p.retryCount,b=p.retryDelay,L=p.timeout,D=p.processMaxGapTime,C=p.onProcessMinLen,A=p.supportHevc,M=p.afterLoadeddataCallBackLen,N=p.firstLoadBuffer,U=p.memoryOpt,H=p.emitMediaListControl,F=p.reqOptions,G=p.audioGroupingStrategy,V=p.fixEditListOffset,j=p.fixEditListOffsetThreshold,Z=p.isAddRange,q=p.disableRepeatRange,Y=p.alwaysStreamingLoad,W=p.loadRangeType;this.mp4=new y(e,v.curDefinition.bitrate,{segmentDuration:p.segmentMinDuration,enableWorker:S,codecType:this.codecType,chunkSize:p.preloadSize,firstLoadSize:null==T?void 0:T.offset,duration:m.duration||0,fileSize:h.fileSize||0,playerId:this.playerId,vid:m.vid,useUrlRange:k,retryCount:E,retryDelay:b,timeout:L,processMaxGapTime:D,onProcessMinLen:C,supportHevc:A,afterLoadeddataCallBackLen:M,firstLoadBuffer:N,logger:this.logger,memoryOpt:U,emitMediaListControl:H,switchPCDNMaxCnt:_,reqOptions:F,audioGroupingStrategy:G,fixEditListOffset:V,fixEditListOffsetThreshold:j,isAddRange:Z,disableRepeatRange:q,alwaysStreamingLoad:Y,loadRangeType:W},this.config._backupURL,""),this.mp4.once(O.kL.META_READY,this._onMp4MetaReady),this.mp4.on(O.kL.ERROR,this._onMp4Error),this.mp4.on(O.kL.UPDATE_EME,this._updateDrmConfig),this.mp4.on(O.kL.INIT_MSE,this._updateMSE),this.mp4.on(O.kL.TASK_PROGRESS,this._onMp4Progress),this.mp4.on(O.kL.MOOV_REQ_PROGRESS,this._onMp4DataCallBack),this.mp4.on(O.kL.LOAD_ERROR,function(e){var t;null===(t=f.player)||void 0===t||t.emit("source_error",e)}),this.mp4.on(O.kL.REMOVE_PCDN_NODE,function(e){f.pcdn&&e&&f.pcdn.removePCDNNode(e.vid,e.bitrate,e.url)}),this.mp4.on(O.kL.CHANGE_URL,function(e){f.player&&(f.player.emit("initialUrl",{url:e}),f.player.emit("changeHost",w.Z.getHostFromUrl(e)))}),this.mp4.on(O.kL.UPDATE_LOAD_IDX,(i=(0,r.x)((0,r.l5)().mark(function e(t){var i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null===(i=f.mp4)||void 0===i?void 0:i.cancelLoading();case 2:f._curLoadSegmentIdx=t,f.log(g._.LOG,"[update curLoadSegmentIdx]",t);case 4:case"end":return e.stop()}},e)})),function(e){return i.apply(this,arguments)})),this.mp4.on(O.kL.CANCEL_LOADED_LEN,function(e){if(!!f.player){var t,i,r=m.vid,n=(null==e?void 0:e.load_type)||O._R.CDN,a=null===(t=f.mp4)||void 0===t?void 0:t.getCurSwitchPCDNCnt(),o=f._currDefinition,s=o.bitrate,l=o.definition,u=o.file_id;n===O._R.CDN?f.player.emit("prf_data_size",{vid:r,task_type:1,cdn_size:e.len,change_cnt:a,definition:l,bitrate:s,fileid:u}):f.player.emit("prf_data_size",{vid:r,task_type:1,pcdn_size:e.len,trace_id:null===(i=f.mp4)||void 0===i||null===(i=i.pcdnTraceInfo)||void 0===i?void 0:i.trace_id,change_cnt:a,definition:l,bitrate:s,fileid:u}),f.mp4&&f.mp4.updateLoadInfo(n,e.len),B.XO}}),this.mp4.MP4Loader.on(R.kW,function(e){K=e.speed,!f.debugInfo.speed&&(f.debugInfo.speed=[]),f.debugInfo.speed.push(K),f.debugInfo.speed.length>10&&f.debugInfo.speed.shift();var t=(null==e||null===(T=e.priOptions)||void 0===T?void 0:T.type)||O._R.CDN;f.emit(R.kW,(0,r.Zj)((0,r.Zj)({},e),{},{type:t}));var i=(null===(S=f.playerConfig)||void 0===S?void 0:S.vid)||(null==e?void 0:e.vid);if((null==e?void 0:e.len)>0){if(!f.player)return;var n=(null==e||null===(k=e.priOptions)||void 0===k?void 0:k.type)||O._R.CDN,a=(0,I.pl)(e.len,e.time),o=(null===(E=f.adaptRangeRes)||void 0===E?void 0:E.length)>0?f.adaptRangeRes.shift():{},s=o.cachedBufferDur,l=o.loadTarDuration,u=o.loadDuration,d=o.forceSetMin;o.idx;var c=o.PCDNInBuffer,h=o.PCDNOutBuffer,p=o.loadSize,g=null===(b=f.mp4)||void 0===b?void 0:b.getCurSwitchPCDNCnt(),v=f._currDefinition,m=v.bitrate,_={vid:i,task_type:1,buffer_dur:s||-1,load_tar_dur:l||-1,load_dur:u||-1,force_set_min:d,in_buf:c||-1,out_buf:h||-1,change_cnt:g,bitrate:m,definition:v.definition,fileid:v.file_id,load_size:p||-1};n===O._R.CDN?(_.cdn_size=e.len,_.cdn_speed=a):(_.pcdn_size=e.len,_.pcdn_speed=a),f.player.emit("prf_data_size",_),B.XO;var y=e.index?null===(L=f.mp4)||void 0===L||null===(L=L.adaptTimeRange[e.index])||void 0===L||null===(L=L.timeRangeIdx)||void 0===L?void 0:L[1]:null;if(y&&y>=f.mp4.timeRange.length-1)for(;(null===(D=f.adaptRangeRes)||void 0===D?void 0:D.length)>0;){var T,S,k,E,b,L,D,C,x=f.adaptRangeRes.shift(),P=x.cachedBufferDur,w=x.loadTarDuration,A=x.loadDuration,M=x.forceSetMin,N=(x.idx,x.loadSize),U=x.PCDNInBuffer,H=x.PCDNOutBuffer,F=null===(C=f.mp4)||void 0===C?void 0:C.getCurSwitchPCDNCnt();_.buffer_dur=P||-1,_.load_tar_dur=w||-1,_.load_dur=A||-1,_.force_set_min=M||-1,_.in_buf=U||-1,_.out_buf=H||-1,_.load_size=N||-1,_.change_cnt=F,f.player.emit("prf_data_size",_),B.XO}f.mp4&&f.mp4.updateLoadInfo(n,e.len)}}),this.mp4.on(R.fD.MEDIA_LIST,function(e){var t;null===(t=f.player)||void 0===t||t.emit(R.fD.MEDIA_LIST,e)}),null!=p&&null!==(d=p.pcdnConfig)&&void 0!==d&&d.adaptPCDNConfig&&null!=p&&null!==(c=p.pcdnConfig)&&void 0!==c&&null!==(c=c.adaptPCDNConfig)&&void 0!==c&&c.PCDNBufferControl&&(null===(a=this.mp4)||void 0===a||a.setSwitchPCDNCallBack(function(){var e=f.pcdn;if(!e)return -1;var t=e.getPCDNChangeCnt()||-1;return f.log(g._.LOG,"[updateSwitchPCDNMaxCnt]",t),t})),this.changeState("MP4_INIT",{destroy:this.mp4.hasDestroyed}),this.emit("loadstart_mse"),this.mp4.bufferTimeFuncCallBack=function(){return v.bufferedPoint.end-v.currentTime},this.mp4.init(t),this._emitDefinitionChangeDetailEvent(0)}},{key:"_checkPreloader",value:(m=(0,r.x)((0,r.l5)().mark(function e(){var t,i,n,a,o,s,l,u,d,c,f,h,p;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=(t=this.player).curDefinition,n=t.preloader,o=(a=Promise.withResolvers()).promise,s=a.resolve,l={method:"checkPreloader",success:0,type:"error",cacheKey:""},n){e.next=9;break}return this.changeState(R.fp.PRELOAD_ERROR,{t:2}),l.success=0,l.error=Error("no_preloader"),s(l),e.abrupt("return",o);case 9:if(u=(0,I.F5)(i),d=n.getDataUniqueKey(u),l.cacheKey=d,!d){e.next=48;break}return e.next=16,n.getPreLoadData(u);case 16:if(!(c=e.sent)){e.next=41;break}if(h=c.bitrate,p=c.orgDefinition,delete c.generateBy,!(h&&i.bitrate&&h!==i.bitrate)){e.next=29;break}return this.preLoadData=null,l.success=0,l.error=Error("bitrate_not_match_cut_".concat(i.bitrate,"_cache_").concat(h)),this.changeState(R.fp.PRELOAD_ERROR,{t:1,bitrate:h,ck:d}),s(l),this.log(g._.LOG,">>>check Preloader bitrate_not_match cacheKey".concat(d,"\n              curDefinition:").concat(i.bitrate,"  cache:").concat(h)),e.abrupt("return");case 29:i.orgDefinition=p,B.i5,this.preLoadData=c,this.emit("PRELOAD_INFO",this.preLoadData),l.success=1,l.data=c,null===(f=this.preloader)||void 0===f||f.setUsePreloadInfo(d,!0),this.changeState(R.fp.PRELOAD_OK,{t:4,l:this.preLoadData.byteLength,ck:d}),c.mediaSegList&&c.mediaSegList.length>0||c.buffer&&c.buffer.byteLength>0?this.hitpreload=!0:this.hitpreload=!1,s(l),e.next=46;break;case 41:this.preLoadData=null,this.changeState(R.fp.PRELOAD_ERROR,{t:0,ck:d}),l.success=0,l.error=Error("none_preload"),s(l);case 46:e.next=52;break;case 48:this.changeState(R.fp.PRELOAD_ERROR,{t:3,ck:d}),l.success=0,l.error=Error("none_preload"),s(l);case 52:return e.abrupt("return",o);case 53:case"end":return e.stop()}},e,this)})),function(){return m.apply(this,arguments)})},{key:"_initEME",value:function(e,t){var i,r,a=this.config,o=a.kid,s=a.drmKeyToken,l=a.secretKey,u=a.keyValue,d=a.drm,f=a.useEME;if((o||s||l||u||d)&&f&&!(0,n.checkEMEValid)()){this.log(g._.ERROR,"checkEMEInValid"),this._errorHandler(new c.ZP(this.player,{errorType:C.iR.MEDIA,errorCode:C.O1.eme_hijack,errorMessage:"checkEMEInValid",vid:this.playerConfig.vid}));return}var h=this.player,p=this.config;this._updateDrmConfig(t),this.log(g._.LOG,"useEME: ",p.useEME),null===(i=this._secretkey)||void 0===i||i.setOptions('video/mp4; codecs="avc1.64001E"','audio/mp4; codecs="mp4a.40.2"'),null===(r=this._secretkey)||void 0===r||r.setupEME(h.video)}},{key:"_initMse",value:(y=(0,r.x)((0,r.l5)().mark(function e(t){var i,a=this,o,s,l,u,d,f,h,p,v,m,_,y,T,S,k,b,L,R,D=arguments;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=D.length>1&&void 0!==D[1]&&D[1],l=(s=this.config).kid,u=s.drmKeyToken,d=s.secretKey,f=s.keyValue,h=s.drm,p=s.useEME,!((l||u||d||f||h)&&p&&!(0,n.checkMSEValid)())){e.next=6;break}return this.log(g._.ERROR,"checkMSEInValid "),this._errorHandler(new c.ZP(this.player,{errorType:C.iR.MEDIA,errorCode:C.O1.mse_hijack,errorMessage:"checkMSEInValid",vid:this.playerConfig.vid})),e.abrupt("return");case 6:null===(i=this.player)||void 0===i||i.emit("codecsupdate",t.videoCodec),this.updateMSEDuration(),v=this.mp4&&this.mp4.checkCodecH265(),m=this.mp4&&this.mp4.checkCodecH266(),_=!!t.videoCodec,y=!!t.audioCodec,T=_&&y?v?'video/mp4; codecs="hev1.1.6.L93.B0, mp4a.40.5"':m?'video/mp4; codecs="bvc2.1.6.L93.B0, mp4a.40.5"':'video/mp4; codecs="avc1.64001E, mp4a.40.5"':_?v?'video/mp4; codecs="hev1.1.6.L93.B0"':m?'video/mp4; codecs="bvc2.1.6.L93.B0"':'video/mp4; codecs="avc1.64001E"':'video/mp4; codecs="mp4a.40.5"',S=(0,r._x)({},E.VIDEO,{mimeType:"video/mp4",codec:T}),this.mse?(this.log(g._.LOG,"MSE exist"),L=(b=Promise.withResolvers()).promise,R=b.resolve,k=L,R()):(this.log(g._.LOG,"new MSE"),this.mse=new E,k=this.mse.bindMedia(this.player.video)),k.then(function(e){a.changeState("MSE_OPEN");var t=Object.keys(S);try{for(var i=0;i<t.length;i++){var n,s=t[i];null===(n=a.mse)||void 0===n||n.createOrChangeSource(s,S[s].codec).then(function(){a.changeState("MSE_OPEN_DONE"),a._isMseInit=!0,a._onTimeUpdate()}).catch(function(){var e=(0,r.x)((0,r.l5)().mark(function e(t){var i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a.config.reUseMSE=!1,a.log(g._.WARN,"MSE createOrChangeSource catch err: ",null==t?void 0:t.message),e.next=4,null===(i=a.mse)||void 0===i?void 0:i.unbindMedia();case 4:a.mse=null,a._isMseInit=!1,o?a.MSEErrorHandle(t):a._initMse(a.mp4.meta,!0);case 7:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}())}}catch(e){a.MSEErrorHandle(e)}}),this.changeState("MSE_INIT");case 17:case"end":return e.stop()}},e,this)})),function(e){return y.apply(this,arguments)})},{key:"MSEErrorHandle",value:function(e){var t=new c.ZP(this.player,{errorType:C.iR.mse,errorCode:C.O1.mse,vid:this.playerConfig.vid,errorMessage:e.message,mediaError:{code:C.O1.mse,message:e.message}});this.log(g._.ERROR,"initMse error: ",null==e?void 0:e.message),this._errorHandler(t)}},{key:"_appendInitSeg",value:function(e){var t=this;if(!!this.mse&&!this._MSEError)this.changeState("MSE_INITSEG"),this.mse.append(E.VIDEO,e,{vid:this.playerConfig.vid,range:null,dataLen:e.byteLength,isinit:!0}).then(function(e){t.changeState("MSE_INITSEG_OK",{costtime:null==e?void 0:e.costtime})}),this.config.useEME&&this._secretkey&&(this._secretkey.emit(n.EVENT_EME.ENCRYPTED),this.player.emit(n.EVENT_EME.ENCRYPTED))}},{key:"_checkMetaInfo",value:function(e){if(!e)return new c.ZP(this.player,{errorType:C.iR.DEMUX,errorCode:C.O1.metaError,errorMessage:"meta is null",vid:this.playerConfig.vid});var t=this.mp4.checkCodecH265(),i=this.mp4.checkCodecH266();if(this.changeState("MP4_META_READY",{isH265:t,isH266:i}),t&&(this.codecType!==a.u7.H265&&(this.codecType=a.u7.H265,this.log(g._.LOG,"codecType fix ".concat(this.codecType,", ").concat(e.videoCodec))),!this.softDecode&&!this.config.supportHevc)||i&&(this.codecType!==a.u7.H266&&(this.codecType=a.u7.H266,this.log(g._.LOG,"codecType fix ",this.codecType,e.videoCodec)),!this.config.supportVvcc))return this.notSupportError("".concat(this.codecType," - ").concat(e.videoCodec));var r=this.config,n=r.enableCheckTrackGap,o=r.trackGap;if(e.videoCodec&&e.audioCodec&&n){var s=e.moov.trak,l=e.moov.mvhd.timescale;if(Math.abs(this._getTrakDuration(s[0],l)-this._getTrakDuration(s[1],l))>o)return new c.ZP(this.player,{errorType:C.iR.DEMUX,errorCode:C.O1.metaError,errorMessage:"video track and audio track duration long gap, mse cannot play to end",vid:this.playerConfig.vid})}return null}},{key:"_getTrakDuration",value:function(e,t){return e.tkhd.duration/t}},{key:"_stopProgress",value:function(){this.log(g._.LOG,"stopProgress",this._hasStartProgress),this._hasStartProgress=!1,this._requestTimer&&this._requestTimer.stop(),this._bufferBreakTimer&&(clearTimeout(this._bufferBreakTimer),this._bufferBreakTimer=null,this._bufferBreakFlag=void 0),this._seekResumTimer&&(clearTimeout(this._seekResumTimer),this._seekResumTimer=null)}},{key:"checkReStartTimer",value:function(){var e=w.Z.nowTime()-this._lastTimeupdateTime2;e>2*this._tickInSeconds*1e3&&!this._offineLine&&(this.log(g._.LOG,"checkReStartTimer reStart timer",e,w.Z.nowTime()),this._stopProgress(),this._startProgress(),this._lastTimeupdateTime2=w.Z.nowTime())}},{key:"_bindNetworkStateChange",value:function(){window.addEventListener("online",this._onOnlineHandler),window.addEventListener("offline",this._onOfflineHandler)}},{key:"_unbindNetworkStateChange",value:function(){window.removeEventListener("online",this._onOnlineHandler),window.removeEventListener("offline",this._onOfflineHandler)}},{key:"_onSuperStart",value:function(e){var t=this,i=this.player;(0,B.cM)("_onSuperStart:".concat(e),this.mse),i.video.src=e,this.once("canplay",function(){i.play(),t.on("waiting",t._onWaiting)})}},{key:"_appendBuffer",value:function(e,t,i,r){var n=this,o=this.mse,s=this.playerConfig,l=this.player,u=s.vid;if(i=i||{},this.log(g._.LOG,"appendStart",i.fragIndex,JSON.stringify(i.range)),this._MSEError){this.log(g._.ERROR,"_MSEError, not append return");return}o.append(e,t,{vid:u,state:r,context:JSON.stringify(i)}).then(function(e){2===l.changeDefinitionSeekState&&(l.changeDefinitionSeekState=3,n.log(g._.LOG,"appendEnd changeDefinitionSeekState += 0.001"),l.currentTime+=.001);var t,a,o,s,u=n.getAllBufferRange(),d=null!=e&&null!==(t=e.context)&&void 0!==t&&t.context?JSON.parse(null==e||null===(a=e.context)||void 0===a?void 0:a.context):{};if(n.log(g._.LOG,"appendEnd ",null==d?void 0:d.fragIndex,JSON.stringify(null==d?void 0:d.range),", costTime,",null==e?void 0:e.costtime,", opt,",null==e?void 0:e.name,",buffer,",JSON.stringify(u),l.currentTime),!n.loadedDataEventRev){var c=(null==e?void 0:e.costtime)||0,f=n.states.findIndex(function(e){return"APPEND_DATA_OK"===e.state});f>=0?(n.states[f].data.cnt+=1,n.states[f].data.costtime+=c):n.changeState("APPEND_DATA_OK",{costtime:c,cnt:1})}if(n.mse&&r&&(null!==(o=n.mp4)&&void 0!==o&&o.checkIsLoadEnd(null===(s=i.range)||void 0===s?void 0:s[1])||n._loadedEnd)){var h=n.player.buffered;n._loadedEnd=!0;var p=0;h&&(null==h?void 0:h.length)>0&&(p=h.end(h.length-1)),n._isEnded(),n.log(g._.LOG,"loaded ended !!!===>>>",JSON.stringify(i.range),", fragIndex,",i.fragIndex,", bufferEndTime,",p,",meta_duration,",n.mp4.meta.duration)}}).catch(function(e){var t=n.player,r=n.mse;if(!n._hasFirstFramed&&n._setStartTimelines(a.l1.MSE_ERROR,{message:null==e?void 0:e.message}),!n._MSEError&&!!t){var o=t.media||t.video;if(e&&null!=r&&r.isFull()){n.log(g._.WARN,"[MSE is full]");var s=t.getBufferedRange();n._checkRemovePlayedBuffer(s,t.currentTime,!0)}else{var l,d,f,h,p="".concat(null!=o&&o.error?[o.error.code,o.error.message].join("-"):"MEDIA_EMPTY"),v="".concat((null==e?void 0:e.errorCode)||"","-").concat((null==e?void 0:e.errorMessage)||(null==e?void 0:e.message)||"MSE_EMPTY"),m="".concat(v,"|").concat(p);n._MSEError=!0,n.changeState("_MSEError",{fragIndex:null===(l=i)||void 0===l?void 0:l.fragIndex,range:null===(d=i)||void 0===d?void 0:d.range}),n.log(g._.LOG,"MSE append error",null===(f=i)||void 0===f?void 0:f.fragIndex,JSON.stringify(null===(h=i)||void 0===h?void 0:h.range));var _=new c.ZP(t,{errorType:C.iR.MEDIA,errorCode:C.O1.mseAppend,vid:u,errorMessage:m,mediaError:{code:C.O1.mseAppend,message:m}});n._errorHandler(_)}}})}},{key:"_loadData",value:(T=(0,r.x)((0,r.l5)().mark(function e(){var t,i;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(!this.mp4||!this._isMseInit)){e.next=2;break}return e.abrupt("return");case 2:if(e.prev=2,t=this.player,i=_.l.info(_.l.get(t.media||t.video),t.currentTime),!(!this.config.alwaysStreamingLoad&&i.remaining>5)){e.next=10;break}return e.next=8,this.mp4.loadAllFragmentData(this._curLoadSegmentIdx,this._loadDataSuccess);case 8:e.next=12;break;case 10:return e.next=12,this.mp4.load(this._curLoadSegmentIdx,this._loadDataSuccess);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),this.log(g._.ERROR,"[Index] _loadData error",this.playerConfig.vid,null===e.t0||void 0===e.t0?void 0:e.t0.message);case 17:case"end":return e.stop()}},e,this,[[2,14]])})),function(){return T.apply(this,arguments)})},{key:"getDataBitRate",value:function(e){var t=this.mp4,i=this.playerConfig;if(!t)return 0;for(var r=t.getDataBitRate(e),n=i.definition.list,a=0,o=0;n&&o<n.length;o++)if(n[o].bitrate===r){a=n[o];break}return a}},{key:"_loadStuckCheck",value:function(){var e=this,t=this.config,i=this.player;if(!t.disableBufferBreakCheck){if(!this.playerConfig.autoplay&&!this.playFlag)return;var r=i.isUserActive;if(i.currentTime-(this._lastCurrentTime||0)>.1||!r&&i.paused||r&&this.playFlag&&i.paused)(1===this._bufferBreakFlag||2===this._bufferBreakFlag)&&(this.log(g._.LOG,"视频没有卡死,重置卡死标记,curtime,",i.currentTime),this._bufferBreakFlag=0,clearTimeout(this._bufferBreakTimer),this._bufferBreakFlag=null);else if(!this._bufferBreakFlag){this._bufferBreakFlag=1;var n=JSON.stringify(this.getAllBufferRange()),a=this.getWaitingTimeOut();this.log(g._.LOG,"卡死计时开始! ".concat(a,"ms后确认卡死,"),i.currentTime,n),this._bufferBreakTimer=setTimeout(function(){if(!e.isDestroy&&!t.disableInactiveWaitingCheck&&(!!r||!i.paused)&&(!r||!e.playFlag||!i.paused)){if(1===e._bufferBreakFlag){var n=i.currentTime,a=i.bufferedPoint;if(a.end>0&&a.end-n>=2){e.retrySeekResum(n);return}}e._bufferBreakFlag=2,e.waitTimeoutDegrade()}},a)}this._lastCurrentTime=i.currentTime}}},{key:"getWaitingTimeOut",value:function(){var e=this.player,t=this.config.waitingTimeOut;if(!this.playFlag){var i=e.curDefinition.duration;if(i>0){var r=R.zb.find(function(e){return i>=e.range[0]&&i<e.range[1]});r&&(t=r.time)}}return t}},{key:"waitTimeoutDegrade",value:function(){var e,t=this.player;this.changeState("wait_timeout"),this.log(g._.LOG,"确认卡死!!!,curtime,",t.currentTime,JSON.stringify(this.getAllBufferRange()),",duration,",null===(e=this.mp4)||void 0===e||null===(e=e.meta)||void 0===e?void 0:e.duration),this.emit("waittimeout");var i=document.hidden||"hidden"===document.visibilityState,r=new c.ZP(this.player,{errorType:C.iR.RUNTIME,errorCode:i?C.O1.waitTimeoutWithHidden:C.O1.waitTimeout,errorMessage:"wait_timeout",vid:this.playerConfig.vid});this._errorHandler(r)}},{key:"retrySeekResum",value:(S=(0,r.x)((0,r.l5)().mark(function e(t){var i,n,a,o,s=this;return(0,r.l5)().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.player,n=this.config,this.changeState("retrySeek"),this.log(g._.LOG,"卡死但有超过2s的buffer,seek下!!!"),clearTimeout(this._seekResumTimer),this._resumePlay=!1,!(n.waitingRetrySeekTimes>0&&n.waitingRetryDuration)){e.next=14;break}return a=Math.min(n.waitingRetrySeekTimes,3),this._currentSeekTimes=0,this.off("playing",this._onResumePlaying),this.once("playing",this._onResumePlaying),o=function(){if(!i||s._resumePlay||i.paused){s.log(g._.LOG,"当前播放实例已恢复或处于暂停状态，退出重试 player=".concat(!!i,",_resumePlay=").concat(s._resumePlay,",paused=").concat(null==i?void 0:i.paused));return}if(s._currentSeekTimes<a){s._seekOnce(t),s._seekResumTimer=setTimeout(o,n.waitingRetryDuration);return}s.waitTimeoutDegrade(),s._seekResumTimer=null},this._seekOnce(t),this._seekResumTimer=setTimeout(o,n.waitingRetryDuration),e.abrupt("return");case 14:i.currentTime=t+1,this.once("playing",function(){s._resumePlay=!0}),this._seekResumTimer=setTimeout(function(){!s._resumePlay&&s.waitTimeoutDegrade(),s._seekResumTimer=null},Math.ceil(n.waitingTimeOut/2));case 17:case"end":return e.stop()}},e,this)})),function(e){return S.apply(this,arguments)})},{key:"_isInBuffer",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=!1,r=this.player.video.buffered,n=0;n<r.length;n++){var a=r.start(n)-t,o=r.end(n)+t;if(a<=e.startTime&&e.endTime<=o){i=!0;break}}return i}},{key:"_doubleCheckBuffer",value:function(e){var t=this.player;return!(e.startTime>t.currentTime)||!t.video||!t.video.buffered||1===t.video.buffered.length||this._isInBuffer(e,.2)}},{key:"isOpenPCDN",value:function(e){var t=this;if(this.pcdn&&this.mp4){var i=e-this.player.currentTime,r=this.pcdn,n=this.config,a=this.mp4,o=n.pcdnConfig,s=r.getPCDNInBuffer()||o.enterMinBuffer,l=r.getPCDNOutBuffer()||o.outMaxBuffer;if(i>=s){if(a.updatePCDNState(O.oy.OPEN),a.isUpdateNode){var u=this.player.curDefinition,d=u.uri,c=u.bitrate;this.pcdn.getPCDNNode(d,c,this.getPCDNReqId()).then(function(e){if(!!a){var i,n=t.getPCDNReqId();if(null!=e&&e.req_id&&n!==e.req_id){t.log(g._.LOG,",getPCDNNode is not match curDefinition reqId",n,", pcdnRet.req_id",e.req_id);return}a.updateNode(null==e?void 0:e.nodes),r.updatePCDNBitrate(c),e&&(a.pcdnTraceInfo={uri:e.vid,fid:e.fid,trace_id:null==e?void 0:e.trace_id}),e&&a.pcdnVVStat&&(a.pcdnVVStat.try_req_node+=1,a.pcdnVVStat.req_node_succ+=1,a.pcdnVVStat.has_ret_node+=(null==e||null===(i=e.nodes)||void 0===i?void 0:i.length)>0?1:0)}}).catch(function(e){(null==a?void 0:a.pcdnVVStat)&&(a.pcdnVVStat.try_req_node+=1),t.checkURLExpired(e,"_getPCDNNode")})}}else i<l&&a.updatePCDNState(O.oy.CLOSE)}}},{key:"checkURLExpired",value:function(e,t){var i,r,n,a,o=w.Z.checkUrlIsExpired(this.config._mainURL);1===o&&this.pcdn&&(this.pcdn=null);var s=(null==e||null===(i=e.response)||void 0===i?void 0:i.url)||(null===(r=this.config.pcdnConfig)||void 0===r?void 0:r.trackerUrl);null===(n=this.player)||void 0===n||n.emit("source_error",{host:w.Z.getHostFromUrl(s),src:s,errorCode:null==e||null===(a=e.response)||void 0===a?void 0:a.status,message:"".concat(null==e?void 0:e.message,"-").concat(o).concat(t)})}},{key:"pushTimerStep",value:function(){var e;(null===(e=this.timerStepList)||void 0===e?void 0:e.length)>R.zK&&this.timerStepList.shift(),this._lastTimeupdateTime2>0&&this.timerStepList.push(w.Z.nowTime()-this._lastTimeupdateTime2)}},{key:"_onTimeUpdate",value:function(){this.pushTimerStep(),this._lastTimeupdateTime2=w.Z.nowTime();var e=this.mse,t=this.mp4,i=this.player,r=this.config;if(!i)return;if((0,A.yx)()&&i.paused!==this._usePaused&&(this._usePaused?i.pause():i.play()),this.useVideoLoad||!t){this.useVideoLoad&&null!==(o=this.expiryCheckPlugin)&&void 0!==o&&null!==(o=o.config)&&void 0!==o&&o.enableExpiryCheck&&w.Z.nowTime()-this._lastCheckTime>1e3&&(this._lastCheckTime=w.Z.nowTime(),this._startUrlExpiredCheck());return}var n=i.getBufferedRange();w.Z.nowTime()-this._lastCheckTime>1e3&&(this._lastCheckTime=w.Z.nowTime(),this._loadStuckCheck(),this._startUrlExpiredCheck(),this._checkRemovePlayedBuffer(n,i.currentTime));var a=t.timeRange;if(!!a&&!(a.length<1)){if((e||this.mseProxy)&&this.canDownload){var o,s,l,u=this._maxBufferLength,d=!1;(this.playFlag&&i.paused||!this.isActive)&&(d=!0),d?u=i.isInstNext&&this._nextBufferLength>=0?this._nextBufferLength:this._minBufferLength:null!==(l=this.config)&&void 0!==l&&null!==(l=l.adaptRange)&&void 0!==l&&l.targetCacheControl&&(u=this.adaptRange.getAdaptCacheBuffer()),!this.preLoadData&&null!==(s=this.config)&&void 0!==s&&null!==(s=s.adaptRange)&&void 0!==s&&s.targetCacheControl&&(u+=this.config.noPreloadAddBufferLen);var c=i.currentTime+u;n[1]-c<0&&(this.isOpenPCDN(n[1]),(null==r?void 0:r.loadRangeType)===R.TJ.SIZE?this.sizeRangeCheckLoad(d,u,n[1]-i.currentTime):this.gopRangeCheckLoad(d,u)),this.playFlag&&!this._hasTriggerBufferThreshold&&this._startBufferCheck()}}}},{key:"sizeRangeCheckLoad",value:function(e,t,i){var r=this.player,n=this.mp4,a=n.adaptTimeRange,o=a.length,s=n.size-1||r.curDefinition.size-1;if(!(null!=a&&a.length)||(null===(u=a[o-1])||void 0===u?void 0:u.range[1])<s||!a[o-1].isLoading||n.changeBitRateTime>0){var l=a.findIndex(function(e){return!e.downloaded});if(!(null!=a&&a.length)||l>=0||a[o-1].downloaded){var u,d,c=this.calculateAdaptRange(e,t),f=c.adaptRangeRes,h=c.loadDuration;if(f.loadDuration=h,l<0?n.changeBitRateTime>0&&(null===(d=a[o-1])||void 0===d?void 0:d.range[1])>=s?(this._curLoadSegmentIdx=a.length-1,this.log(g._.LOG,"changeBitRateTime> 0 and load last adaptTime")):this._curLoadSegmentIdx=n.updateAdaptTimeRange(null,h):this._curLoadSegmentIdx=l,l>0&&n.changeBitRateTime<=0){var p=a[l-1];if(null!=p&&p.downloaded&&i>0&&(null==p?void 0:p.endTime)-r.currentTime>=t)return}var v=a[this._curLoadSegmentIdx];if(this._curLoadSegmentIdx>=0&&this._isInBuffer(v)&&this._removeBuffEndTime<=0&&this._curLoadSegmentIdx>=0&&v.endTime-v.startTime>1){a[this._curLoadSegmentIdx].downloaded=!0,a[this._curLoadSegmentIdx].isLoading=!0,this.log(g._.LOG,"onTimeUpdate, ".concat(this._curLoadSegmentIdx," download segment, has buffer"),v.startTime,v.endTime,r.currentTime),n.seekTime<v.endTime&&(n.seekTime=v.endTime,this.log(g._.LOG,"".concat(this._curLoadSegmentIdx," download segment, has buffer adjust seekTime")));return}f.idx=this._curLoadSegmentIdx,this.adaptRangeResPush(f),(!a[this._curLoadSegmentIdx].isLoading||n.changeBitRateTime>0)&&(this.log(g._.LOG,"[onTimeUpdate],load index==>>>, ",this._curLoadSegmentIdx,JSON.stringify(a[this._curLoadSegmentIdx])),this._loadData())}}}},{key:"adaptRangeResPush",value:function(e){var t;(!this.adaptRangeRes.length||(null===(t=this.adaptRangeRes[e.length-1])||void 0===t?void 0:t.idx)!==this._curLoadSegmentIdx)&&(this.adaptRangeRes.push(e),this.log(g._.LOG,"adaptRangeRes>>>>",e))}},{key:"gopRangeCheckLoad",value:function(e,t){var i=this,r=this.player,n=this.mp4,a=n.timeRange,o=n.adaptTimeRange,s=n.changeBitRateTime;a.every(function(n,a){if(void 0!==n.adaptTimeRangeIdx&&n.adaptTimeRangeIdx>=0&&o&&o[n.adaptTimeRangeIdx].downloaded&&!(s>0&&n.adaptTimeRangeIdx===o.length-1&&o[n.adaptTimeRangeIdx].downloaded))return!0;var l=i.mp4.getAdaptIdxBySrcIdx(a,!0),u=l>=0?o[l]:null,d=l>=0&&i._isInBuffer(u);if(i._removeBuffEndTime<=0&&l>=0&&u.endTime-u.startTime>1&&d)return o[l].downloaded=!0,o[l].isLoading=!0,i.log(g._.LOG,"onTimeUpdate, ".concat(l," download segment, has buffer"),u.startTime,u.endTime,r.currentTime),!0;if(n.startTime-r.currentTime<t){var c,f=i.calculateAdaptRange(e,t),h=f.adaptRangeRes,p=f.loadDuration;i._curLoadSegmentIdx=i.mp4.updateAdaptTimeRange(a,p),h.idx=i._curLoadSegmentIdx,(null===(c=i.config)||void 0===c||null===(c=c.adaptRange)||void 0===c?void 0:c.rangeControl)&&(h.loadDuration=i.mp4.adaptTimeRange[i._curLoadSegmentIdx].duration),i.adaptRangeResPush(h);var v=o[i._curLoadSegmentIdx];if(i._isInBuffer(v))return v.downloaded=!0,v.isLoading=!0,i.log(g._.LOG,"onTimeUpdate_, ".concat(i._curLoadSegmentIdx," download segment, has buffer"),v.startTime,v.endTime,r.currentTime),!0;(!o[i._curLoadSegmentIdx].isLoading||s>0)&&(i.log(g._.LOG,"[onTimeUpdate],load index==>>>, ",i._curLoadSegmentIdx,JSON.stringify(o[i._curLoadSegmentIdx])),i._loadData())}})}},{key:"calculateAdaptRange",value:function(e,t){var i,r,n,a,o,s={forceSetMin:e};return null!==(i=this.pcdn)&&void 0!==i&&i.isOpenAdaptPCDN&&(s.PCDNInBuffer=this.pcdn.curPCDNInBuffer,s.PCDNOutBuffer=this.pcdn.curPCDNOutBuffer),!this.playFlag||e?a=this._minBufferLength:null!==(o=this.config)&&void 0!==o&&null!==(o=o.adaptRange)&&void 0!==o&&o.rangeControl?(a=this.adaptRange.getAdaptLoadDuration(),s.loadTarDuration=a):a=this.config.rangeMaxDuration,(null===(r=this.config)||void 0===r||null===(r=r.adaptRange)||void 0===r?void 0:r.targetCacheControl)&&(s.cachedBufferDur=t),!this.playFlag&&null!==(n=this.config)&&void 0!==n&&null!==(n=n.adaptRange)&&void 0!==n&&n.rangeControl&&(s.loadTarDuration=a),{adaptRangeRes:s,loadDuration:a}}},{key:"checkReUseMSE",value:function(e,t){var i=this,r=this.mse;if(!!r)if(e||this.config.reUseMSE){r.clearOpQueues(E.VIDEO,t),this.mseAbort();var n,a=null===(n=this.player)||void 0===n?void 0:n.buffered;if((null==a?void 0:a.length)>0){var o=a.end(a.length-1);this.log(g._.LOG,"reUseMSE remove buffer, 0-",o),this._canUpdateDuration=!1,this.removeBuffer(E.VIDEO,0,o,function(){var e;i._canUpdateDuration=!0,(null===(e=i.mp4)||void 0===e||null===(e=e.meta)||void 0===e?void 0:e.duration)&&i.updateMSEDuration()})}}else r.unbindMedia(),this.mse=null,this._unloadVideo()}},{key:"updateMSEDuration",value:function(){var e,t=this.mse,i=this.mp4;this._canUpdateDuration&&null!=i&&null!==(e=i.meta)&&void 0!==e&&e.duration&&i.meta.duration!==t.duration&&(this.log(g._.LOG,"updateMSEDuration ",i.meta.duration,",oldDuration,",t.duration),t.updateDuration(i.meta.duration),this._canUpdateDuration=null)}},{key:"_reset",value:function(){this._definitionChangePointInfo=null,this._isReceiveEndedEvent=!1,this.adaptRangeRes=[],this.hitpreload=!1,this._sTime=w.Z.nowTime(),this._removeBuffEndTime=0,this._usePaused=!1,this.useVideoLoad=!1,this._isMseInit=!1,this.loadedDataEventRev=!1,this.needStarLoadFirstSegment=!1,this._curLoadSegmentIdx=0,this.emitExpireTimestamp=null,this.preLoadData=null,this.forPreloadTimeCache=null,this.playFlag=!1,this.waitLevelStartTime=-1,this._waitAdjustTimeCnt=0,this._initPromise&&"pending"===this._initPromise.state&&this._initPromise.reject(U),clearTimeout(this.checkResumePlayTimer),this.checkResumePlayTimer=null,this._stopProgress(),this.mp4&&(this.mp4.destroy(),this.mp4=null),this.mseProxy&&(this.player.video.removeEventListener("lowdecode",this._onDegrade),this.player.video.removeEventListener("error",this._onError)),this._unloadVideo(),this._cancelPendingPromises(),this._abrService&&(this._abrService.destroy(),this._abrService=null),clearTimeout(this._waitInBufferTimer),this._waitInBufferTimer=null,this.canDownload=!0,this._mediaCodec={videoCodec:"",audioCodec:""}}},{key:"removeErrorUrls",value:function(e,t,i){return e.errorCode===C.O1["403"]&&this._emitExpireEvent(e),i}},{key:"_setPlayerError",value:function(e){if(!this._hasFirstFramed){var t="".concat(this.player.vtype," ").concat(null==e?void 0:e.errorCode,"-").concat(null==e?void 0:e.errorMessage,"-").concat(null==e?void 0:e.rangeStart,"-").concat(null==e?void 0:e.rangeEnd);this._setStartTimelines(a.l1.PLAYER_ERROR,{message:t,httpCode:null==e?void 0:e.errorCode})}}},{key:"checkIsDegraded",value:function(e){var t=this.config.notDegradeErrorList;return!((null==t?void 0:t.length)>0&&(e.errorCode===C.O1.timeout&&t.indexOf("timeout")>=0||e.errorCode===C.O1["403"]&&(t.indexOf(403)>=0||t.indexOf("403")>=0)||e.errorCode===C.O1["404"]&&(t.indexOf(404)>=0||t.indexOf("404")>=0)))&&!0}},{key:"_startDegradedPlayback",value:function(e,t){var i=this;this.canDownload=!1;var r=this.player,n=this.playerConfig,o=this.config;if(!r){this._setStartTimelines(a.l1.DESTROY,{message:"-degrade"});return}this.mse&&(this.mse.clearOpQueues(E.VIDEO),this.mseAbort()),this._currentTime=r.currentTime||0,this.player.pause(),this._reset(),this.states=[],this._replay=null;var s=n.H264DefinitionList;if(this.codecType===a.u7.H265&&this.softDecode)this.log(g._.LOG,"h265 softDecode err,degrade use 264 play",n.vid),this._onDegrade(e);else if(this.codecType===a.u7.H264||o.supportHevc||o.supportVvcc||(null==s?void 0:s.length)>0){var l=o.drm,u=o.kid,d=o.drmKeyToken,c=o.keyValue,f=o.secretKey;if(l||u||d||c||f)l&&Object.keys(l).map(function(t){l&&(e[t]=l[t])}),this.log(g._.ERROR,"final error !!!!, ",n.vid,null==e?void 0:e.errorCode,null==e?void 0:e.errorMessage),this.emit("error",e);else{this.log(g._.LOG,this.codecType,"MSE degrade video,",n.vid,r.currentTime),this.emit(F,{errc:null==e?void 0:e.errorCode,err_msg:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),CodecTypes:this.codecType,media_type:n.mediaType}),this.useVideoLoad=!0,this.__onmetadataHandle=function(){var e;if(!!i.player)i._currentTime&&(i.player.currentTime=i._currentTime),i.log(g._.LOG,"DegradedPlayback update currentTime",null===(e=i.playerConfig)||void 0===e?void 0:e.vid,i.codecType,i._currentTime),t?i.player.pause():i.player.play(),i.player.video.removeEventListener("loadedmetadata",i.__onmetadataHandle),i.__onmetadataHandle=null},r.video.addEventListener("loadedmetadata",this.__onmetadataHandle);var h,p=n.url;if((null==e||null===(h=e.message)||void 0===h?void 0:h.indexOf(R.eT))>=0&&(null==s?void 0:s.length)>0){var v=s.length,m=this.player.curDefinition.definition,_=m&&s.find(function(e){return e.definition===m});!_&&(n.H264DefinitionList.sort(function(e,t){return e.bitrate-t.bitrate}),_=n.H264DefinitionList[Math.floor(v/2)]),_&&(p=_.url,this.playerConfig.codecType=a.u7.H264,this.codecType=a.u7.H264)}this._setPlayerSrc(p)}}else this.log(g._.ERROR,"degrade player failed"),this.emit("error",e)}},{key:"mseAbort",value:function(){var e;if(null!==(e=this.mse)&&void 0!==e&&e.abort){var t=this.mse.abort(E.VIDEO);t&&t.catch(function(){})}}},{key:"isSeekingInSameBuffer",value:function(e,t){var i=!1,r=this.mp4,n=this._lastBufferPoint;return r.meta&&r.meta.duration-t.end<.5&&(i=!0),n&&0!==e&&e>=n.start&&e<n.end&&(i=!0),this._lastBufferPoint=t,i}},{key:"getAdaptTimeRangeIdx",value:function(e){var t,i,r=this.config,n=this.adaptRange,a=r.segmentMinDuration;return n&&null!=r&&null!==(t=r.adaptRange)&&void 0!==t&&t.rangeControl&&(a=n.getAdaptLoadDuration()),null===(i=this.mp4)||void 0===i?void 0:i.updateAdaptTimeRange(e,a)}},{key:"_startProgress",value:function(){this.initTimer(),this._requestTimer.start(),this._hasStartProgress=!0}},{key:"_unloadVideo",value:function(){this.log(g._.LOG,"unloadVideo");var e=this.player;try{e.video&&e.video.src&&!/^blob/.test(e.currentSrc)&&!/^blob/.test(e.video.src)&&(this.log(g._.LOG,"unloadVideo src"),e.video.removeAttribute("src"),e.video.load())}catch(e){this.log(g._.ERROR,"unloadVideo error",null==e?void 0:e.message)}}},{key:"_addPendingPromise",value:function(e){this._pendingPromises.push(e)}},{key:"_removePendingPromise",value:function(e){this.log(g._.LOG,"removePendingPromise",null==e?void 0:e.id);var t=this._pendingPromises.indexOf(e);t>-1&&this._pendingPromises.splice(t,1)}},{key:"_cancelPendingPromises",value:function(){this._pendingPromises.length>0&&this._pendingPromises.forEach(function(e){e.reject(U)}),this._pendingPromises=[]}},{key:"_onMediaExpired",value:function(){this.log(g._.LOG,"MediaExpired stopProgress"),this._stopProgress(),this.emit(R.fD.MEDIA_EXPIRED)}},{key:"_isEnded",value:function(){var e,t,i,r,n=this.player,a=this.mp4;if(!n)return!1;var o=n.bufferedPoint,s=o?o.end:0;this.checkStartLoadFirstSegment(s);var l=n.currentTime;l>1&&s>l&&(s-l>=2||n.duration-l<1)&&2===n.video.readyState?w.Z.nowTime()-this._lastCheckLagTime>=3e3&&(this.log(g._.LOG,"[has buffer but waiting,seek 0.2 adjust],curTime,",l,", bufferend,",s,", duration,",null==a||null===(r=a.meta)||void 0===r?void 0:r.duration),n.currentTime=l+.2,this._lastCheckLagTime=w.Z.nowTime()):this._lastCheckLagTime=w.Z.nowTime();var u=(null===(e=n.buffered)||void 0===e?void 0:e.length)||0;if(u<=0||!n.buffered)return!1;var d=(null===(t=n.buffered)||void 0===t?void 0:t.end(u-1))||0;return!!(null!=a&&null!==(i=a.meta)&&void 0!==i&&i.duration&&a.meta.duration-n.currentTime<1&&(this._loadedEnd||1>Math.abs(a.meta.duration-d)))&&(this._stopProgress(),this.log(g._.LOG,"[isEnded],stopProgress and endOfStream,curTime, ",n.currentTime,", bufferend,",d,", duration,",a.meta.duration),this.mse&&this.mse.endOfStream().then(function(){}),!0)}},{key:"checkStartLoadFirstSegment",value:function(e){var t=this.player,i=this.mp4,r=this.config;if(!!t&&!!r.loadFirstGopData&&!!(null!=i&&null!==(n=i.meta)&&void 0!==n&&n.duration)&&!!(null!=t&&null!==(a=t.buffered)&&void 0!==a&&a.length)&&!!this.needStarLoadFirstSegment){if((this._loadedEnd||.5>Math.abs(e-this.mp4.meta.duration))&&t.buffered.start(0)>=i.timeRange[0].endTime){this.log(g._.LOG,"changeBitrate load end, reload loadFirstSegment"),this.needStarLoadFirstSegment=!1,i.resetDemuxSampleIdx(0),i._loadSuccessCallBack=this._loadDataSuccess;var n,a,o,s=(null===(o=i.timeRange[0])||void 0===o?void 0:o.range)||i.calculateRange(0);i.fillFirstSegment=!0,i.startLoad(s,0)}}}},{key:"emitVideoEvent",value:function(e){var t=this;if(!this._checkEndedTimer){var i=this.player,r=this.mp4;this._checkEndedTimer=setTimeout(function(){t._checkEndedTimer=null,!t._isReceiveEndedEvent&&r.meta.duration-i.currentTime<.5&&(t.log(g._.LOG,"[ do emit video ended event],curTime,",i.currentTime,", bufferend,",e,", duration,",r.meta.duration),t.emit("ended"))},2e3)}}},{key:"_clearMediaKeys",value:function(){var e=this.player;e.video&&"function"==typeof e.video.setMediaKeys&&e.video.setMediaKeys(null).catch(function(){})}},{key:"_checkRemovePlayedBuffer",value:function(e,t,i,r){var n=this,a=this.mse,o=this.mp4,s=this.player;if(!a||!o||!s)return;if(i&&(clearTimeout(this._removeBufferTimer),this._removeBufferTimer=null),!e&&(e=s.getBufferedRange()),!t&&(t=s.currentTime),!(!i&&w.Z.nowTime()-this._checkRemoveBufferLastTime<=this.config.removeBufferLen)){if(this._checkRemoveBufferLastTime=w.Z.nowTime(),e&&e[0]>=0&&(t-e[0]>this.config.removeBufferLen||a.isFull())){var l=r?e[1]:t-(a.isFull()?0:15),u=o.getFragmentIdx(l);if(u>0&&(r||o.timeRange[u].startTime<t)){var d=Math.floor(Math.min(o.timeRange[u].startTime,e[1])),c=Math.max(o.timeRange[0].endTime+1,e[0]);c<d?(this.log(g._.LOG,"[checkremoveSourceBuffer], remove range==>>>",c,d,t),this.removeBuffer(E.VIDEO,c,d)):a.isFull()&&!this._removeBufferTimer&&(this._removeBufferTimer=setTimeout(function(){n._checkRemovePlayedBuffer(null,null,!0)},1e4))}}}}},{key:"onMediaUpdate",value:function(e){var t=e.vid,i=e.kid,r=e.url,n=this.player,a=this.config;if(t===this.playerConfig.vid&&i===a.kid&&r){this.playerConfig.url=r,this._handlerUrl(r);var o=a._mainURL;return this.useVideoLoad?n.src=r:this.mp4&&this.mp4.updateUrl(o),!0}return!1}},{key:"enableAutoBuffer",value:function(e){var t=this;if(e){if(!this._allInitPromise){this.log(g._.LOG,"player destroyed!!");return}this._allInitPromise.then(function(){t.log(g._.LOG,"enableAutoBuffer true"),t._startProgress()})}else this._stopProgress(),this.log(g._.LOG,"enableAutoBuffer false")}},{key:"bitRateAdapter",get:function(){return this.player&&this.player.plugins?this.config.needAutoBitrate?this.player.plugins.bitrateselector:null:null}},{key:"getDefinitonFromAdapter",value:function(e,t){if(!this.bitRateAdapter)return null;var i=this.bitRateAdapter;return i.getSuitableBitrate?i.getSuitableBitrate(e,t):i.bitRateAdapter?i.bitRateAdapter.select(e):null}},{key:"log",value:function(e,t){for(var i=(this.playerConfig||{}).vid,r=i?"[Index]".concat(i," ").concat(t):"[Index] ".concat(t),n=arguments.length,a=Array(n>2?n-2:0),o=2;o<n;o++)a[o-2]=arguments[o];B.cM.apply(void 0,[this.logger,e,r].concat(a))}},{key:"_emitInitFail",value:function(e){this.log(g._.ERROR,"initFail, reason:",e),this.emit(R.fD.INIT_FAIL,e)}},{key:"useVideoLoad",get:function(){return this._useVideoLoad},set:function(e){this._useVideoLoad=e}},{key:"ready",get:function(){return this._allInitPromise}},{key:"speed",get:function(){return parseInt(O.Yx.speed,10)}},{key:"version",get:function(){return N.i}},{key:"realTimeSpeed",get:function(){return K}},{key:"opQueueLen",get:function(){var e=this.mse&&this.mse._queue?this.mse._queue[E.VIDEO]:[];return e?e.length:0}},{key:"loadSegmentTimeRange",get:function(){return[0,0,0,0]}},{key:"moovSize",get:function(){return 0}},{key:"isDestroy",get:function(){return!this.player}},{key:"domain",get:function(){return w.Z.getHostFromUrl(this.loadURL)}},{key:"loadURL",get:function(){var e=this.player,t=e.currentSrc;return/^blob/.test(e.currentSrc)&&(t=this.mp4.currentLoadUseUrl()),t}},{key:"abrInstance",get:function(){return this._abrService?this._abrService.abrInstance:null}},{key:"expiryCheckPlugin",get:function(){return this.player&&this.player.plugins?this.player._customExpiryCheck?this.player.plugins.expirycheck:null:null}},{key:"_handleUrlExpire",value:function(){var e=this,t=this.config,i=this.player,r=i.paused;new Date().getTime()/1e3>=this.urlExpireTimestamp&&this.urlExpireTimestamp>0&&!r&&t.getServerTime&&(i.serverTimeDiffPromise=i.serverTimeDiffPromise||t.getServerTime().catch(function(){return 0}),i.serverTimeDiffPromise.then(function(t){if(t&&(i.serverTimeDiff=new Date().getTime()/1e3-t),new Date().getTime()/1e3>=e.urlExpireTimestamp+i.serverTimeDiff){e.urlExpireTimestamp=new Date().getTime()/1e3+86400;var r=new C.oO("network",C.O1["403"]);e._emitExpireEvent(r)}}))}},{key:"_emitExpireEvent",value:function(e){var t=this.player,i=new Date().getTime()/1e3;return this.emitExpireTimestamp?!!(i-this.emitExpireTimestamp>300)&&(this.emitExpireTimestamp=i,t.emit("MEDIA_EXPIRED",e),!0):(this.emitExpireTimestamp=i,t.emit("MEDIA_EXPIRED",e),!0)}},{key:"reportBugPostPlayerLog",value:function(){this.log(g._.LOG,"reportBugPostPlayerLog"),this.emit(H)}},{key:"getAllBufferRange",value:function(){var e=[],t=this.player;if(!t||!(null!=t&&t.buffered))return e;var i=t.buffered;if(i)for(var r=0,n=i.length;r<n;r++)e.push([null==i?void 0:i.start(r),null==i?void 0:i.end(r)]);return e}}],[{key:"pluginName",get:function(){return"Mp4EncryptPlayer"}},{key:"defaultConfig",get:function(){return L.g}},{key:"speed",get:function(){return K}},{key:"realTimeSpeed",get:function(){return K}},{key:"version",get:function(){return N.i}}])}(u.q);Y.isSupported=A.Gb,Y.isEMESupported=A.KI,Y.isSupportedWithXgmse=A.pU,Y.isMediaSourceSupported=A.Hs,Y.isWebAssemblySupported=A.qK,Y.CUSTOM_EVENTS=R.fD,Y.updateUnionInfo=n.XGSecretKey.updateUnionInfo,Y.registerPreloader=u.q.registerPreloader},357737:function(e,t,i){i.d(t,{Z:function(){return p}});var r=i(989798);i(969642),i(410121),i(724356),i(947478),i(864614),i(210434);var n=i(860513),a=i(518490),o=i(559435),s=i(204828),l=i(194235),u=new o.Z({}),d=null,c=null,f={needCheckDuration:!0},h=function(e){function t(e){var i;return(0,r.PA)(this,t),i=(0,r.$w)(this,t,[e]),(0,r._x)(i,"_onXLog",function(e){"waitingEnd"===e.eventType&&0===e.type&&(u.blockDuration=e.costTime,i.player.isUserActive&&(u.currentBlockDur=e.costTime))}),t.defaultConfig=e.config,i}return(0,r.XW)(t,e),(0,r.qH)(t,[{key:"updateSelectInfo",value:function(e,t){this.selectInfo[e]=t}},{key:"matchFactor",value:function(e,t,i){var r,n,a="Array"===(0,l.kM)(t)?t:[],o=!1;switch(e){case"core_cnt":i.core&&a.length>1&&i.core>=Number(a[0])&&i.core<=Number(a[1])&&(o=!0);break;case"memory":i.memory&&a.length>1&&i.memory>=Number(a[0])&&i.memory<=Number(a[1])&&(o=!0);break;case"video_screen_mode":;if(a.length>0&&"landscape"===a[0]&&(r=i.videoHeight,n=i.videoWidth,r&&n&&n>r))o=!0;break;case"encoder":a.length>0&&a[0]&&i.codecType&&a[0]===i.codecType&&(o=!0)}return o}},{key:"updateParamsByFactor",value:function(e){for(var t=this,i=this.playerConfig,r=i.codecType,n=i.videoHeight,a=i.videoWidth,o=0|window.navigator.deviceMemory,s=0|window.navigator.hardwareConcurrency,l=null,u=null,d={codecType:r,videoHeight:n,videoWidth:a,memory:o,core:s},c=0;c<e.length;c++){for(var f=e[c].factor||{},h=Object.keys(f),p=!0,g=0;g<h.length;g++)if(!this.matchFactor(h[g],f[h[g]],d)){p=!1;break}if(p){e[c].factor,l=e[c].config;break}}l&&Object.keys(l).forEach(function(e){t.config[e]=l[e]})}},{key:"afterCreate",value:function(){var e=this.config,t=e.factors;e.speedAlgoType,t&&t.length>0&&this.updateParamsByFactor(t),this._bindEvent(),this.bitRateAdapter=new a.ZP({config:this.config},this.player),!d&&(d=new a.ZP({config:this.config})),u.setConfig(this.config.detectConfig||{}),u.resetCurrent()}},{key:"beforePlayerInit",value:function(){this.curBitRate=this.getInitBitrate(),this.player.curDefinition=this.curBitRate}},{key:"_bindEvent",value:function(){this.on("xglog",this._onXLog)}},{key:"getInitBitrate",value:function(){if(!this.config.disabled){var e=this.player,t=this.config,i=this.playerConfig;c=i.userSelectDefinition;var r=this.getSuitableBitrate(e.definitionList,i.userSelectDefinition);return r?i.url=r.url:r={url:i.url,definition:i.defaultDefinition||t.definition,bitrate:i.defaultBitrate||i.bitrate,type:a.vK.DEFAULT},r.networkSpeed=r.speed||(0,a.zP)(this.config.speedAlgoType),r}}},{key:"getSuitableBitrate",value:function(e,i){if(this.selectInfo={},e=(0,l.VX)(e,"video"),!!this.bitRateAdapter&&!!e&&!(e.length<1)){var r=this.config,n=this.config.bitrateKey;(0,l.QS)(e,n),this.bitRateAdapter.speed=(0,a.zP)(this.config.speedAlgoType),this.updateSelectInfo("oriRateCnt",(null===(p=e)||void 0===p?void 0:p.length)||0),this.updateSelectInfo("type","member"),this.updateSelectInfo("speed",this.bitRateAdapter.speed);var o=e.sort(function(e,t){return t._xgOrgBitrate-e._xgOrgBitrate}),d=this.getAdaptBitrate(o);this.updateSelectInfo("filterRateCnt",(null===(g=d)||void 0===g?void 0:g.filterRateCnt)||0),this.updateSelectInfo("isFilterMaxRateAdapt",d.isFilterMaxRate),this.updateSelectInfo("bitrateSetSelector",d.bitrateSetSelector),this.updateSelectInfo("qualityBitrateSelector",d.qualityBitrateSelector);var c=d?d.duration:0,f=(null===(v=d)||void 0===v?void 0:v._targetBitrate)||(null===(m=d)||void 0===m?void 0:m._xgOrgBitrate);this.updateSelectInfo("adaptTarRate",f);var h=this.config.mode;if(this.updateSelectInfo("mode",h),h&&h===a.vP.BANDWIDTH){var p,g,v,m,_,y,T=0;if(!(null!==(_=this.bitRateAdapter)&&void 0!==_&&_.speed)||this.bitRateAdapter.speed<0||1!==r.mixFactor){var S=Object.assign({},this.config);S.mode=a.vP.BUFFER_INFO;var k=new a.ZP({_config:S},this.player);k.speed=this.bitRateAdapter.speed;var E=null==k?void 0:k.select(e,S.mode,this.bitRateAdapter.speed);this.updateSelectInfo("isFilterMaxRateBuf",E.isFilterMaxRate),T=(null==E?void 0:E._targetBitrate)||(null==E?void 0:E._xgOrgBitrate),this.updateSelectInfo("buffTarRate",T)}y=!this.bitRateAdapter.speed||this.bitRateAdapter.speed<0?T:(null==r?void 0:r.mixFactor)>=0&&r.mixFactor<=1?f*r.mixFactor+T*(1-r.mixFactor):(null==r?void 0:r.mixFactor)>1?Math.max(f,T):Math.min(f,T),this.updateSelectInfo("finalTarRate",y),!(d=(0,l.v2)(e,y,this.config.selectAlgType))&&(d=e[e.length-1]),d._targetBitrate=y}var b=this.bitRateAdapter.getTargetBitrate(c,e,this.bitRateAdapter.speed);if(b&&(u.targetBitRate=b),i){this.updateSelectInfo("mode","userSelect");var L=t.getUserSelectBitrate(o,i);L&&(u.selectBitRate=L._xgOrgBitrate,u.updateBitRateInfo(L._xgOrgBitrate,b),d=L)}return this.config.overscore&&this.config.overscore.isOpen?(0,s.P)(d,o,this.config.overscore):(d.speed=this.bitRateAdapter.speed,this.updateSelectInfo("isOriMaxRate",(0,a.gH)(o,d)),this.updateSelectInfo("selectRate",d._xgOrgBitrate||-1),"function"==typeof this.config.selectInfoBack&&this.config.selectInfoBack(this.selectInfo),d)}}},{key:"getAdaptBitrate",value:function(e){if(!this.config.disabled){this.player;var t=null,i=this.config.bitrateKey;return(e=(0,l.QS)(e,i))&&e.length&&this.bitRateAdapter&&(t=this.bitRateAdapter.select(e,null,this.bitRateAdapter.speed)),t&&(t.type=a.vK.BITRATE_ADAPTER),t}}},{key:"getDefinition",value:function(e,t,i){for(var r=-1,n=0;n<e.length;n++)e[n]._xgOrgBitrate===t&&(r=n);return -1===r?null:i&&e.length>r+1?e[r+1]:!i&&r-1>=0?e[r-1]:null}},{key:"needChangeDefinition",value:function(){var e=this.player,i=e.curDefinition,r=e.definitionList,n=this.playerConfig,a=n.userSelectDefinition,o=n.extDefinition,s=o&&o.length>0?o:r,l={type:0,message:"DO_NOT_UPDATE",targetDefinition:null};if(!a||s.length<2)return l;var d=i;a&&(d=t.getUserSelectBitrate(s,a));var c=u.checkDefinition();l.type=c;var f=this.getAdaptBitrate(s);if(!f||0===c||!f||!f._xgOrgBitrate||!d||!d._xgOrgBitrate)return l.message="DO_NOT_UPDATE",l;var h=f._xgOrgBitrate>=d._xgOrgBitrate,p=f._xgOrgBitrate<d._xgOrgBitrate,g=null;switch(1===c?g=h?this.getDefinition(s,d._xgOrgBitrate,!0):f:2===c&&(g=p?this.getDefinition(s,d._xgOrgBitrate,!1):f),l.targetDefinition=g,(!l.targetDefinition||l.targetDefinition.definition===a)&&(l.type=0),l.type){case 1:l.message="NEED_TO_REDUCE_BITRATE";break;case 2:l.message="CAN_UPGRADE_BITRATE";break;default:l.message="DO_NOT_UPDATE"}return l}},{key:"detectDefInfo",get:function(){return u}},{key:"destroy",value:function(){this.bitRateAdapter&&this.bitRateAdapter.destroy(),this.bitRateAdapter=null,this.off("xglog",this._onXLog),u&&u.resetCurrent()}}],[{key:"pluginName",get:function(){return"BitrateSelector"}},{key:"defaultConfig",get:function(){return(0,r.Zj)({needCheckDuration:!0},f)},set:function(e){Object.keys(e).forEach(function(t){f[t]=e[t]})}},{key:"getSuitableBitrate",value:function(e,i,r){if(t.staticSelectInfo={},e=(0,l.VX)(e,"video"),t.updateStaticSelectInfo("oriRateCnt",(null===(g=e)||void 0===g?void 0:g.length)||0),!!e&&!(e.length<1)){!r&&(r=t.defaultConfig);var n=(0,a.zP)(r.speedAlgoType);t.updateStaticSelectInfo("type","static"),t.updateStaticSelectInfo("speed",n),r=Object.assign(r,f),i?t.updateStaticSelectInfo("mode","userSelect"):(i=c,t.updateStaticSelectInfo("mode",null===(m=r)||void 0===m?void 0:m.mode));var o=r.bitrateKey,h=(e=(0,l.QS)(e,o)).sort(function(e,t){return t._xgOrgBitrate-e._xgOrgBitrate}),p=null;if(!d&&(d=new a.ZP({config:r},this.player)),d.speed=n,h&&h.length&&d&&(p=d.select(h,null,n),t.updateStaticSelectInfo("filterRateCnt",(null===(_=p)||void 0===_?void 0:_.filterRateCnt)||0),t.updateStaticSelectInfo("isFilterMaxRateAdapt",null===(y=p)||void 0===y?void 0:y.isFilterMaxRate),t.updateStaticSelectInfo("bitrateSetSelector",p.bitrateSetSelector),t.updateStaticSelectInfo("qualityBitrateSelector",p.qualityBitrateSelector),p&&(null===(T=r)||void 0===T?void 0:T.mode)===a.vP.BANDWIDTH)){var g,v,m,_,y,T,S,k,E,b=p._targetBitrate||p._xgOrgBitrate;t.updateStaticSelectInfo("adaptTarRate",b);var L=0;if(!n||n<0||1!==r.mixFactor){var R=Object.assign({},r);R.mode=a.vP.BUFFER_INFO;var D=new a.ZP({config:R},this.player);D.speed=n;var C=null==D?void 0:D.select(e,R.mode,n);t.updateStaticSelectInfo("isFilterMaxRateBuf",null==C?void 0:C.isFilterMaxRate),L=(null==C?void 0:C._targetBitrate)||(null==C?void 0:C._xgOrgBitrate),t.updateStaticSelectInfo("buffTarRate",L)}E=!n||n<0?L:(null===(S=r)||void 0===S?void 0:S.mix_factor)>=0&&r.mix_factor<=1?b*r.mix_factor+L*(1-r.mix_factor):(null===(k=r)||void 0===k?void 0:k.mix_factor)>1?Math.max(b,L):Math.min(b,L),!(p=(0,l.v2)(e,E,r.selectAlgType))&&(p=e[e.length-1]),p._targetBitrate=E,t.updateStaticSelectInfo("finalTarRate",E)}p&&(p.type="bitRateAdapter");var O=p?p.duration:0,x=d?d.getTargetBitrate(O,e):null;if(x&&(u.targetBitRate=x),i){var P=t.getUserSelectBitrate(h,i);P&&(u.selectBitRate=P._xgOrgBitrate,u.updateBitRateInfo(P._xgOrgBitrate,x),p=P)}return r.overscore&&r.overscore.isOpen?(0,s.P)(p,h,r.overscore):(t.updateStaticSelectInfo("isOriMaxRate",(0,a.gH)(h,p)),t.updateStaticSelectInfo("selectRate",(null===(v=p)||void 0===v?void 0:v._xgOrgBitrate)||-1),"function"==typeof r.selectInfoBack&&r.selectInfoBack(t.staticSelectInfo),p)}}},{key:"updateStaticSelectInfo",value:function(e,i){t.staticSelectInfo[e]=i}},{key:"getUserSelectBitrate",value:function(e,t){if(t&&e&&e.length>0){for(var i=null,r=null,n=0;n<e.length;n++){if(t===e[n].definition){i=e[n];break}!r&&t<e[n].definition&&(r=e[n])}return!i&&(i=r||e[e.length-1]),i.type=a.vK.USER_SELECT,i}return null}}])}(n.ZP);(0,r._x)(h,"staticSelectInfo",{});let p=h},146598:function(e,t,i){i.d(t,{$Z:function(){return s},_H:function(){return a},d0:function(){return u},hj:function(){return l}});var r=i(981500),n=i(589374);function a(e,t){var i,r=t.segmentDuration,n=e.trak;if(!!n&&!!n.length){var a=n.find(function(e){var t,i;return(null===(t=e.mdia)||void 0===t?void 0:null===(i=t.hdlr)||void 0===i?void 0:i.handlerType)==="vide"}),s=n.find(function(e){var t,i;return(null===(t=e.mdia)||void 0===t?void 0:null===(i=t.hdlr)||void 0===i?void 0:i.handlerType)==="soun"});if(a||s){var l=[],u=[];return a&&(i=(l=o("video",a,r,t)).map(function(e){return e.duration})),s&&(u=o("audio",s,r,t,i,l)),{videoSegments:l,audioSegments:u}}}}function o(e,t,i,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],s=arguments.length>5?arguments[5]:void 0,l=a.fixEditListOffset,u=a.fixEditListOffsetThreshold,d=a.audioGroupingStrategy,c=a.memoryOpt,f=null===(ee=t.mdia)||void 0===ee?void 0:null===(et=ee.minf)||void 0===et?void 0:et.stbl;if(!f)return[];var h=null===(ei=t.mdia.mdhd)||void 0===ei?void 0:ei.timescale,p=f.stts,g=f.stsc,v=f.stsz,m=f.stco,_=f.stss,y=f.ctts;if(!h||!p||!g||!v||!m||"video"===e&&!_)return[];var T=0,S=null===(er=t.edts)||void 0===er?void 0:null===(en=er.elst)||void 0===en?void 0:en.entries;if(l&&function(){var e=!0,t=navigator.userAgent||"";if(/Chrome/gi.test(t)&&!/Edge\//gi.test(t)){var i=t.match(/Chrome\/(\d+)/i),r=i?parseInt(i[1],10):0;e=!!r&&r>=75}return e}()&&Array.isArray(S)&&S.length>0){var k=S[0].media_time;k>0&&k<(u?u*h:5*h)&&(T=k)}var E=[],b=[],L=[],R=[],D=[],C=g.entries,O=m.entries,x=v.entrySizes,P=null==_?void 0:_.entries,I=null==y?void 0:y.entries,w=[],A={};!c&&(I&&I.forEach(function(e){for(var t=e.count,i=e.offset,r=0;r<t;r++)w.push(i)}),P&&P.forEach(function(e){A[e-1]=!0}));var B=0,M=0,N=0,U=0,H=C.length>0?C[0].samplesPerChunk:0,F=C.length>1&&C[1]?C[1].firstChunk-1:1/0,G=0,V=-1,j=!1,Z={};(null==I?void 0:I.length)>0&&T>0&&(G-=T,j=!0),t.editListApplied=j,c&&(eo=null==P?void 0:P.shift()),p.entries.forEach(function(e){for(var t=e.count,i=e.delta,r=0;r<t;r++){if(ea={dts:G,duration:i,size:x[B]||v.sampleSize,offset:O[M]+U,index:B},I&&(c?(function(e,t,i){i.offset=0;var r=(null==i?void 0:i.beforeFrameNum)||0,n=(null==i?void 0:i.usedCttsIdx)||0;if(!e||(null==e?void 0:e.length)<=0||(null==i?void 0:i.usedCttsIdx)>=e.length)i.offset=0,i.usedCttsIdx=n,i.beforeFrameNum=r;else{var a=e[n];if(t<r+((null==a?void 0:a.count)||1))i.offset=(null==a?void 0:a.offset)||0;else{var o=e[++n];o?(i.offset=o.offset||0,i.beforeFrameNum=r+a.count):(i.offset=0,i.beforeFrameNum=r+1),i.usedCttsIdx=n}}}(I,B,Z),ea.pts=G+((null==Z?void 0:Z.offset)||0)):w&&B<w.length&&(ea.pts=G+w[B])),0===T&&0===B&&(ea.pts=0),void 0===ea.pts&&(ea.pts=ea.dts),P){if(c?B+1===eo&&(ea.keyframe=!0,eo=P.shift()):ea.keyframe=A[B],ea.keyframe){if(V++,c){var a=new n.Z;a.appendFrame(ea),b.push(a)}else b.push([ea]),L.push(ea.duration)}else c?b[b.length-1].appendFrame(ea):(b[b.length-1].push(ea),L[b.length-1]+=ea.duration);ea.gopId=V,c&&b[b.length-1].calMinMaxPts(ea)}if(!c){if(ea.keyframe?R[R.length]=ea.pts:ea.pts<R[b.length-1]&&(R[b.length-1]=ea.pts),ea.keyframe)D[D.length]=ea.index;else if(b.length>0&&void 0!==D[b.length-1]){var o,s=null===(o=E[D[b.length-1]])||void 0===o?void 0:o.pts;void 0!==s&&ea.pts>s&&(D[b.length-1]=ea.index)}}E[E.length]=ea,G+=i,++B<H?U+=ea.size:(M++,U=0,M>=F&&(F=C[++N+1]?C[N+1].firstChunk-1:1/0),H+=C[N].samplesPerChunk)}});var q=E.length;if(!q||_&&!E[0].keyframe)return[];var K=[],Y=[],W=0,z=0,J=0,X=0,Q=function(e,t,i){es=Y[Y.length-1],c?(J=(null==b?void 0:b.length)>0?b[t].minPts:Y[0].pts,X=(null==b?void 0:b.length)>0?b[i].maxPts:es.pts+es.duration):(J=R[t],X=(el=E[D[i]]).pts+el.duration),0===K.length&&(e=(X-J)/h),K.push({index:K.length,startTime:J/h,endTime:X/h,duration:e,range:[Y[0].offset,es.offset+es.size-1],frames:Y}),1!==d&&(W=0),Y=[]},$=0;if(_){for(var ee,et,ei,er,en,ea,eo,es,el,eu,ed,ec=i*h,ef=0,eh=b.length;ef<eh;ef++)c?(W+=b[ef].dur,(eu=Y).push.apply(eu,(0,r.u)(b[ef].frames))):(W+=L[ef],(ed=Y).push.apply(ed,(0,r.u)(b[ef]))),ef+1<eh?(0===ef||W>ec)&&(Q(W/h,$,ef),W=0,$=ef+1):(Q(W/h,$,ef),W=0,$=ef+1)}else{!c&&(R=[],D=[]);var ep=o[0]||i;if(1===d)for(var eg,ev=0;ev<q;ev++){var em=E[ev],e_=E[ev+1],ey=ev===q-1;Y.push(em),W+=em.duration;var eT=eg||W/h;eg=(e_?W+e_.duration:0)/h,(ey||(s[K.length]?eg>s[K.length].endTime:eg-Y[0].pts/h>=ep))&&(!c&&(R.push(Y[0].pts),D.push(Y[Y.length-1].index)),Q(eT,K.length,K.length),ep=o[K.length]||i)}else for(var eS,ek=0;ek<q;ek++){var eE=E[ek],eb=E[ek+1],eL=ek===q-1;Y.push(eE),W+=eE.duration;var eR=eS||W/h;eS=(eb?W+eb.duration:0)/h,(eL||eS+z>=ep)&&(2===d?z+=W/h-ep:z+=eS-ep,!c&&(R.push(Y[0].pts),D.push(Y[Y.length-1].index)),Q(eR,K.length,K.length),ep=o[K.length]||i)}}return K}function s(e){var t="",i="",r=0,n=0,a=0,o=0,s=0,l=0,u=0;e.mvhd&&(s=e.mvhd.duration/e.mvhd.timescale);var d=e.trak;if(d){var c,f,h,p,g,v,m,_,y,T,S,k,E,b,L,R,D,C=d.find(function(e){var t,i;return(null===(t=e.mdia)||void 0===t?void 0:null===(i=t.hdlr)||void 0===i?void 0:i.handlerType)==="vide"}),O=d.find(function(e){var t,i;return(null===(t=e.mdia)||void 0===t?void 0:null===(i=t.hdlr)||void 0===i?void 0:i.handlerType)==="soun"}),x=null;return C&&(x=null===(f=C.mdia)||void 0===f?void 0:null===(h=f.minf)||void 0===h?void 0:null===(p=h.stbl)||void 0===p?void 0:p.stsd.entries[0])&&(r=x.width,n=x.height,l=null===(g=C.mdia)||void 0===g?void 0:null===(v=g.mdhd)||void 0===v?void 0:v.timescale,t=null===(m=x.avcC||x.hvcC||x.vvcC)||void 0===m?void 0:m.codec,"encv"===x.type&&(c=null===(_=x.sinf)||void 0===_?void 0:null===(y=_.schi)||void 0===y?void 0:y.tenc.default_KID)),O&&(x=null===(T=O.mdia)||void 0===T?void 0:null===(S=T.minf)||void 0===S?void 0:null===(k=S.stbl)||void 0===k?void 0:k.stsd.entries[0])&&(a=x.channelCount,o=x.sampleRate,i=null===(E=x.esds)||void 0===E?void 0:E.codec,u=null===(b=O.mdia)||void 0===b?void 0:null===(L=b.mdhd)||void 0===L?void 0:L.timescale,"enca"===x.type&&(c=c||(null===(R=x.sinf)||void 0===R?void 0:null===(D=R.schi)||void 0===D?void 0:D.tenc.default_KID))),{kid:c?c.join(""):null,videoCodec:t,audioCodec:i,width:r,height:n,videoTimescale:l,audioChannelCount:a,audioSampleRate:o,duration:s,audioTimescale:u,moov:e}}}function l(e){return"number"==typeof e&&!Number.isNaN(e)}function u(e){if(!e)return!1;var t=e.audioSegments,i=e.videoSegments,r=!i||0===i.length,n=!t||0===t.length;return(!r||!n)&&!0}}}]);