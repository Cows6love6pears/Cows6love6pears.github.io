<!DOCTYPE html>
<!-- saved from url=(0091)https://lf-zt.douyin.com/obj/uc-assets/zt/@byted/x-storage-web/4.0.3/dist/latest/index.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Web-Cross-Storage</title><script defer="defer">!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("WebCrossOriginStorage",[],t):"object"==typeof exports?exports.WebCrossOriginStorage=t():e.WebCrossOriginStorage=t()}(self,(function(){return function(){"use strict";var e={d:function(t,n){for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})}};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},e.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var t={};e.r(t),e.d(t,{WebCrossOriginStorage:function(){return pe},version:function(){return $},webStorage:function(){return we}});var n,o,i=(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function o(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),r=function(e){function t(t,n,o){var i=e.call(this,n)||this;return i.message=n||"",i.name=t,i.origin=o||location.origin,i}return i(t,e),t}(Error),s=function(){function e(){this.callMap={}}return e.prototype.define=function(e,t){this.callMap[e]=t()},e.prototype.thunk=function(e){var t=this.callMap[e];return"function"==typeof t?t:function(){"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("The `".concat(String(e),"` is a noop thunk."))}},e}(),a=s,c=function(){function e(){this.eventMap={}}return e.prototype.on=function(e,t){var n=this.eventMap;n[e]?n[e].push(t):n[e]=[t]},e.prototype.off=function(e,t){var n=this.eventMap;if(n[e])for(var o=n[e],i=o.length;i>=0;i--)t&&o[i]!==t||o.splice(i,1)},e.prototype.emit=function(e,t){var n=this.eventMap[e];n&&function(e,t,n){if(n||2===arguments.length)for(var o,i=0,r=t.length;i<r;i++)!o&&i in t||(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return e.concat(o||Array.prototype.slice.call(t))}([],n,!0).forEach((function(e){e(t)}))},e.prototype.has=function(e,t){var n=this.eventMap;return!!n[e]&&("function"!=typeof t||-1!==n[e].indexOf(t))},e}(),l=c,h="undefined"!=typeof globalThis?globalThis:void 0!==e.g?e.g:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{};h.$$CallThunkInstance||(h.$$CallThunkInstance=((o=new a).channel=new l,o)),h.$$CallThunkInstance,h.$$CallThunkInstance;const m={},g={},u=()=>{try{return indexedDB||window.indexedDB||webkitIndexedDB||mozIndexedDB||OIndexedDB}catch(e){return}},d="DBStorageNotSupport";let f=Promise.resolve(),y=0;const v=e=>new Promise(((t,n)=>{e.onsuccess=()=>{t(e.result)},e.onerror=()=>{n(e.error)}})),p=(e,t)=>new Promise(((n,o)=>{e.oncomplete=()=>{n()},e.onabort=e.onerror=()=>{var e;const n=t?t.error||(null==(e=t.transaction)?void 0:e.error):{name:"TransactionAbortOrError",message:""};o(new r((null==n?void 0:n.name)||"TransactionAbortOrError",(null==n?void 0:n.message)||""))}}));var w;class b{constructor(e){this.config={dbName:"secure-store",storeName:"cryptvalues",closeDBTime:2e4},this.getItem=e=>this.getItemByKeys([e]).then((e=>e[0])),this.getItemByKeys=e=>{const{storeName:t}=this.config;return this.transaction((()=>this.openDB().then((n=>{const o=n.transaction(t,"readonly").objectStore(t);return Promise.all(e.map((e=>v(o.get(e)).then((e=>{const{data:t}=JSON.parse(e||"{}");return t})))))}))))},this.setItem=(e,t)=>this.setItemByKeys([[e,t]]).then((e=>e[0])),this.setItemByKeys=e=>{const{storeName:t}=this.config;return this.transaction((()=>this.openDB().then((n=>{const o=n.transaction(t,"readwrite"),i=o.objectStore(t);return Promise.all(e.map((e=>{let[t,n]=e;const o=JSON.stringify({data:n});return v(i.get(t)).then((e=>(e!==o&&i.put(o,t),n)))}))).then((e=>p(o).then((()=>e))))}))))},this.removeItem=e=>{const{storeName:t}=this.config;return this.openDB().then((n=>{const o=n.transaction(t,"readwrite"),i=o.objectStore(t).delete(e);return p(o,i)}))},this.getKeys=()=>{const{storeName:e}=this.config;return this.transaction((()=>this.openDB().then((t=>{const n=t.transaction(e).objectStore(e).openKeyCursor();return new Promise(((e,t)=>{const o=[];n.onsuccess=()=>{n.result?(o.push(n.result.key),n.result.continue()):e(o)},n.onerror=()=>{t(n.error)}}))}))))},this.openDB=()=>{const{storeName:e,dbName:t,closeDBTime:n}=this.config;return clearTimeout(g[t]),g[t]=setTimeout((()=>{b.closeDB(t).catch((()=>{}))}),n),b.openDB(this.config).then((n=>{if(!n.objectStoreNames.contains(e)){const e=n.version+1;return b.closeDB(t).then((()=>b.openDB(this.config,e)))}return n}))},this.transaction=e=>{const{dbName:t,onQuotaErrorCallback:n}=this.config;return((e,t,n)=>f=f.then((()=>{const o=()=>t().then((e=>(y=0,e))).catch((t=>{if(y<3)return y++,m[e]=void 0,((e,t)=>{const n=((null==t?void 0:t.name)||"").toLowerCase()==="QuotaExceededError".toLowerCase();return Promise.resolve({isQuotaError:n,clean(t){const n=u(),o=null==n?void 0:n.deleteDatabase(t||e);return new Promise((e=>{o?(o.onsuccess=()=>{e()},o.onerror=()=>{e()}):e()}))}})})(e,t).then((e=>n(e.isQuotaError,e.clean))),o();throw y=0,t}));return o()})))(t,e,((e,t)=>{e&&"function"==typeof n&&n.call(this,t)}))},this.config={...this.config,...e||{}}}}w=b,b.isSupport=()=>Boolean(u()),b.openDB=(e,t)=>{const{dbName:n,storeName:o,version:i}=e;if(t&&(m[n]=void 0),!w.isSupport())return Promise.reject(new r(d));const s=u(),a=(e,t)=>new Promise(((n,i)=>{const a=s.open(e,t);a.onsuccess=()=>{n(a.result)},a.onerror=e=>{var t,n;e.preventDefault(),i(new r((null==(t=a.error)?void 0:t.name)||"IndexedDBOpenError",null==(n=a.error)?void 0:n.message))},a.onupgradeneeded=e=>{try{(a.result||e.target.result).createObjectStore(o)}catch(e){i(e)}}}));return m[n]||(m[n]=new Promise(((e,o)=>{try{a(n,t||i||1).catch((e=>{if(S(e))return C(n).then((e=>e?a(n,e):a(n))).catch((()=>a(n)));throw e})).then(e).catch(o)}catch(e){o(new r(d,e.message))}})))},b.deleteDB=e=>{const t=u();return t?w.closeDB(e).then((()=>{if(null!=t&&t.deleteDatabase){const n=null==t?void 0:t.deleteDatabase(e);if(n)return clearTimeout(g[e]),new Promise(((e,t)=>{n.onsuccess=()=>{e(n.result)},n.onerror=()=>{t(null==n?void 0:n.error)}}))}return Promise.reject(new r("IDBDeleteDataBaseError"))})):Promise.reject(new r("IDBObjectError"))},b.closeDB=e=>new Promise(((t,n)=>{m[e]?m[e].then((o=>{(()=>{m[e]=void 0;try{o.close(),t(1)}catch(e){n(e)}})()})).catch(n):t(-1)}));var I=b;const S=e=>"versionerror"===((null==e?void 0:e.name)||"").toString().toLowerCase()&&(!(-1===((null==e?void 0:e.message)||"").indexOf("version")&&!((null==e?void 0:e.message)||"").match(/\s*less\s*than/i)&&-1===((null==e?void 0:e.message)||"").match(/\s*higher\s*version\s*than\s*/gi))||void 0),C=e=>new Promise(((t,n)=>{const o=u();if(null!=o&&o.databases)return o.databases().then((n=>{const o=n.filter((t=>t.name===e))[0];t(null==o?void 0:o.version)})).catch(n);n(new Error("idb.database is "+typeof(null==o?void 0:o.databases)))}));class B{constructor(){this.getItem=e=>this.getItemByKeys([e]).then((e=>e[0])),this.setItem=(e,t)=>this.setItemByKeys([[e,t]]).then((e=>e[0])),this.getItemByKeys=e=>this.openLocalStorage().then((t=>e.map((e=>{const{data:n}=JSON.parse(t.getItem(e)||"{}");return n})))),this.setItemByKeys=e=>this.openLocalStorage().then((t=>e.map((e=>{let[n,o]=e;const i=JSON.stringify({data:o});return t.setItem(n,i),o})))),this.removeItem=e=>this.openLocalStorage().then((t=>{t.removeItem(e)})),this.getKeys=()=>this.openLocalStorage().then((e=>{const t=[];for(let n=0;n<e.length;n++)e.key(n)&&t.push(e.key(n));return t})),this.openLocalStorage=()=>B.isSupport()?Promise.resolve(P()):Promise.reject(new r("LocalStorageNotSupport"))}}B.isSupport=()=>{const e=P();if(!e)return!1;try{const t="__x_storage_test__";e.setItem(t,t);const n=e.getItem(t);return e.removeItem(t),t===n}catch(e){return!1}};const P=()=>window.localStorage;var T=B;const E={};class O{constructor(){this.getItem=e=>this.getItemByKeys([e]).then((e=>e[0])),this.setItem=(e,t)=>this.setItemByKeys([[e,t]]).then((e=>e[0])),this.getItemByKeys=e=>this.openMStorage().then((t=>e.map((e=>{const{data:n}=JSON.parse(t.getItem(e)||"{}");return n})))),this.setItemByKeys=e=>this.openMStorage().then((t=>e.map((e=>{let[n,o]=e;const i=JSON.stringify({data:o});return t.setItem(n,i),o})))),this.removeItem=e=>this.openMStorage().then((t=>{t.removeItem(e)})),this.getKeys=()=>this.openMStorage().then((()=>Object.keys(E))),this.openMStorage=()=>Promise.resolve({setItem(e,t){E[e]=`${t}`},getItem(e){return E[e]||null},removeItem(e){delete E[e]}})}}O.isSupport=()=>!0;var K=O,$="4.0.3";function M(){var e,t;try{return Boolean(navigator.userAgent.match(/chrome\/[\d.]+/gi))&&Boolean(null===navigator||void 0===navigator?void 0:navigator.userAgentData)||Boolean(null===(e=navigator.storage)||void 0===e?void 0:e.getDirectory)||Boolean(navigator.canShare)||-1!==((null===(t=window.Promise)||void 0===t?void 0:t.allSettled)||"").toString().indexOf("[native code]")&&Boolean(Number((navigator.userAgent.match(/Chrome\/(\d+\.+\d+)/)||[])[1])>=76&&window.visualViewport)}catch(e){return!1}}const k=M(),D="https://lf-zt.douyin.com",_=`${D}/obj/uc-assets/zt/`,x=`${D}/obj/uc-web/zt/`,L=(e,t,n)=>`${e}@byted/x-storage-web/${t||$}/dist/${n||(k?"latest":"page")}/index.html`,N=window,j=N.addEventListener,R=N.removeEventListener,W=N.location,A=document,F=()=>W.origin===D,J=()=>performance.now&&Number(performance.now().toFixed(0))||Date.now(),U=e=>{const t=e.split("//")||[];return`${t[0]}//${t[1].split("/")[0]}`},Q=(e,t)=>-1!==e.indexOf("html?")?`${e}&${t}`:`${e}?${t}`,V=(e,t)=>{let n=Promise.reject(new r("WebStorageRunSerialQueueError"));for(let o=0;o<e.length;o++)n=n.then((n=>"function"==typeof t&&t(n)||void 0===n?e[o]():n)).catch((()=>e[o]()));return n},X=e=>{let t=Promise.reject(new r("WebStorageRunSerialQueueIfOneResolveError"));for(let n=0;n<e.length;n++)e[n]&&(t=t.then((t=>(e[n]().catch((e=>{})),t))).catch((t=>e[n]())));return t},z=function(e,t){return void 0===e&&(e=()=>{}),void 0===t&&(t={}),()=>{const{timeout:n=3e3}=t;return Promise.race([new Promise((e=>{setTimeout((()=>{e(t.result||{})}),n)})),e()])}},q=`J_uc_iframe_box-${Date.now()}`,H=()=>new Promise((e=>{const t=A.body,n={appendChild(e){(()=>{const e=document.getElementById(q);if(e)return e;const t=document.createElement("div");return t.style.display="none",t.id=q,A.body.appendChild(t),t})().appendChild(e)}};t?e(n):"loading"===A.readyState?A.addEventListener("DOMContentLoaded",(()=>{e(n)})):e(n)})),G=function(e){return void 0===e&&(e=0),new Promise((t=>{setTimeout((()=>{N.requestIdleCallback?N.requestIdleCallback((()=>{t()})):t()}),e)}))};let Y,Z=!1;const ee=e=>{try{F()&&window.parent.postMessage(`log:${e}`,"*")}catch(e){}},{origin:te}=W;class ne extends c{constructor(e){super(),this.config=void 0,this.db=void 0,this.fallbackDB=void 0,this.localDB=void 0,this.dbSetFlag=[],this.getItem=e=>this.getItemByKeys([e]).then((e=>e[0])),this.setItem=(e,t)=>this.setItemByKeys([[e,t]]).then((e=>e[0])),this.getItemByKeys=e=>{let t=-1;const n=[];return this.db.then((t=>V(t.map(((t,o)=>()=>t.getItemByKeys(e).then((t=>(n[o]=e.map(((e,n)=>({from:void 0!==t[n]?o:-1,value:t[n],origin:te}))),t))))),(e=>{for(let t=0;t<(null==e?void 0:e.length);t++)if(void 0===e[t])return!0;return!1})))).catch((n=>this.fallbackDB.getItemByKeys(e).then((e=>(t=2,e))))).then((e=>n[0]?n[0].map(((e,t)=>void 0!==e.value?e:n[1]&&n[1][t]?void 0===n[1][t].value?e:n[1][t]:e)):n[1]?n[1]:e.map((e=>({value:e,from:t,origin:te})))))},this.setItemByKeys=e=>{let t=-1;return this.db.then((n=>X(n.map(((n,o)=>()=>n.setItemByKeys(e).then((e=>(t=o,e)))))).catch((n=>(t=2,this.fallbackDB.setItemByKeys(e)))).then((e=>e.map((e=>({value:e,from:t,origin:te}))))))).then((e=>e),(e=>{throw ee(`storage:setItemByKeys:error:${null==e?void 0:e.message}`),e}))},this.removeItem=e=>this.db.then((t=>Promise.all(t.map((t=>t.removeItem(e)))).then((()=>this.fallbackDB.removeItem(e))))),this.config=e||{};const t=this;this.localDB=new T,this.db=Promise.resolve([this.localDB,new I({...(null==e?void 0:e.dbStorage)||{},onQuotaErrorCallback(){t.emit("log",{name:"QuotaError"})}})]),this.fallbackDB=new K}getKeys(){return this.db.then((e=>V(e.map((e=>()=>e.getKeys())),(e=>void 0===e||0===e.length))))}}const oe=["security-sdk/s_sdk_crypt_sdk","security-sdk/s_sdk_cert_key","security-sdk/s_sdk_sign_data_key/web_protect"],ie={get visibility(){return document.visibilityState}},re={current:0,max:2},se="visibilitychange",ae=()=>"hidden"===document.visibilityState;class ce extends c{constructor(e){var t;super(),t=this,this.config=void 0,this.autoLoadIframeConfig={max:10,current:0,iframeLoadPromise:null},this.reset=()=>{const{autoLoadIframeConfig:e}=this;e.current>=e.max&&(e.max+=10),e.iframeLoadPromise=null,re.current>=re.max&&(re.max+=3)},this.loadWindow=()=>{const{url:e,ackTimeout:t}=this.config,{autoLoadIframeConfig:n}=this;return new Promise((e=>{const t=0===n.current?0:100;setTimeout(e,t)})).then((()=>{if(!e)throw new Error("URL Error");const o=n.current===n.max?Q(e,`t=${Date.now()}`):e;return this.createIframeElement(o,t)})).catch((e=>{if(n.current>=n.max){if(ae())return new Promise((e=>{const t=()=>{ae()||(document.removeEventListener(se,t),e(1))};document.addEventListener(se,t)})).then((()=>this.loadWindow().then((e=>(this.emit("log",{name:"visibilityChangeLoadWindowSuccuess"}),e)))));const n=(()=>{const e=(()=>{try{return localStorage.getItem("X_STORAGE_FALLBACK_VERSION")}catch(e){}})();if(e)return L(_,e)})();if(n)return this.emit("debug",{name:"StartFireFallbackURL",content:n}),this.createIframeElement(n,t).then((e=>(this.emit("debug",{name:"EndFireFallbackURL",content:n}),e.fallback=!0,e))).catch((t=>{throw this.emit("debug",{name:"fireFallbackURLError",content:`${null==t?void 0:t.name}:${null==t?void 0:t.message}`}),e}));throw e}return n.current++,this.loadWindow()}))},this.createPostMessageFlight=function(e,n){void 0===n&&(n=3e3);const o=J();let i,s=o;const a=e=>{t.config.debug&&t.emit("metrics",{name:"PostMessageFlight",metrics:{startTime:o,endTime:s,loadTime:s-o},categories:{status:e,retryCount:String(re.current),version:$}})};return Promise.race([new Promise(((t,n)=>{const o=`ACK_0_${Math.random()}`,a=e=>{e.data===`ACK_1_${o}`&&(clearTimeout(i),s=J(),t(),R("message",a))};j("message",a);try{e(o)}catch(e){n(new r("PostMessageWindowError",null==e?void 0:e.message))}})),new Promise(((e,t)=>{i=setTimeout((()=>{s=J(),t(new r("PostMessageTimeout"))}),n)}))]).then((()=>{a("1")})).catch((e=>{throw a("0"),e}))},this.config={ackTimeout:2e3,...e||{}}}setConfig(e){this.config={ackTimeout:e.ackTimeout||this.config.ackTimeout,url:e.url||this.config.url}}start(){const{autoLoadIframeConfig:e}=this;return e.iframeLoadPromise=e.iframeLoadPromise||this.loadWindow()}createIframeElement(e,t){const n=t||this.config.ackTimeout,{autoLoadIframeConfig:o}=this,i=J(),s=A.createElement("iframe");let a,c,l,h=i,m=!1,g=-1;return s.style.display="none",s.src=e,H().then((t=>{const u=Promise.race([new Promise(((e,t)=>{s.onload=()=>{h=J(),m||(c=setTimeout((()=>{m||t(new r("CreateIframeError",JSON.stringify({startTime:i,endTime:h,loadTime:h-i,...ie,current:o.current,max:o.max})))}),n||2e3))}})),new Promise(((t,n)=>{const o=i=>{try{-1===g&&"ACK"===i.data&&U(e)===i.origin&&(m=!0,a=i.source,clearTimeout(c),clearTimeout(l),t(),R("message",o))}catch(e){n(e)}};j("message",o)})),new Promise(((e,t)=>{l=setTimeout((()=>{t(new r("CreateIframeMainTimeout"))}),12e4)}))]);return t.appendChild(s),u})).then((()=>this.createPostMessageFlight((t=>{const n=U(e);(s.contentWindow||a).postMessage(t,n)})).catch((e=>{if("PostMessageWindowError"!==e.name)throw e;if(re.current<re.max)throw re.current++,e})))).then((()=>{if(s.parentNode)return g=1,{startTime:i,endTime:J(),postMessage(e,t){(s.contentWindow||a).postMessage(e,t||"*")},destory:()=>{try{var e;null==(e=s.parentNode)||e.removeChild(s)}catch(e){}},isValid(){var e;return Boolean((null==s?void 0:s.parentNode)&&(null==s||null==(e=s.parentNode)?void 0:e.parentNode))}};throw new Error("CreateIframeElementError")})).catch((e=>{g=0;try{var t;null==(t=s.parentNode)||t.removeChild(s)}catch(e){}try{"CreateIframeMainTimeout"===e.name&&this.emit("debug",{name:"CreateIframeMainTimeout"})}catch(e){}throw e}))}}const le=e=>`p-${e}`,he=`.${location.origin.split(".").slice(-2).join(".")}`;class me extends c{constructor(e){var t;super(),t=this,this.window=void 0,this.isStart=void 0,this.isConnection=void 0,this.iframeConnection=void 0,this.config={protocol:"Common"},this.loadTime=0,this.startTime=0,this.endTime=0,this.callParentBridgetIndex=0,this.listen=()=>{window.parent!==window&&window.parent.postMessage("ACK","*")},this.getIframeState=()=>({isConnection:"boolean"==typeof this.isConnection?Number(Boolean(this.isConnection)):-1,retryCount:this.iframeConnection.autoLoadIframeConfig.current,startTime:this.startTime,endTime:this.endTime,loadTime:this.loadTime,origin:location.origin}),this.postIframeMessage=e=>{const{protocol:t}=this.config;if(this.window){const{url:n}=this.config;return this.window.catch((e=>this.reConnection())).then((o=>{let{target:i}=o;i.postMessage({protocol:t,data:e},U(n))}))}return Promise.reject(new r("postMessageError"))},this.postWindowMessage=function(e,n,o,i){void 0===i&&(i="*");const{protocol:r}=t.config;return new Promise((t=>{e.postMessage({type:n,protocol:r,data:o},i),t()}))},this.postParentMessage=function(e,n,o){void 0===o&&(o="*");const i=N.parent;return i!==N?t.postWindowMessage(i,e,n,o):Promise.resolve()},this.dispatchParentEvent=(e,t)=>this.postParentMessage("event",{id:le(this.callParentBridgetIndex++),message:{eventName:e,eventData:t}}),this.callParentBridge=(e,t,n)=>{const o=le(this.callParentBridgetIndex++);return Promise.race([new Promise(((i,s)=>{const a=e=>{const t=e.data;t.id===o&&(this.off("message",a),"reject"===t.promiseStatus?s(new r(`${t.message||"UNKNOW_CallParentBridge_Error"}`)):i(t.message))};this.on("message",a),this.postParentMessage("function",{id:o,message:{callObj:e,callName:t,callArgs:n}}).catch(s)})),new Promise(((n,o)=>{setTimeout((()=>{o(new r("CallParentBridgeInvokeTimeout",`CallBridge invoke timeout: callObj=${e};callName=${t};`))}),5e3)}))])},this.startConnection=e=>{const{url:t}=this.config;!this.window&&t&&(this.isStart=!0,this.isConnection=void 0,this.emit("log",{name:`startConnection:${e}`}),this.createConnection(t))},this.reStartConection=e=>{this.isStart=!1,this.window&&this.window.then((e=>{let{target:t}=e;return t.destory()})).catch((()=>{})),this.window=void 0,this.iframeConnection.reset(),this.startConnection(e)},this.start=e=>new Promise((t=>{this.config={...this.config||{},...e||{}},this.isStart=!0,this.emit("config"),t()})),this.reConnection=()=>{const{url:e}=this.config;return this.createConnection(e)},this.preCheck=()=>this.isConnection&&this.isStart&&this.window?this.window.then((e=>{let{target:t}=e;t.isValid()||this.reStartConection("valid")})):(!this.config.disablePreCheckConnection&&!1===this.isConnection&&this.iframeConnection.autoLoadIframeConfig.current>=this.iframeConnection.autoLoadIframeConfig.max&&this.reStartConection("reConnection"),Promise.resolve()),this.onMessage=e=>{const t=(t,n)=>{try{var o;null==(o=e.source)||o.postMessage(`SOCKET_ERROR_${t}@${n}`,e.origin)}catch(e){}};try{const{url:s,protocol:a,allowOrigin:c=[]}=this.config,l=!!s&&U(s)===e.origin,h=s?l:Boolean([he,...c].filter((t=>-1!==e.origin.lastIndexOf(t)))[0]);try{e.origin||this.emit("debug",{name:"eventLostOrigin",content:JSON.stringify(e.data||{})})}catch(e){}var n;if(h)if("string"==typeof e.data&&0===e.data.indexOf("ACK_0_"))try{var o;null==(o=e.source)||o.postMessage(`ACK_1_${e.data}`,e.origin)}catch(e){}else if((null==(n=e.data)?void 0:n.protocol)===a)try{var i,r;this.emit("message",{type:null==(i=e.data)?void 0:i.type,data:null==(r=e.data)?void 0:r.data,origin:e.origin,sourceWindow:e.source})}catch(n){t(500,JSON.stringify(e.data)),this.emit("debug",{name:`postMessage:protocol:error:${null==n?void 0:n.message}`})}}catch(e){t(501,`${e.message}`),this.emit("debug",{name:"SomePostMessageEventError",content:null==e?void 0:e.message})}},this.initMessageEvent=()=>{this.removeMessageEvent(),window.addEventListener("message",this.onMessage),this.emit("debug",{name:"initMessageEvent"})},this.removeMessageEvent=()=>{window.addEventListener("message",this.onMessage)},this.config={...this.config,...e||{}},this.iframeConnection=new ce,this.startConnection("init"),this.on("config",(()=>{this.startConnection("config")})),this.initMessageEvent(),this.on("connection",(e=>{this.loadTime=e.endTime-e.startTime,this.startTime=e.startTime,this.endTime=e.endTime,this.isConnection=!0,this.config.enableFallback&&!e.target.fallback&&(e=>{try{localStorage.setItem("X_STORAGE_FALLBACK_VERSION",e)}catch(e){}})($),this.emit("debug",{name:"ConnectionSuccess"}),this.initMessageEvent()})),this.iframeConnection.on("debug",(e=>{this.emit("debug",e)})),this.iframeConnection.on("log",(e=>{this.emit("log",e)})),this.iframeConnection.on("metrics",(e=>{this.emit("metrics",e)})),this.on("connectionFail",(e=>{const{downgradeCSPURL:t}=this.config;if(this.isConnection=!1,this.emit("error",new r(`Connection:${e.name}`,e.message)),this.emit("debug",{name:"connectionFail"}),t&&-1!==(null==e?void 0:e.message.indexOf("Content Security Policy"))){const e="string"==typeof t?t:L(_,undefined,"page");e&&this.config.url!==e&&(this.emit("debug",{name:"fireDefaultPageURL",content:e}),this.config.url=e,this.reStartConection("csp"))}})),j("message",(e=>{"string"==typeof e.data&&(-1!==e.data.indexOf("SOCKET_ERROR_")?this.emit("error",new r("SCOKET_ERROR",e.data)):-1!==e.data.indexOf("Version:")&&this.emit("debug",{name:"SocketVersion",content:e.data.split(":")[1]}))}))}createConnection(e){const{ackTimeout:t}=this.config,n=J(),{max:o}=this.iframeConnection.autoLoadIframeConfig;this.iframeConnection.setConfig({url:o>10?Q(e,`t=${o}`):e,ackTimeout:t});const i=this.iframeConnection.start().then((e=>{const t=J(),o={target:e,startTime:n,endTime:t};return this.emit("connection",{...o}),o})).catch((e=>{throw this.emit("connectionFail",new r(`${e.name||"ConnectionError"}`,e.message)),e}));return this.window=i}}const ge=e=>t=>e.then((e=>Promise.resolve(t()).then((()=>e))),(e=>Promise.resolve(t()).then((()=>{throw e}))));let ue=null,de=-1,fe=0;const ye={},ve=function(e,t,n){void 0===t&&(t=!1),void 0===n&&(n=8e3);const o=e.postIframeMessage;return(i,s,a)=>{let c;const l=fe++,h=(e=>`${e}`)(l);let m=!1;if("string"!=typeof i||"string"!=typeof s)return Promise.reject(new r("CallBridgeParameterError",`callObj:${i}, callName:${s}`));const g=t=>(e.emit("debug",{name:`PostMessageId=${h}`,content:`${i}:${s}`}),ye[h]={},ye[h].st=J(),Promise.race([e.window.then((()=>new Promise(((t,n)=>{const l=o=>{try{(()=>{const i=o.data;i.id===h&&ye[h]&&!ye[h].et&&(ye[h].et=J(),e.emit("debug",{name:`BackPostMessageId=${h}`}),clearTimeout(c),e.off("message",l),"reject"===i.promiseStatus?n(new r(`${i.message||"UNKNOW_CallBridge_Error"}`)):t(i.message),delete ye[h])})()}catch(e){n(e)}};e.on("message",l),((e,t)=>o({id:e,message:t}))(h,{callObj:i,callName:s,callArgs:a}).catch(n)})))),new Promise(((n,o)=>{c=setTimeout((()=>{m=!0,ye[h].timeout=J(),o(new r(`CallBridgeInvokeTimeout:${i}:${s}`,`${JSON.stringify({iframe:e.getIframeState(),id:h})}`))}),t)}))]));return e.preCheck().then((()=>g(n))).catch((n=>{if(!0===e.isConnection&&t&&-1!==((null==n?void 0:n.name)||"").indexOf("CallBridgeInvokeTimeout")){const t=l<de,n=fe;return e.emit("debug",{name:"reCallBridgeWhenTimeout",content:JSON.stringify({isTimeoutId:t,$MessageId:n,$id:l,callName:s,reCallBridgeWhenTimeout:Boolean(ue)})}),ue=ue&&t?ue:new Promise((t=>{de=n,(e=>{!Z&&e.config.debug&&(Z=!0,e.emit("debug",{name:"OpenMessageLog"}),window.addEventListener("message",Y=t=>{const{data:n}=t;Z&&"string"==typeof n&&0===n.indexOf("log:")&&e.emit("debug",{name:`Message:Log=${n.substring(4)}`})}))})(e),e.reStartConection("callBridge"),t()})),ue.then((()=>g(8e3)))}throw n}))}};class pe extends c{constructor(e){super(),this.config=void 0,this.client=void 0,this.storage=void 0,this.storageX=void 0,this.sign=void 0,this.logger=void 0,this.listen=()=>{this.client.listen()},this.setConfig=e=>new Promise((t=>{this.config={...this.config||{},...e},this.emit("config",this.config),t()})),this.startStorageChecker=()=>new Promise((e=>{this.client.isConnection?e():this.client.on("connection",(()=>{e()}))})).then((()=>ve(this.client,!0,3e3)("config","startChecker",[]))),this.startChecker=()=>new Promise(((e,t)=>{const{startStorageCheckerCallBack:n}=this.config||{};null==n||n(),e()})),this.setOriginStorageConfig=e=>new Promise((e=>{this.client.isConnection?e():this.client.on("connection",(()=>{e()}))})).then((()=>{const{url:t}=this.client.config;if(t)return ve(this.client,!0,3e4)("config","setConfig",[e]);throw new Error("NoOriginStorageURL")})),this.setItem=(e,t,n)=>this.setItemByKeys([[e,t]],n).then((e=>e[0])),this.getItem=(e,t)=>this.getItemByKeys([e],t).then((e=>e[0])),this.getItemByKeys=(e,t)=>{const{async:n,logger:o=!0}=t||{};let i=J(),r=0,s=0,a=-1,c={},l=()=>{if(o)try{r=r||J(),s=s||r,this.emit("metrics",{name:"getOriginItemByKeys",metrics:{duration:r-i,callTime:r-s,startCallTime:s,startTime:i,endTime:r},categories:{status:String(a),...c}})}catch(e){}};const h=t=>{a=a>-1?a:1;try{t.forEach(((t,n)=>{["from","origin","status","code"].forEach((o=>{const i=e[n],r=i.split("/"),s=String("status"===o?t.value?1:0:t[o]);"undefined"!==s&&(c[`${r[1]||i}_${o}`]=s)}))}))}catch(e){}},m=()=>{const{url:t}=this.client.config;s=J();const o=()=>ve(this.client)("storage","getItemByKeys",[e]).then((t=>(r=J(),a=2,Promise.all(t.map(((t,n)=>(void 0===t.value&&(a=3),void 0===t.value?this.storage.getItem(e[n]):t)))))));return t?void 0!==n?Promise.race([o(),new Promise((e=>{setTimeout(e,"number"==typeof n?n:1e3)})).then((()=>this.storage.getItemByKeys(e)))]):X([o,()=>this.storage.getItemByKeys(e).then((e=>e.map((e=>(e.code=1001,e)))))]):this.storage.getItemByKeys(e)},g=()=>ge(m().catch((()=>this.storage.getItemByKeys(e))).then((e=>(h(e),e))).catch((e=>{throw a=0,e})))(l);return this.getLocalItemWithSignByKeys(e).then((e=>{let{values:t,st:n,et:o}=e;return i=n,r=o,a=12,h(t),l(),t})).catch((()=>g()))},this.setItemByKeys=(e,t)=>{const{async:n,logger:o=!0}=t||{},i=J();let s=0,a=-1,c=0,l=0,h={},m={end:!1,sync:!1,resolve:()=>{}};const g=t=>{a=a>-1?a:1;try{t.forEach(((t,n)=>{["from","origin","status"].forEach((o=>{const i=e[n][0],r=i.split("/");h[`${r[1]||i}_${o}`]=String("status"===o?t.value?1:0:t[o])}))}))}catch(e){}};new Promise((e=>{m.resolve=e})).then((()=>{if(o)try{s=s||J(),this.emit("metrics",{name:"setOriginItemByKeys",metrics:{duration:s-i,callTime:s-l,startCallTime:l,startTime:i,endTime:s,retryCount:c},categories:{status:String(a),...h}})}catch(e){}}));let u=e=>{m[e]=!0,m.end&&m.sync&&m.resolve()};return ge((e=>{const{url:t}=this.client.config;l=J();const o=t=>ve(this.client,!0,t)("storage","setItemByKeys",[e]).then((e=>(a=2,g(e),s=J(),e)));return t?void 0!==n?Promise.race([ge(o(3e4).catch((e=>{const t=`${null==e?void 0:e.name}@${null==e?void 0:e.message}`;return c++,o().catch((n=>{throw this.emit("log",{name:"callBridgeSetItemByKeysRetryError",content:JSON.stringify({iframe:this.client.getIframeState(),errorMessage:t})}),console.log("callBridgeSetItemByKeysRetryError",n),e}))})))(u.bind(null,"sync")),new Promise((e=>{setTimeout(e,"number"==typeof n?n:1e3)})).then((()=>this.storage.setItemByKeys(e)))]):(e=>{let t=Promise.reject(new r("WebStorageRunSerialQueueIfOneResolveError"));for(let n=0;n<e.length;n++)e[n]&&(t=t.then((t=>e[n]().catch((e=>Promise.resolve(t))))).catch((t=>e[n]())));return t})([z((()=>ge(o())(u.bind(null,"sync"))),{timeout:2500,result:[{value:"timeout",from:"timeout",origin:"timeout"}]}),()=>this.storage.setItemByKeys(e)]):this.storage.setItemByKeys(e)})(e).catch((()=>this.storage.setItemByKeys(e))).catch((e=>{throw a=0,e})).then((e=>(g(e),e))))(u.bind(null,"end"))},this.removeItem=e=>{const{url:t}=this.client.config;return t?Promise.all([this.storage.removeItem(e),ve(this.client)("storage","removeItem",[e])]).then((()=>{})):this.storage.removeItem(e)},this.getLocalItemWithSignByKeys=e=>{var t;if(null!=(t=this.sign)&&t.verify&&((e,t)=>{for(let n=0;n<e.length;n++)if(-1===t.indexOf(e[n]))return!1;return!0})(e,oe)){const t=J();return this.storage.localDB.getItemByKeys(oe).then((n=>this.sign.verify(n).then((t=>{if(t)return e.map((e=>({value:n[oe.indexOf(e)],origin:location.origin,from:0,code:304})));throw new Error("VerifySignFail")})).then((e=>{const n=J();return{values:e,st:t,et:n}}))))}return Promise.reject(new Error("NotVerifySignFunction"))},this.initBirdgeEvent=()=>{this.client.on("message",(e=>{let{data:t,origin:n,type:o,sourceWindow:i}=e;const{id:s}=t||{};if("event"===o){const{eventName:e,eventData:n}=t.message||{};if("error"===e)this.emit("error",new r(n.name,n.message,n.origin));else if("log"===e)return this.emit("log",n)}else{const{callObj:e,callName:o,callArgs:r=[]}=t.message||{},a=(e,t)=>this.client.postWindowMessage(i,"function",{id:s,promiseStatus:e,message:t},n);if(-1!==["storage","storageX","client","sign","config","logger"].indexOf(e))try{ee(`${e}-${o}`),(-1!==["storage","config"].indexOf(e)?this:this[e])[o].apply(this,r).then(a.bind(null,"resolve")).catch((e=>{a("reject",e.name||e.message||"UnknowMessageError").catch((()=>{}))}))}catch(e){a("reject","UnknowMessageError").catch((()=>{}))}}}))},this.config={debug:!1,hostname:location.hostname,...e||{}},this.client=new me({...this.config.scoket||{},protocol:this.config.protocol,allowOrigin:this.config.allowOrigin,debug:this.config.debug,url:this.config.url}),this.storage=new ne(this.config.storage),this.storageX=this.storage,this.config.verifySignMethod&&(this.sign={...this.sign||{},verify:e=>Promise.resolve(this.config.verifySignMethod(e))}),this.logger={metrics:e=>(this.emit("metrics",e),Promise.resolve())},this.initBirdgeEvent(),this.on("error",(e=>{this.config.disableReportLogger||this.client.dispatchParentEvent("error",{name:e.name,message:e.message,origin:e.origin}).catch((()=>{}))})),this.on("log",(e=>{this.config.disableReportLogger||this.client.dispatchParentEvent("log",e).catch((()=>{}))})),this.on("debug",(e=>{this.config.debug&&this.emit("log",{...e,name:`Debug:${e.name}`})})),this.client.on("error",(e=>{e.name=`Socket:${e.name}`,this.emit("error",e)})),this.storage.on("error",(e=>{this.emit("error",function(e,t){return t.name="".concat("WebStorage",":").concat(t.name),t}(0,e))})),this.storage.on("log",(e=>{this.emit("log",e)})),this.client.on("log",(e=>{this.emit("log",e)})),this.client.on("metrics",(e=>{this.emit("metrics",e)})),this.client.on("debug",(e=>{this.emit("debug",e)})),this.client.start().catch((e=>{this.emit("error",new r("StartSocketClientError",e.message))}))}}const we=(()=>{const e=[46,98,121,116,101,100,97,110,99,101,46,110,101,116].map((e=>String.fromCharCode(e))).join(""),t=[46,98,121,116,101,100,46,111,114,103].map((e=>String.fromCharCode(e))).join(""),n=new pe({protocol:"SERCURE",allowOrigin:[".douyin.com",e,t,".douyinstatic.com",".qishui.com"],storage:{dbStorage:{dbName:"secure-store",storeName:"cryptvalues"}},startStorageCheckerCallBack:()=>{(e=>{new Promise((t=>{e.config.enableHotPatch?t():e.on("config",(()=>{e.config.enableHotPatch&&t()}))})).then((()=>G(2e3))).then((()=>{return e.emit("debug",{name:"startLoadPatchJS"}),(t=`${x}@byted/x-storage-patch/v4/dist/${M()?"latest":"page"}/index.umd.production.js`,void 0===t&&(t=""),new Promise(((e,n)=>{const o=document.createElement("script");o.async=!0,o.src=t,o.crossOrigin="anonymous",o.onload=()=>{e()},o.onerror=()=>{n()},document.head.appendChild(o)}))).catch((t=>{e.emit("debug",{name:"PATCH_SCRIPT_ERROR",content:t.message})}));var t})).catch((()=>{}))})(n),(e=>{if(!F())return;const t=t=>{e.client.callParentBridge("logger","metrics",[t]).catch((()=>{}))},n=function(t){return void 0===t&&(t=[]),t[0]&&t[0].value&&t[1]&&t[1].value&&t[2]&&t[2].value?e.client.callParentBridge("sign","verify",[t.map((e=>e.value))]).then((e=>{if(!e)throw new Error("verifyError")})):Promise.reject()},o=(e,t)=>e[0].value&&e[1].value&&e[2].value&&e[0].value===t[0].value&&e[1].value===t[1].value&&e[2].value===t[2].value,i=i=>{const r=J();return n(i).then((()=>e.client.callParentBridge("storageX","getItemByKeys",[oe]).then((s=>{const a=e=>{try{const n=J();t({name:"SyncDataToLocalStatus",metrics:{startTime:r,endTime:n,loadTime:n-r},categories:{status:e,result:s.map((e=>e.from)).join("@"),values:s.map((e=>e.value?"1":"0")).join("@")}})}catch(e){}},c=o(i,s);if(c)try{const t=s.filter((e=>e.value)).map((e=>e.from)).join("-");"0-0-0"!==t&&(l="ThisDataFromDB",h=JSON.stringify({localDataFromType:t}),void 0===l&&(l="SyncStorage"),e.emit("log",{name:l,content:h}))}catch(e){}var l,h;if(!c)return n(i).then((()=>e.client.callParentBridge("storageX","setItemByKeys",[oe.map(((e,t)=>[e,i[t].value]))]).then((()=>{a("1")})).catch((e=>{throw a("0"),e})))).catch((e=>{throw a("-1"),e}))}))))},r=n=>{const i=J();return e.storage.localDB.getItemByKeys(oe).then((r=>{const s=e=>{try{const n=J();t({name:"SyncDataToLocalDBStatus",metrics:{startTime:i,endTime:n,loadTime:n-i},categories:{status:e,values:r.map((e=>e?"1":"0")).join("@")}})}catch(e){}};if(!o(r.map((e=>({value:e}))),n))return e.storage.localDB.setItemByKeys(oe.map(((e,t)=>[e,n[t].value]))).then((()=>{s("1")})).catch((e=>{throw s("0"),e}))}))},s=()=>{let s=-1;return e.getItemByKeys(oe).then((e=>n(e).then((()=>Promise.all([i(e),r(e)]).catch((()=>{}))),(e=>{throw s=0,e})))).catch((()=>e.client.callParentBridge("storageX","getItemByKeys",[oe]).then((i=>n(i).then((()=>(i=>{const r=J();return n(i).then((()=>e.getItemByKeys(oe).then((s=>{const a=e=>{try{const n=J();t({name:"SyncDataToOriginStatus",metrics:{startTime:r,endTime:n,loadTime:n-r},categories:{status:e,result:s.map((e=>e.from)).join("@"),values:s.map((e=>e.value?"1":"0")).join("@")}})}catch(e){}};if(!o(i,s))return n(i).then((()=>e.setItemByKeys(oe.map(((e,t)=>[e,i[t].value]))).then((()=>{a("1")})).catch((e=>{throw a("0"),e})))).catch((e=>{throw a("-1"),e}))}))))})(i).catch((()=>{}))),(e=>{throw 0===s&&t({name:"SyncStorageOriginAndLocalAllFail"}),e}))))))};H().then((()=>G(0))).then(s).catch((()=>{})),setInterval((()=>{"hidden"!==document.visibilityState&&s().catch((()=>{}))}),18e4)})(n)}});return n.listen(),n})();return t}()}));</script></head><body></body></html>